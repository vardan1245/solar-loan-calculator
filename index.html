<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Loan Calculator</title>
    <link rel="icon" type="image/x-icon" href="/public/tIAMAT white blue-06.ico">
    <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
    <script>
        // Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tiamat-blue': '#0066CC',
                        'tiamat-light-blue': '#4A90E2',
                        'tiamat-dark-blue': '#004499',
                    }
                }
            }
        }
        
        // Configuration is now loaded from config.js and database
        let CONFIG = {
            // Configuration loaded from external sources
        };

        try {
            // Try to load config.js
            const script = document.createElement('script');
            script.src = '/public/config.js';
            script.onload = function() {
                // If config.js loads successfully, it will override the default CONFIG
            };
            script.onerror = function() {
                // config.js should always be available since it's included in git
            };
            document.head.appendChild(script);
        } catch (e) {
            // Silent fallback
        }

        function showConfigSetupMessage() {
            // No longer needed since config.js is included in git
            // This function is kept for backward compatibility but does nothing
        }
    </script>
    <style>
        .spoiler {
            cursor: pointer;
            user-select: none;
            background: linear-gradient(45deg, #333 25%, transparent 25%), 
                        linear-gradient(-45deg, #333 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #333 75%), 
                        linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 4px 4px;
            background-position: 0 0, 0 2px, 2px -2px, -2px 0px;
            color: transparent;
            transition: all 0.3s ease;
        }
        
        .spoiler:hover {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .spoiler-revealed {
            cursor: pointer;
            background: #f3f4f6;
            color: inherit;
            transition: all 0.3s ease;
        }
        
        .spoiler-revealed:hover {
            background: #e5e7eb;
        }
        

    </style>

</head>
<body class="bg-gray-50">
    <!-- Authentication Container (shown when not logged in) -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center p-4" style="display: none;">
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-tiamat-blue rounded-full mb-4 shadow-lg">
                <img src="/public/tIAMAT white blue-06.ico" alt="Tiamat Logo" class="w-12 h-12">
            </div>
            <h1 class="text-3xl font-bold text-tiamat-blue mb-2">Authentication Required</h1>
            <p class="text-gray-600 mb-4">Please log in to access the Solar Loan Calculator</p>
            <a href="/login" class="inline-block bg-tiamat-blue text-white px-6 py-3 rounded-lg font-semibold hover:bg-tiamat-dark-blue transition-colors">
                Go to Login
            </a>
        </div>
    </div>

    <!-- Main Application Container (shown when logged in) -->
    <div id="appContainer" class="container mx-auto p-6 space-y-6" style="display: none;">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <img src="/public/tIAMAT white blue-06.ico" alt="Tiamat Logo" class="h-8 w-8">
                <h1 class="text-3xl font-bold text-tiamat-blue" data-en="Solar Loan Calculator" data-hy="Արևային կայանի վարկի հաշվիչ">Solar Loan Calculator</h1>
            </div>
            
            <!-- User Info and Controls -->
            <div class="flex items-center gap-4">
                <!-- User Info Display -->
                <div id="userInfo" class="text-sm text-gray-700">
                    <!-- Will be populated by auth.js -->
            </div>
            
            <!-- Language Switcher -->
            <div class="flex items-center gap-2">
                <button onclick="switchLanguage('en')" id="langEn" class="px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white">EN</button>
                <button onclick="switchLanguage('hy')" id="langHy" class="px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300" style="display: inline-block !important; visibility: visible !important;">ՀԱՅ</button>
                </div>
                

            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-10 gap-6">
            <!-- Input Form -->
            <div class="lg:col-span-7 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4" data-en="System Configuration" data-hy="Համակարգի կարգավորում">System Configuration</h2>
                

                
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="System Power (kW)" data-hy="Համակարգի հզորություն (կՎտ)">System Power (kW)</label>
                        <input type="number" id="systemPower" data-en-placeholder="Enter system power" data-hy-placeholder="Մուտքագրեք համակարգի հզորությունը" placeholder="Enter system power" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Installation Type" data-hy="Տեղադրման տեսակը">Installation Type</label>
                        <select id="installationType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <option value="onRoof" data-en="On Roof" data-hy="Տանիքի վրա (լանջային)">On Roof</option>
                            <option value="metalConstructionOnRoof" data-en="Metal Construction on Roof" data-hy="Մետաղական կոնստրուկցիա տանիքի վրա">Metal Construction on Roof</option>
                            <option value="aluminiumConstructionOnRoof" data-en="Aluminium Construction on Roof" data-hy="Ալյումինե կոնստրուկցիա տանիքի վրա">Aluminium Construction on Roof</option>
                            <option value="systemOnGround" data-en="System on Ground" data-hy="Համակարգ գետնի վրա">System on Ground</option>
                        </select>
                    </div>



                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Warranty Years" data-hy="Երաշխիքային տարիներ">Warranty Years</label>
                            <select id="warrantyYears" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                                <option value="2" data-en="2 Years" data-hy="2 Տարի">2 Years</option>
                                <option value="3" data-en="3 Years" data-hy="3 Տարի">3 Years</option>
                                <option value="6" data-en="6 Years" data-hy="6 Տարի">6 Years</option>
                                <option value="12" data-en="12 Years" data-hy="12 Տարի" selected>12 Years</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Sales Stage" data-hy="Վաճառքի փուլ">Sales Stage</label>
                            <select id="salesStage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                                <option value="0" data-en="-------" data-hy="-------">-------</option>
                                <option value="1" data-en="Stage 1: 5,000 AMD/kW discount" data-hy="Փուլ 1: 5,000 AMD/կՎտ զեղչ">Stage 1: 5,000 AMD/kW discount</option>
                                <option value="2" data-en="Stage 2: 10,000 AMD/kW discount" data-hy="Փուլ 2: 10,000 AMD/կՎտ զեղչ">Stage 2: 10,000 AMD/kW discount</option>
                                <option value="3" data-en="Stage 3: 15,000 AMD/kW discount" data-hy="Փուլ 3: 15,000 AMD/կՎտ զեղչ">Stage 3: 15,000 AMD/kW discount</option>
                            </select>
                        </div>
                    </div>



                <!-- Inverter Type and Phase Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Inverter Type" data-hy="Փոխակերպիչի տեսակը">Inverter Type</label>
                        <select id="inverterType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <option value="on_grid" data-en="On Grid" data-hy="Ցանցային" selected>On Grid</option>
                            <option value="off_grid" data-en="Off Grid" data-hy="Ավտոնոմ">Off Grid</option>
                            <option value="hybrid" data-en="Hybrid" data-hy="Հիբրիդ">Hybrid</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Phase" data-hy="Ֆազ">Phase</label>
                        <select id="phaseFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <option value="" data-en="All Phases" data-hy="Բոլոր ֆազերը" selected>All Phases</option>
                            <option value="one phase" data-en="1 Phase" data-hy="1 Ֆազ">1 Phase</option>
                            <option value="three phase" data-en="3 Phase" data-hy="3 Ֆազ">3 Phase</option>
                        </select>
                    </div>
                </div>

                <div id="inverterSelectionContainer" class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700" data-en="Inverter Selection:" data-hy="Փոխակերպիչի ընտրություն:">Inverter Selection:</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500" data-en="Auto" data-hy="Ավտո">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="manualInverterToggle" class="sr-only peer" onchange="toggleInverterSelection()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-tiamat-blue/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tiamat-blue"></div>
                            </label>
                            <span class="text-xs text-gray-500" data-en="Manual" data-hy="Ձեռքով">Manual</span>
                        </div>
                    </div>
                    
                    <!-- Auto Selection (Default) -->
                    <div id="autoInverterSelection">
                        <select id="inverterSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Manual Selection (Hidden by default) -->
                    <div id="manualInverterSelection" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="manualBrand" class="block text-xs font-medium text-gray-600 mb-1" data-en="Brand:" data-hy="Բրենդ:">Brand:</label>
                                <select id="manualBrand" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                                    <option value="" data-en="Select brand" data-hy="Ընտրեք բրենդը">Select brand</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualPower" class="block text-xs font-medium text-gray-600 mb-1" data-en="Power (kW):" data-hy="Հզորություն (կՎտ):">Power (kW):</label>
                                <select id="manualPower" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                                    <option value="" data-en="Select power" data-hy="Ընտրեք հզորությունը">Select power</option>
                                </select>
                            </div>
                            </div>

                    </div>
                </div>
                
                <!-- Battery Selection (Only visible for Hybrid systems) -->
                <div id="batterySelectionContainer" class="mb-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700" data-en="Battery Selection:" data-hy="Մարտկոցի ընտրություն:">Battery Selection:</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500" data-en="Auto" data-hy="Ավտո">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="manualBatteryToggle" class="sr-only peer" onchange="toggleBatterySelection()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-tiamat-blue/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tiamat-blue"></div>
                            </label>
                            <span class="text-xs text-gray-500" data-en="Manual" data-hy="Ձեռքով">Manual</span>
                        </div>
                    </div>
                    
                    <!-- Auto Selection (Default) -->
                    <div id="autoBatterySelection">
                        <select id="batterySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-tiamat-blue">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Manual Selection (Hidden by default) -->
                    <div id="manualBatterySelection" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label for="manualBatteryBrand" class="block text-xs font-medium text-gray-600 mb-1" data-en="Brand:" data-hy="Բրենդ:">Brand:</label>
                                <select id="manualBatteryBrand" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                                    <option value="" data-en="Select brand" data-hy="Ընտրեք բրենդը">Select brand</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualBatteryCapacity" class="block text-xs font-medium text-gray-600 mb-1" data-en="Capacity (kWh):" data-hy="Հզորություն (կՎտժ):">Capacity (kWh):</label>
                                <select id="manualBatteryCapacity" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                                    <option value="" data-en="Select capacity" data-hy="Ընտրեք հզորությունը">Select capacity</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualBatteryChemistry" class="block text-xs font-medium text-gray-600 mb-1" data-en="Chemistry:" data-hy="Քիմիան">Chemistry:</label>
                                <select id="manualBatteryChemistry" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-tiamat-blue">
                                    <option value="" data-en="Select chemistry" data-hy="Ընտրեք քիմիան">Select chemistry</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel Selection -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700" data-en="Panel Selection:" data-hy="Վահանակների ընտրություն:">Panel Selection:</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500" data-en="Auto" data-hy="Ավտո">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="manualPanelToggle" class="sr-only peer" onchange="togglePanelSelection()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-tiamat-blue/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tiamat-blue"></div>
                            </label>
                            <span class="text-xs text-gray-500" data-en="Manual" data-hy="Ձեռքով">Manual</span>
                        </div>
                    </div>
                    
                    <!-- Auto Selection (Default) -->
                    <div id="autoPanelSelection">
                        <!-- Panel Suggestions Display -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Panel Suggestions" data-hy="Վահանակների առաջարկներ">Panel Suggestions</label>
                            <div id="panelSuggestions" class="space-y-2 border border-gray-200 rounded-md p-3 bg-gray-50">
                                <div class="text-sm text-gray-500 text-center py-4" data-en="Enter System Power above to see panel suggestions" data-hy="Մուտքագրեք համակարգի հզորությունը վերևում՝ վահանակների առաջարկները տեսնելու համար">Enter System Power above to see panel suggestions</div>
                            </div>
                        </div>
                        

                    </div>
                    
                    <!-- Manual Selection (Hidden by default) -->
                    <div id="manualPanelSelection" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label for="manualPanelBrand" class="block text-xs font-medium text-gray-600 mb-1" data-en="Brand:" data-hy="Բրենդ:">Brand:</label>
                                <select id="manualPanelBrand" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualPanelInfo()">
                                    <option value="" data-en="Select brand" data-hy="Ընտրեք բրենդը">Select brand</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualPanelWattage" class="block text-xs font-medium text-gray-600 mb-1" data-en="Wattage:" data-hy="Հզորություն (Վտ):">Wattage:</label>
                                <select id="manualPanelWattage" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-tiamat-blue" onchange="updateManualPanelInfo()">
                                    <option value="" data-en="Select wattage" data-hy="Ընտրեք հզորությունը">Select wattage</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualPanelQuantity" class="block text-xs font-medium text-gray-600 mb-1" data-en="Quantity:" data-hy="Քանակ:">Quantity:</label>
                                <input type="number" id="manualPanelQuantity" min="1" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualPanelInfo()" placeholder="1">
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700" data-en="Selected Panel:" data-hy="Ընտրված վահանակը:">Selected Panel:</span>
                                <span id="manualPanelInfo" class="text-sm text-gray-500" data-en="None selected" data-hy="Ոչինչ ընտրված չէ">None selected</span>
                            </div>
                            <div class="mt-2 text-xs text-gray-600" id="panelSystemPowerInfo">
                                <!-- Will show calculated system power when panels are selected -->
                            </div>
                        </div>
                    </div>
                </div>
                    
                    <!-- Current Profit per kW Display (Admin Only) - Will be created dynamically -->
                    <div id="profitPerKwDisplayContainer"></div>

                    <button id="calculateBtn" onclick="calculateLoan()" 
                            class="w-full bg-tiamat-blue hover:bg-tiamat-dark-blue text-white font-semibold py-2 px-4 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            data-en="Calculate Loan Options" data-hy="Հաշվարկել վարկի տարբերակները"
                            disabled>
                        Loading...
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4" data-en="Calculation Results" data-hy="Հաշվարկի արդյունքները">Calculation Results</h2>
                
                <div id="results" class="space-y-4">
                    <div class="text-center text-gray-500" data-en="Enter system parameters and click 'Calculate Loan Options' to see results" data-hy="Մուտքագրեք համակարգի պարամետրերը և սեղմեք 'Հաշվարկել վարկի տարբերակները' արդյունքները տեսնելու համար">
                        Enter system parameters and click "Calculate Loan Options" to see results
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanelMain" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-blue-600">🔐 Admin Panel</h2>
                <button onclick="logoutAdmin()" class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400">Logout</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Configuration Details -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-lg text-blue-600">Configuration Details</h4>
                    <details class="space-y-3">
                        <summary class="cursor-pointer font-medium text-blue-600 hover:text-blue-800 transition-colors">Click to reveal sensitive information</summary>
                        <div class="mt-3 space-y-2 text-sm">
                            <p><strong>Authentication:</strong> <span class="text-green-600">Supabase Auth</span></p>
                            <p><strong>Database Connection:</strong> <span class="text-green-600">Connected to Supabase</span></p>
                            <p><strong>API Endpoints:</strong> <span class="text-blue-600">All endpoints working</span></p>
                            <p><strong>Tables:</strong> <span class="text-green-600">system_cost_settings, inverter_options, panel_options, bank_configurations</span></p>
                        </div>
                    </details>
                </div>
                
                <!-- Current Settings -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-lg text-blue-600">Current Settings</h4>
                    <div class="space-y-2 text-sm">
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Common Sales Team %:</strong> <span class="text-green-600 font-semibold" id="adminSalesTeamPct">6% (Common for all installation types)</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Common Unanticipated Expenses %:</strong> <span class="text-yellow-600 font-semibold">2% (Common for all installation types)</span>
                        </div>
                        <div class="p-2 bg-white rounded text-xs text-gray-600">
                            <em>Note: Unanticipated expenses now use a single common percentage (2%) that applies to all installation types. Legacy installation-specific records have been deprecated.</em>
                        </div>
                        <div class="p-2 bg-white rounded text-xs text-gray-500 bg-gray-50">
                            <strong>Database Status:</strong> 1 active record (ID: 635), all deprecated records completely removed
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-lg text-blue-600">System Status</h4>
                    <div class="space-y-2 text-sm">
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Database:</strong> <span class="text-green-600 font-semibold">Connected</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">API Server:</strong> <span class="text-green-600 font-semibold">Running</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Frontend:</strong> <span class="text-green-600 font-semibold">Live Data</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Last Updated:</strong> <span class="text-blue-600 font-semibold" id="adminLastUpdated"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Options Table -->
        <div id="loanTable" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Available Loan Options</h2>
            
            <!-- Filters and Sorting -->
            <div class="mb-4 flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700" data-en="Filter by Bank:" data-hy="Զտել ըստ բանկի:">Filter by Bank:</label>
                    <select id="bankFilter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="" data-en="All Banks" data-hy="Բոլոր բանկերը">All Banks</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700" data-en="Filter by Period:" data-hy="Զտել ըստ ժամկետի:">Filter by Period:</label>
                    <select id="periodFilter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="" data-en="All Periods" data-hy="Ամբողջը">All Periods</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700" data-en="Sort by:" data-hy="Դասավորել ըստ:">Sort by:</label>
                    <select id="sortBy" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="monthlyPayment" data-en="Monthly Payment (Low to High)" data-hy="Ամսական վճար (ցածրից բարձր)">Monthly Payment (Low to High)</option>
                        <option value="monthlyPaymentDesc" data-en="Monthly Payment (High to Low)" data-hy="Ամսական վճար (բարձրից ցածր)">Monthly Payment (High to Low)</option>
                        <option value="loanAmount" data-en="Loan Amount (Low to High)" data-hy="Վարկի գումար (ցածրից բարձր)">Loan Amount (Low to High)</option>
                        <option value="loanAmountDesc" data-en="Loan Amount (High to Low)" data-hy="Վարկի գումար (բարձրից ցածր)">Loan Amount (High to Low)</option>
                        <option value="totalAmount" data-en="Total Amount (Low to High)" data-hy="Ընդհանուր գումար (ցածրից բարձր)">Total Amount (Low to High)</option>
                        <option value="totalAmountDesc" data-en="Total Amount (High to Low)" data-hy="Ընդհանուր գումար (բարձրից ցածր)">Total Amount (High to Low)</option>
                        <option value="interestRate" data-en="Interest Rate (Low to High)" data-hy="Տոկոսադրույք (ցածրից բարձր)">Interest Rate (Low to High)</option>
                        <option value="interestRateDesc" data-en="Interest Rate (High to Low)" data-hy="Տոկոսադրույք (բարձրից ցածր)">Interest Rate (High to Low)</option>

                        <option value="loanPeriod" data-en="Loan Period (Low to High)" data-hy="Վարկի ժամկետ (ցածրից բարձր)">Loan Period (Low to High)</option>
                        <option value="loanPeriodDesc" data-en="Loan Period (High to Low)" data-hy="Վարկի ժամկետ (բարձրից ցածր)">Loan Period (High to Low)</option>
                    </select>
                </div>
                
                <button onclick="clearFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-sm transition-colors"
                        data-en="Clear Filters" data-hy="Մաքրել զտիչները">
                    Clear Filters
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border p-3 text-left font-medium cursor-pointer hover:bg-gray-100" onclick="sortTable('bankName')">
                                <span data-en="Bank" data-hy="Բանկ">Bank</span> <span id="bankSortIcon" class="ml-1">↕</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-32 cursor-pointer hover:bg-gray-100" onclick="sortTable('loanPeriod')">
                                <span data-en="Loan Period" data-hy="Վարկի ժամկետ">Loan Period</span> <span id="periodSortIcon" class="ml-1">↕</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-24 cursor-pointer hover:bg-gray-100" onclick="sortTable('interestRate')">
                                <span data-en="Interest Rate" data-hy="Տոկոսադրույք">Interest Rate</span> <span id="rateSortIcon" class="ml-1">↕</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-24 cursor-pointer hover:bg-gray-100 admin-only" onclick="sortTable('commission')" style="display: none;">
                                <span data-en="Commission" data-hy="Կոմիսիա">Commission</span> <span id="commissionSortIcon" class="ml-1">↕</span>
                            </th>

                            <th class="border p-3 text-center font-medium w-40 cursor-pointer hover:bg-gray-100" onclick="sortTable('loanAmount')">
                                <span data-en="Loan Amount" data-hy="Վարկի գումար">Loan Amount</span> <span id="amountSortIcon" class="ml-1">↕</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-36 cursor-pointer hover:bg-gray-100" onclick="sortTable('monthlyPayment')">
                                <span data-en="Monthly Payment" data-hy="Ամսական վճար">Monthly Payment</span> <span id="paymentSortIcon" class="ml-1">↕</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-40 cursor-pointer hover:bg-gray-100" onclick="sortTable('totalInterest')">
                                <span data-en="Total Interest" data-hy="Ընդհանուր տոկոս">Total Interest</span> <span id="interestSortIcon" class="ml-1">↕</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-44 cursor-pointer hover:bg-gray-100" onclick="sortTable('totalAmount')">
                                <span data-en="Total Amount" data-hy="Ընդհանուր գումար">Total Amount</span> <span id="totalSortIcon" class="ml-1">↕</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="loanTableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-600">
                <span id="resultCount" data-en="Showing all results" data-hy="Ցուցադրվում են բոլոր արդյունքները">Showing all results</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables for database values
        let dbBasePrices = {};
        let dbProfitMargins = {};
        let dbSalesCommissions = {};
        let dbUnanticipatedExpenses = {};
        let dbBanks = [];
        let dbInverters = [];
        let bankConfigurations = []; // Bank configurations for loan calculations
        let inverters = []; // Inverter list for system calculations
        let panels = []; // Panel list for system calculations
        let batteries = []; // Battery list for hybrid systems
        let isDataLoaded = false; // Track if database data is fully loaded
        let selectedPanelOption = null; // Store the selected panel option from suggestions
        
        // Function to fetch system cost settings from database
        async function fetchSystemCostSettings() {
            try {
                // Initialize default values
                let commonExpensesPct = 2; // Default fallback for unanticipated expenses
                let commonSalesTeamPct = 6; // Default fallback for sales team commission
                
                const response = await fetch('/api/system-cost-settings');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {

                    
                    // Initialize dbProfitMargins as an empty object
                    dbProfitMargins = {};
                    
                    // Extract installation costs
                    if (result.data.installationCosts && result.data.installationCosts.data) {
                        const costs = result.data.installationCosts.data;
                        
                        // Map database keys to frontend keys - no hardcoded fallbacks
                        dbBasePrices = {
                            onRoof: costs.cost_per_kw_on_roof?.value,
                            metalConstructionOnRoof: costs.cost_per_kw_metal_construction_on_roof?.value,
                            systemOnGround: costs.cost_per_kw_system_on_ground?.value,
                            aluminiumConstructionOnRoof: costs.cost_per_kw_aluminium_construction_on_roof?.value
                        };
                        
                        // Set installation costs in dbProfitMargins for the panel suggestions
                        dbProfitMargins.installationCosts = {
                            data: costs
                        };
                    }
                    
                    // Extract profit margins - now warranty-based instead of installation-type-based
                    if (result.data.profitMargins && result.data.profitMargins.data) {
                        const profits = result.data.profitMargins.data;
                        
                        // Load warranty-based profit margins - no hardcoded fallbacks
                        dbProfitMargins.profitMargins = {
                            data: profits
                        };
                    }
                    
                    // Extract sales commissions - now using common percentage for all installation types
                    // Look for sales_team_pct record in any category
                    if (result.data.salesCommissions && result.data.salesCommissions.data) {
                        const commissions = result.data.salesCommissions.data;
                        
                        if (commissions.sales_team_pct && commissions.sales_team_pct.value > 0) {
                            commonSalesTeamPct = commissions.sales_team_pct.value;

                        }
                    }
                    
                    // Also check unanticipatedExpenses section in case it's categorized there
                    if (result.data.unanticipatedExpenses && result.data.unanticipatedExpenses.data) {
                        const expenses = result.data.unanticipatedExpenses.data;
                        
                        if (expenses.sales_team_pct && expenses.sales_team_pct.value > 0) {
                            commonSalesTeamPct = expenses.sales_team_pct.value;

                        }
                    }
                    
                    // Apply common percentage to all installation types
                    dbSalesCommissions = {
                        onRoof: commonSalesTeamPct / 100,
                        metalConstructionOnRoof: commonSalesTeamPct / 100,
                        systemOnGround: commonSalesTeamPct / 100,
                        aluminiumConstructionOnRoof: commonSalesTeamPct / 100,
                        // Also set the structured data for panel suggestions
                        salesCommissions: {
                            data: {
                                sales_team_pct: {
                                    value: commonSalesTeamPct
                                }
                            }
                        }
                    };
                    

                    
                    // Update admin panel with actual database values
                    const adminSalesTeamPct = document.getElementById('adminSalesTeamPct');
                    if (adminSalesTeamPct) {
                        adminSalesTeamPct.textContent = commonSalesTeamPct + '% (Common for all installation types)';
                    }
                    
                    // Extract unanticipated expenses - now single common value for all installation types
                    if (result.data.unanticipatedExpenses && result.data.unanticipatedExpenses.data) {
                        const expenses = result.data.unanticipatedExpenses.data;
                        
                        // Look for the active common record - now using the new key name
                        if (expenses.unanticipated_expenses_pct && expenses.unanticipated_expenses_pct.value > 0) {
                            commonExpensesPct = expenses.unanticipated_expenses_pct.value;

                        } else {
                            // Fallback: scan all records for active ones
                            for (const [key, record] of Object.entries(expenses)) {
                                if (record.description && !record.description.includes('DEPRECATED') && record.value > 0) {
                                    commonExpensesPct = record.value;

                                    break;
                                }
                            }
                        }
                        
                        // Apply common percentage to all installation types
                        dbUnanticipatedExpenses = {
                            onRoof: commonExpensesPct / 100,
                            metalConstructionOnRoof: commonExpensesPct / 100,
                            systemOnGround: commonExpensesPct / 100,
                            aluminiumConstructionOnRoof: commonExpensesPct / 100,
                            // Also set the structured data for panel suggestions
                            unanticipatedExpenses: {
                                data: {
                                    unanticipated_expenses_pct: {
                                        value: commonExpensesPct
                                    }
                                }
                            }
                        };
                        
                                                                                                                                                                                                
                    }
                    

                    
                            // Load banks, inverters, panels, and batteries from their respective endpoints
        const [banksResult, invertersResult, panelsResult, batteriesResult] = await Promise.all([
                        fetch('/api/banks')
                            .then(response => response.json())
                            .catch(error => ({ success: false, data: null })),
                        
                        fetch('/api/inverters')
                            .then(response => response.json())
                            .catch(error => ({ success: false, data: null })),
                        
                        fetch('/api/panels')
                            .then(response => response.json())
                            .catch(error => ({ success: false, data: null })),
                        
                        fetch('/api/batteries')
                            .then(response => response.json())
                            .catch(error => ({ success: false, data: null }))
                    ]);
                    
                    // Debug: Log API responses
                    console.log('🔍 API Responses:', {
                        banks: banksResult,
                        inverters: invertersResult,
                        panels: panelsResult,
                        batteries: batteriesResult
                    });
                    
                    // Process results
                    if (banksResult.success && banksResult.data && banksResult.data.banks) {
                        dbBanks = banksResult.data.banks;
                        bankConfigurations = banksResult.data.banks;
                        console.log('✅ Banks loaded:', banksResult.data.banks.length);
                    } else {
                        console.log('❌ Banks failed to load:', banksResult);
                    }
                    
                    if (invertersResult.success && invertersResult.data && invertersResult.data.inverters) {
                        dbInverters = invertersResult.data.inverters;
                        inverters = invertersResult.data.inverters;
                        console.log('✅ Inverters loaded:', invertersResult.data.inverters.length);
                    } else {
                        console.log('❌ Inverters failed to load:', invertersResult);
                    }
                    
                    if (panelsResult.success && panelsResult.data && panelsResult.data.panels) {
                        panels = panelsResult.data.panels;
                        console.log('✅ Panels loaded:', panelsResult.data.panels.length);
                    } else {
                        console.log('❌ Panels failed to load:', panelsResult);
                    }
                    
                            if (batteriesResult.success && batteriesResult.data && batteriesResult.data.batteries) {
            batteries = batteriesResult.data.batteries;
            console.log('✅ Batteries loaded:', batteriesResult.data.batteries.length);
        } else {
            console.log('❌ Batteries failed to load:', batteriesResult);
        }
                    
                    // Debug: Log the final data structure
                    
                    
                    // Mark data as loaded
                    isDataLoaded = true;
                    console.log('✅ Data loaded successfully:', {
                        inverters: inverters?.length || 0,
                        panels: panels?.length || 0,
                        batteries: batteries?.length || 0,
                        isDataLoaded: isDataLoaded
                    });
                    
                    // Enable calculate button
                    const calculateBtn = document.getElementById('calculateBtn');
                    if (calculateBtn) {
                        const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                        calculateBtn.disabled = false;
                        calculateBtn.textContent = currentLanguage === 'en' ? 'Calculate Loan Options' : 'Հաշվարկել վարկի տարբերակները';
                    }
                    
                    // Pre-populate manual selection dropdowns for immediate use
                    populateManualBrands();
                    populateManualPowers();
                    
                    // Pre-populate manual panel selection dropdowns
                    populateManualPanelBrands();
                    populateManualPanelWattages();
                    
                    // Update the main inverter dropdown with new data
                    populateInverterDropdown();
                    
                    // Also populate manual inverter options with default "on_grid" selection
                    populateManualBrands();
                    populateManualPowers();
                    
                    // Now that ALL data is loaded, populate panel suggestions
                    if (panels && panels.length > 0) {
                        // Populate panel suggestions immediately
                        populatePanelDropdown();
                        
                        // Also retry after a short delay to ensure everything is loaded
                        setTimeout(() => {
                            populatePanelDropdown();
                        }, 100);
                        
                        // Also retry after a longer delay in case some data loads later
                        setTimeout(() => {
                            populatePanelDropdown();
                        }, 1000);
                    }
                    
                    // Force a recalculation to ensure everything is updated
                    setTimeout(() => {
                        if (typeof calculatePanelRequirements === 'function') {
                            calculatePanelRequirements();
                        }
                    }, 200);
                    

                    

                }
            } catch (error) {
                // Silent error handling - show user-friendly message instead
            }
        }
        
        function calculateLoanPayment(principal, annualRate, months) {
            const monthlyRate = annualRate / 12;
            if (monthlyRate === 0) return principal / months;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        }

        // Base prices per kW (without inverter) - will be loaded from database
        

        function calculateLoan() {
            // Get current language at the beginning of the function
            const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
            
            // Check if database data is loaded
            if (!isDataLoaded) {
                const message = currentLanguage === 'en' 
                    ? 'Please wait, database data is still loading...'
                    : 'Խնդրում ենք սպասել, տվյալների բազայի տվյալները դեռ բեռնվում են...';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Check if bank configurations are loaded and have data
            if (!bankConfigurations || bankConfigurations.length === 0) {
                const message = currentLanguage === 'en' 
                    ? 'Bank configurations not loaded. Please refresh the page and try again.'
                    : 'Բանկի կոնֆիգուրացիաները բեռնված չեն: Խնդրում ենք թարմացնել էջը և կրկին փորձել:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                <span class="text-red-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Get input values
            const systemPower = parseFloat(document.getElementById('systemPower').value);
            const installationType = document.getElementById('installationType').value;
            const warrantyYears = parseInt(document.getElementById('warrantyYears').value) || 12;

            if (!systemPower) {
                alert('Please enter system power');
                return;
            }

            // Check if manual inverter mode is enabled and validate required fields
            let isManualMode = document.getElementById('manualInverterToggle').checked;
            if (isManualMode) {
                const selectedBrand = document.getElementById('manualBrand').value;
                const selectedPower = document.getElementById('manualPower').value;
                
                if (!selectedBrand || !selectedPower) {
                    const message = currentLanguage === 'en' 
                                            ? 'In manual inverter mode, Brand and Power (kW) are mandatory. Please select both fields before calculating.'
                    : 'Ձեռքով փոխակերպիչի ռեժիմում Բրենդը և Հզորությունը (կՎտ) պարտադիր են: Խնդրում ենք ընտրել երկու դաշտերը հաշվարկից առաջ:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
            }

            // Check if manual panel mode is enabled and validate required fields
            let isManualPanelMode = document.getElementById('manualPanelToggle').checked;
            if (isManualPanelMode) {
                const selectedPanelBrand = document.getElementById('manualPanelBrand').value;
                const selectedPanelWattage = document.getElementById('manualPanelWattage').value;
                const selectedPanelQuantity = parseInt(document.getElementById('manualPanelQuantity').value) || 0;
                
                if (!selectedPanelBrand || !selectedPanelWattage || selectedPanelQuantity <= 0) {
                    const message = currentLanguage === 'en' 
                        ? 'In manual panel mode, Brand, Wattage, and Quantity are mandatory. Please select all fields before calculating.'
                        : 'Ձեռքով պանելի ռեժիմում Բրենդը, Հզորությունը և Քանակը պարտադիր են: Խնդրում ենք ընտրել բոլոր դաշտերը հաշվարկից առաջ:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
            }

            // Initialize selectedPanelInfo variable early to prevent reference errors
            let selectedPanelInfo = selectedPanelOption ? 
                (currentLanguage === 'en'
                    ? `${selectedPanelOption.quantity} × ${selectedPanelOption.brand} ${selectedPanelOption.wattage}W = ${selectedPanelOption.actualPower} kW`
                    : `${selectedPanelOption.quantity} × ${selectedPanelOption.brand} ${selectedPanelOption.wattage}Վտ = ${selectedPanelOption.actualPower} կՎտ`)
                : 'Auto-selected';

            // Get base price per kW (without inverter) - prefer database values
            let basePricePerKw = dbBasePrices[installationType];
            
            if (!basePricePerKw) {
                const message = currentLanguage === 'en' 
                    ? `Base price not found for installation type: ${installationType}. Please check database configuration.`
                    : `${installationType} տեղադրման տիպի համար բազային գինը չի գտնվել: Խնդրում ենք ստուգել տվյալների բազայի կարգավորումները:`;
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Calculate total base price for the system
            const basePrice = Math.ceil(systemPower * basePricePerKw);
            
            // Get profit per kW based on warranty years (profit margins are global, not per installation type)
            const profitKey = `profit_per_kw_${warrantyYears}Y`;
            
            // Check if profit margins data is loaded
            if (!dbProfitMargins.profitMargins?.data || Object.keys(dbProfitMargins.profitMargins.data).length === 0) {
                const message = currentLanguage === 'en' 
                    ? 'System data is still loading. Please wait a moment and try again.'
                    : 'Համակարգի տվյալները դեռ բեռնվում են: Խնդրում ենք սպասել մի պահ և կրկին փորձել:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const profitPerKw = dbProfitMargins.profitMargins?.data?.[profitKey]?.value;
            
            if (!profitPerKw) {
                console.error(`Profit value not found for warranty years: ${warrantyYears}`);
                const message = currentLanguage === 'en' 
                    ? `Profit value not found for ${warrantyYears}-year warranty. Please check database configuration.`
                    : `${warrantyYears}-տարյա երաշխիքի համար շահույթի արժեքը չի գտնվել: Խնդրում ենք ստուգել տվյալների բազայի կարգավորումները:`;
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                <span class="text-red-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const profitAmount = Math.ceil(systemPower * profitPerKw);

            // Check if system is larger than 110 kW
            if (systemPower > 110) {
                const message = currentLanguage === 'en' 
                    ? 'System size exceeds 110 kW. Please contact upper management for pricing.'
                    : 'Համակարգի չափը գերազանցում է 110 կՎտ-ը: Խնդրում ենք կապ հաստատել վաճառքի բաժնի հետ գնագոյացման համար:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get selected inverter
            let selectedInverter = null;
            
            // Debug logging for inverter selection
            
            // Check if manual mode is enabled (variable already declared above)
            
            if (isManualMode) {
                // Manual selection mode
                const selectedBrand = document.getElementById('manualBrand').value;
                const selectedPower = document.getElementById('manualPower').value;
                

                
                if (!selectedBrand || !selectedPower) {
                    const message = currentLanguage === 'en' 
                        ? 'Please select both brand and power in manual mode.'
                        : 'Խնդրում ենք ընտրել և՛ բրենդը, և՛ հզորությունը ձեռքով ռեժիմում:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Find inverter by brand and power
                selectedInverter = inverters.find(inv => 
                    inv.brand === selectedBrand && inv.kw == selectedPower
                );
                

                
                if (!selectedInverter) {
                    const message = currentLanguage === 'en' 
                        ? 'No inverter found with selected brand and power!'
                        : 'Ընտրված բրենդով և հզորությամբ փոխակերպիչ չի գտնվել:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
            } else {
                // Auto selection mode
                const selectedInverterId = parseInt(document.getElementById('inverterSelect').value);
                
                // Find the selected inverter from the dropdown by ID
                selectedInverter = inverters.find(inv => inv.id === selectedInverterId);
                if (!selectedInverter) {
                    const message = currentLanguage === 'en' 
                        ? 'Selected inverter not found!'
                    : 'Ընտրված փոխակերպիչը չի գտնվել:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Debug logging for inverter selection
                console.log('🔍 calculateLoan using selected inverter:', {
                    id: selectedInverter.id,
                    brand: selectedInverter.brand,
                    model: selectedInverter.model,
                    kw: selectedInverter.kw,
                    price: selectedInverter.price
                });
            }
            
            const inverterPrice = selectedInverter.price;
            const inverterKw = selectedInverter.kw;
            
            // Debug: Log the current system power and installation type

            // Calculate panel price
            let panelPrice = 0;

            
            if (isManualPanelMode) {
                // Manual panel selection
                const selectedPanelBrand = document.getElementById('manualPanelBrand').value;
                const selectedPanelWattage = document.getElementById('manualPanelWattage').value;
                const selectedPanelQuantity = parseInt(document.getElementById('manualPanelQuantity').value) || 0;
                
                const selectedPanel = panels.find(panel => 
                    panel.brand === selectedPanelBrand && panel.wattage == selectedPanelWattage
                );
                
                if (selectedPanel) {
                    panelPrice = selectedPanel.price * selectedPanelQuantity;
                    selectedPanelInfo = currentLanguage === 'en' 
                        ? `${selectedPanelQuantity} × ${selectedPanel.brand} ${selectedPanel.wattage}W panels`
                        : `${selectedPanelQuantity} × ${selectedPanel.brand} ${selectedPanel.wattage}Վտ պանելներ`;
                }
            } else {
                // Auto panel selection - use selected panel option from suggestions
                if (selectedPanelOption) {
                    const { brand, wattage, quantity, totalPrice } = selectedPanelOption;
                    panelPrice = totalPrice;
                    selectedPanelInfo = currentLanguage === 'en' 
                        ? `${quantity} × ${brand} ${wattage}W panels`
                        : `${quantity} × ${brand} ${wattage}Վտ պանելներ`;
                }
            }

            // Calculate total system price including sales team and unexpected expenses - database values only
            const salesTeamPct = dbSalesCommissions.salesCommissions?.data?.sales_team_pct?.value || 6;
            const unanticipatedExpensesPct = dbUnanticipatedExpenses.unanticipatedExpenses?.data?.unanticipated_expenses_pct?.value || 2;
            
            // Convert percentages to decimals
            const salesTeamPctDecimal = salesTeamPct / 100;
            const unanticipatedExpensesPctDecimal = unanticipatedExpensesPct / 100;
            
            if (!salesTeamPct || !unanticipatedExpensesPct) {
                const message = currentLanguage === 'en' 
                    ? 'Sales team percentage or unanticipated expenses percentage not found. Please check database configuration.'
                    : 'Վաճառքի թիմի տոկոսը կամ անսպասելի ծախսերի տոկոսը չի գտնվել: Խնդրում ենք ստուգել տվյալների բազայի կարգավորումները:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">✕</span>
                                <span class="text-red-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Calculate sales discount based on selected stage
            const salesStage = parseInt(document.getElementById('salesStage').value) || 0;
            const salesDiscountPerKw = salesStage === 0 ? 0 : salesStage === 1 ? 5000 : salesStage === 2 ? 10000 : 15000;
            const totalSalesDiscount = Math.ceil(systemPower * salesDiscountPerKw);
            
            // Calculate accumulator cost if hybrid system is selected
            let accumulatorPrice = 0;
            let selectedAccumulatorInfo = '';
            const selectedInverterType = document.getElementById('inverterType').value;
                    if (selectedInverterType === 'hybrid' && batteries && batteries.length > 0) {
            const batterySelect = document.getElementById('batterySelect');
            if (batterySelect && batterySelect.value) {
                const selectedBattery = batteries.find(bat => bat.id == batterySelect.value);
                if (selectedBattery) {
                    accumulatorPrice = selectedBattery.price;
                    selectedAccumulatorInfo = currentLanguage === 'en'
                        ? `${selectedBattery.brand} ${selectedBattery.model} ${selectedBattery.capacity_kwh}kWh battery`
                        : `${selectedBattery.brand} ${selectedBattery.model} ${selectedBattery.capacity_kwh}կՎտժ մարտկոց`;
                }
            }
        }
            
                        // Calculate subtotal first (including battery for hybrid)
            const subtotal = basePrice + profitAmount + inverterPrice + panelPrice + accumulatorPrice;
            
            // Calculate final price using division: subtotal ÷ (1 - 6% - 2%) = subtotal ÷ 0.92
            const totalSystemPrice = Math.ceil(subtotal / (1 - salesTeamPctDecimal - unanticipatedExpensesPctDecimal));
            
            // Calculate sales team and unexpected expenses from final price
            const salesTeamAmount = Math.ceil(totalSystemPrice * salesTeamPctDecimal);
            const unexpectedExpensesAmount = Math.ceil(totalSystemPrice * unanticipatedExpensesPctDecimal);
            
            // Apply sales discount to final price
            const finalSystemPrice = Math.max(0, totalSystemPrice - totalSalesDiscount);
            
            
            
            // Display results
            const systemValueText = currentLanguage === 'en' ? 'System Value for Cash:' : 'Կանխիկ վաճառքի գին:';
            const breakdownTitle = currentLanguage === 'en' ? 'Calculation Breakdown:' : 'Հաշվարկի մանրամասները:';
            const basePriceText = currentLanguage === 'en' ? 'Base Price (no inverter):' : 'Բազային գին (առանց փոխակերպիչի):';
            const profitText = currentLanguage === 'en' ? `Profit (${profitPerKw.toLocaleString()} per kW):` : `Շահույթ (${profitPerKw.toLocaleString()} կՎտ-ի համար):`;

            const panelPriceText = currentLanguage === 'en' ? 'Panel Price:' : 'Պանելների գին:';
            const subtotalText = currentLanguage === 'en' ? 'Subtotal (Base + Profit + Inverter + Panels):' : 'Ենթագումար (Բազային + Շահույթ + Փոխակերպիչ + Պանելներ):';
            const salesTeamText = currentLanguage === 'en' ? `Sales Team (${salesTeamPct.toFixed(1)}%):` : `Վաճառքի թիմ (${salesTeamPct.toFixed(1)}%):`;
            const unexpectedExpensesText = currentLanguage === 'en' ? `Unanticipated Expenses (${unanticipatedExpensesPct.toFixed(1)}%):` : `Անսպասելի ծախսեր (${unanticipatedExpensesPct.toFixed(1)}%):`;
            
            const basePriceWithProfitAndInverterAndPanels = basePrice + profitAmount + inverterPrice + panelPrice;
            

            const selectedPanelText = currentLanguage === 'en' ? 'Selected Panels:' : 'Ընտրված պանելներ:';
            
            // Check if a panel is selected
            if (!selectedPanelOption) {
                const message = currentLanguage === 'en' 
                    ? 'Please select a panel option from the suggestions above before calculating.'
                    : 'Խնդրում ենք ընտրել պանելի տարբերակ վերևի առաջարկներից հաշվարկելուց առաջ:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-blue-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Show detailed breakdown only when sensitive info is visible; else show simple view
            if (isSensitiveInfoVisible()) {
                // Calculate percentages for display
                const basePricePct = ((basePrice / totalSystemPrice) * 100).toFixed(1);
                const profitPct = ((profitAmount / totalSystemPrice) * 100).toFixed(1);
                const panelPct = ((panelPrice / totalSystemPrice) * 100).toFixed(1);
                const salesTeamPctDisplay = salesTeamPct.toFixed(1);
                const unexpectedExpensesPctDisplay = unanticipatedExpensesPct.toFixed(1);
                
                // Get installation type name for display
                const installationTypeNames = {
                    'aluminiumConstructionOnRoof': currentLanguage === 'en' ? 'Aluminium Construction on Roof' : 'Ալյումինե կոնստրուկցիա տանիքի վրա',
                    'metalConstructionOnRoof': currentLanguage === 'en' ? 'Metal Construction on Roof' : 'Մետաղական կոնստրուկցիա տանիքի վրա',
                    'onRoof': currentLanguage === 'en' ? 'On Roof (Sloped)' : 'Տանիքի վրա (լանջային)',
                    'systemOnGround': currentLanguage === 'en' ? 'System on Ground' : 'Համակարգ գետնի վրա'
                };
                const installationTypeName = installationTypeNames[installationType] || installationType;
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="font-medium text-lg">${systemValueText}</span>
                            <span class="text-green-600 font-semibold text-lg">${finalSystemPrice.toLocaleString()} AMD</span>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-md space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">${breakdownTitle}</h4>
                            
                            <!-- Step 1: Base Price -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 1: Base Price Calculation</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Installation Type:</span>
                                        <span>${installationTypeName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Base Price per kW:</span>
                                        <span class="font-mono">${basePricePerKw.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>System Power:</span>
                                        <span>${systemPower} kW</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Base Price:</span>
                                        <span class="font-mono">${basePrice.toLocaleString()} AMD (${basePricePct}%)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Profit -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 2: Profit Calculation</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Warranty Period:</span>
                                        <span>${warrantyYears} years</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Profit per kW:</span>
                                        ${renderSensitiveValue(profitPerKw.toLocaleString(), ' AMD')}
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Total Profit:</span>
                                        ${renderSensitiveValue(profitAmount.toLocaleString(), ` AMD (${profitPct}%)`)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Inverter (Admin Only) -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 3: Inverter Selection</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Selected Inverter:</span>
                                        <span>${selectedInverter.brand} ${selectedInverter.model} (${selectedInverter.kw} kW)</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Inverter Price:</span>
                                        ${renderSensitiveValue(selectedInverter.price.toLocaleString(), ' AMD')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 4: Battery (Hybrid Only) -->
                            ${selectedInverterType === 'hybrid' && accumulatorPrice > 0 ? `
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 4: Battery Selection</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Selected Battery:</span>
                                        <span>${selectedAccumulatorInfo}</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Battery Price:</span>
                                        ${renderSensitiveValue(accumulatorPrice.toLocaleString(), ' AMD')}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Step ${selectedInverterType === 'hybrid' && accumulatorPrice > 0 ? '5' : '4'}: Panels -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step ${selectedInverterType === 'hybrid' && accumulatorPrice > 0 ? '5' : '4'}: Panel Selection</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Selected Panels:</span>
                                        <span>Auto-selected</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Panel Price:</span>
                                        ${renderSensitiveValue(panelPrice.toLocaleString(), ` AMD (${panelPct}%)`)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 5: Subtotal -->
                            <div class="space-y-2 border-t pt-3">
                                <div class="text-sm font-medium text-gray-700">Step 5: Subtotal</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Base Price:</span>
                                        <span class="font-mono">${basePrice.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>+ Profit:</span>
                                        ${renderSensitiveValue(profitAmount.toLocaleString(), ' AMD')}
                                    </div>
                                    <div class="flex justify-between">
                                        <span>+ Inverter:</span>
                                        ${renderSensitiveValue(selectedInverter.price.toLocaleString(), ' AMD')}
                                    </div>
                                    <div class="flex justify-between">
                                        <span>+ Panels:</span>
                                        ${renderSensitiveValue(panelPrice.toLocaleString(), ` AMD (${panelPct}%)`)}
                                    </div>
                                    ${selectedInverterType === 'hybrid' && accumulatorPrice > 0 ? `
                                    <div class="flex justify-between">
                                        <span>+ Battery:</span>
                                        ${renderSensitiveValue(accumulatorPrice.toLocaleString(), ' AMD')}
                                    </div>
                                    ` : ''}
                                    <div class="flex justify-between font-semibold border-t pt-1">
                                        <span>Subtotal:</span>
                                        <span class="font-mono">${(basePriceWithProfitAndInverterAndPanels + (selectedInverterType === 'hybrid' ? accumulatorPrice : 0)).toLocaleString()} AMD</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 6: Final Calculation -->
                            <div class="space-y-2 border-t pt-3">
                                <div class="text-sm font-medium text-gray-700">Step 6: Final Price Calculation</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Subtotal:</span>
                                        <span class="font-mono">${(basePriceWithProfitAndInverterAndPanels + (selectedInverterType === 'hybrid' ? accumulatorPrice : 0)).toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>÷ (1 - Sales Team ${salesTeamPctDisplay}% - Unexpected ${unexpectedExpensesPctDisplay}%):</span>
                                        <span class="font-mono">÷ 0.92</span>
                                    </div>
                                    <div class="flex justify-between text-blue-600">
                                        <span>Sales Team (${salesTeamPctDisplay}%):</span>
                                        <span class="font-mono">${salesTeamAmount.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between text-orange-600">
                                        <span>Unexpected Expenses (${unexpectedExpensesPctDisplay}%):</span>
                                        <span class="font-mono">${unexpectedExpensesAmount.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between font-semibold text-green-600 border-t pt-1">
                                        <span>Final System Value:</span>
                                        <span class="font-mono">${totalSystemPrice.toLocaleString()} AMD</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 7: Sales Discount -->
                            <div class="space-y-2 border-t pt-3">
                                <div class="text-sm font-medium text-gray-700">Step 7: Sales Discount</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Sales Stage:</span>
                                        <span>Stage ${salesStage}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Discount per kW:</span>
                                        <span class="font-mono">${salesDiscountPerKw.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>System Power:</span>
                                        <span>${systemPower} kW</span>
                                    </div>
                                    <div class="flex justify-between font-medium text-red-600">
                                        <span>Total Sales Discount:</span>
                                        <span class="font-mono">-${totalSalesDiscount.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between font-semibold text-green-600 border-t pt-1">
                                        <span>Final Price After Discount:</span>
                                        <span class="font-mono">${finalSystemPrice.toLocaleString()} AMD</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${selectedPanelText}</span>
                            <span>Auto-selected</span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('results').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="font-medium text-lg">${systemValueText}</span>
                            <span class="text-green-600 font-semibold text-lg">${finalSystemPrice.toLocaleString()} AMD</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${selectedPanelText}</span>
                            <span>${selectedPanelInfo || 'Auto-selected'}</span>
                        </div>
                    </div>
                `;
            }

            // Calculate loan options
            // Check if database values are loaded
            if (!bankConfigurations || bankConfigurations.length === 0) {
                const message = currentLanguage === 'en' 
                    ? 'Bank configurations not loaded yet. Please wait a moment and try again.'
                    : 'Բանկի կոնֆիգուրացիաները դեռ բեռնված չեն: Խնդրում ենք սպասել մի պահ և նորից փորձել:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const loanOptions = [];
            
            bankConfigurations.forEach(bank => {
                bank.options.forEach(option => {
                    option.periods.forEach(period => {
                        // Calculate loan amount with commission using the final price after sales discount
                        const totalPercentage = option.commission;
                        const loanAmountWithCommission = Math.ceil(finalSystemPrice / (1 - totalPercentage));
                        
                        // Calculate actual loan amount (after down payment)
                        const actualLoanAmount = loanAmountWithCommission - 0; // No down payment for now
                        
                        // Calculate monthly payment
                        const monthlyPayment = Math.ceil(calculateLoanPayment(actualLoanAmount, option.interestRate, period));
                        const totalInterest = (monthlyPayment * period) - actualLoanAmount;
                        const totalAmount = monthlyPayment * period;
                        
                        loanOptions.push({
                            bankName: bank.name,
                            interestRate: option.interestRate,
                            commission: option.commission,
                            loanPeriod: period,
                            monthlyPayment: monthlyPayment,
                            totalInterest: totalInterest,
                            totalAmount: totalAmount,
                            loanAmount: actualLoanAmount
                        });
                    });
                });
            });

            // Store all options globally and sort by monthly payment
            allLoanOptions = loanOptions.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
            
            // Populate filter dropdowns
            populateFilters();
            
            // Display all options initially
            displayLoanOptions(allLoanOptions);
            updateResultCount(allLoanOptions.length);
            
            // Set initial sort state
            currentSortField = 'monthlyPayment';
            currentSortDirection = 'asc';
            updateSortIcons('monthlyPayment', 'asc');

            document.getElementById('loanTable').classList.remove('hidden');
        }

        // Global variables for filtering and sorting
        let allLoanOptions = [];
        let currentSortField = '';
        let currentSortDirection = 'asc';
        let currentLanguage = 'en';

        // Language switching function
        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Save language preference to localStorage
            localStorage.setItem('loanCalculatorLanguage', lang);
            
            // Update language buttons
            document.getElementById('langEn').className = lang === 'en' 
                ? 'px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white'
                : 'px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
            
            document.getElementById('langHy').className = lang === 'hy' 
                ? 'px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white'
                : 'px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
            
            // Update all elements with data attributes
            document.querySelectorAll('[data-en][data-hy]').forEach(element => {
                element.textContent = element.getAttribute(`data-${lang}`);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-en-placeholder][data-hy-placeholder]').forEach(element => {
                element.placeholder = element.getAttribute(`data-${lang}-placeholder`);
            });
            
            // Update select options
            document.querySelectorAll('option[data-en][data-hy]').forEach(option => {
                option.textContent = option.getAttribute(`data-${lang}`);
            });
            
            // Update sales stage selector language
            const salesStageSelect = document.getElementById('salesStage');
            if (salesStageSelect) {
                salesStageSelect.querySelectorAll('option').forEach((option, index) => {
                    if (index === 0) {
                        // No Sale option - just dashes
                        const enText = "-------";
                        const hyText = "-------";
                        option.setAttribute('data-en', enText);
                        option.setAttribute('data-hy', hyText);
                    } else {
                        // Sales stage options
                        const stage = index;
                        const discount = stage === 1 ? 5000 : stage === 2 ? 10000 : 15000;
                        const enText = `Stage ${stage}: ${discount.toLocaleString()} AMD/kW discount`;
                        const hyText = `Փուլ ${stage}: ${discount.toLocaleString()} AMD/կՎտ զեղչ`;
                        option.setAttribute('data-en', enText);
                        option.setAttribute('data-hy', hyText);
                    }
                    option.textContent = option.getAttribute(`data-${lang}`);
                });
            }
            
            // Update result count if it exists
            const resultCount = document.getElementById('resultCount');
            if (resultCount && allLoanOptions.length > 0) {
                updateResultCount(allLoanOptions.length);
            }
            
            // Recalculate and display results if they exist
            if (allLoanOptions.length > 0) {
                calculateLoan();
            }
            
            // Update inverter dropdown language
            populateInverterDropdown();
            
            // Update checkbox language if admin is logged in
            updateCheckboxLanguage();
        }

        // Populate inverter dropdown
        function populateInverterDropdown() {
            const inverterSelect = document.getElementById('inverterSelect');
            const selectedInverterType = document.getElementById('inverterType').value;
            const selectedPhase = document.getElementById('phaseFilter').value;
            
            console.log('🔍 populateInverterDropdown called:', {
                selectedInverterType,
                selectedPhase,
                inverters: inverters?.length || 0,
                inverterSelect: !!inverterSelect
            });
            
            // Check if inverters are loaded
            if (!inverters || inverters.length === 0) {
                console.log('❌ No inverters data available');
                // Show loading state when data isn't loaded yet
                inverterSelect.innerHTML = '<option value="">Loading inverters...</option>';
                return;
            }
            
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            inverterSelect.innerHTML = '';
            
            // Filter inverters by selected type strictly
            const typeFilteredInverters = inverters.filter(inverter => {
                // If inverter has no type specified, treat it as 'on_grid' for backward compatibility
                const inverterType = inverter.type || 'on_grid';
                return inverterType === selectedInverterType;
            });
            
            // Filter inverters by selected phase (if a specific phase is selected)
            const phaseFilteredInverters = selectedPhase 
                ? typeFilteredInverters.filter(inverter => {
                    const inverterPhase = inverter.phase || 'one phase';
                    return inverterPhase === selectedPhase;
                })
                : typeFilteredInverters;
            
            console.log('🔍 Type and phase filtering inverters:', {
                selectedInverterType,
                selectedPhase,
                totalInverters: inverters.length,
                typeFilteredCount: typeFilteredInverters.length,
                phaseFilteredCount: phaseFilteredInverters.length,
                phaseFilteredInverters: phaseFilteredInverters.map(inv => ({
                    id: inv.id,
                    brand: inv.brand,
                    model: inv.model,
                    kw: inv.kw,
                    type: inv.type || 'on_grid',
                    phase: inv.phase || 'one phase'
                }))
            });
            
            if (phaseFilteredInverters.length === 0) {
                // If no inverters of selected type/phase, show a message
                const option = document.createElement('option');
                option.value = '';
                const phaseText = selectedPhase ? ` ${selectedPhase.replace('_', ' ')}` : '';
                option.textContent = currentLanguage === 'en' 
                    ? `No ${selectedInverterType.replace('_', ' ')}${phaseText} inverters available`
                    : `${selectedInverterType === 'on_grid' ? 'Ցանցային' : selectedInverterType === 'off_grid' ? 'Ավտոնոմ' : 'Հիբրիդ'}${phaseText} փոխակերպիչներ չկան`;
                inverterSelect.appendChild(option);
                return;
            }
            
            // Find the auto-selected inverter (inverter that can handle system power without overload)
            let autoSelectedInverter = null;
            const minPower = systemPower / 1.15; // Inverter must be able to handle system power
            
            for (let i = 0; i < phaseFilteredInverters.length; i++) {
                if (phaseFilteredInverters[i].kw >= minPower) {
                    autoSelectedInverter = phaseFilteredInverters[i];
                    break;
                }
            }
            
            // Filter and add suitable inverters (inverters that can handle the system power)
            const suitableInverters = phaseFilteredInverters
                .filter(inverter => inverter.kw >= minPower)
                .sort((a, b) => a.price - b.price); // Sort by price (lowest first)
            
            console.log('🔍 Filtering inverters:', {
                totalTypeFiltered: typeFilteredInverters.length,
                minPowerRequired: minPower,
                suitableCount: suitableInverters.length,
                suitableInverters: suitableInverters.map(inv => ({
                    id: inv.id,
                    brand: inv.brand,
                    model: inv.model,
                    kw: inv.kw,
                    type: inv.type,
                    price: inv.price
                }))
            });
            
            suitableInverters.forEach(inverter => {
                const option = document.createElement('option');
                option.value = inverter.id; // Store inverter ID instead of power
                
                // Create more robust text that handles missing model field
                const modelText = inverter.model ? ` ${inverter.model}` : '';
                const phaseText = inverter.phase ? ` - ${inverter.phase === 'one phase' ? '1Φ' : '3Φ'}` : '';
                const text = currentLanguage === 'en' 
                    ? `${inverter.brand}${modelText} - ${inverter.kw} kW (${inverter.type || 'on_grid'})${phaseText}`
                    : `${inverter.brand}${modelText} - ${inverter.kw} կՎտ (${inverter.type === 'on_grid' ? 'Ցանցային' : inverter.type === 'off_grid' ? 'Ավտոնոմ' : inverter.type === 'hybrid' ? 'Հիբրիդ' : 'Ցանցային'})${phaseText}`;
                
                option.textContent = text;
                option.setAttribute('data-en', `${inverter.brand}${modelText} - ${inverter.kw} kW (${inverter.type || 'on_grid'})${phaseText}`);
                option.setAttribute('data-hy', `${inverter.brand}${modelText} - ${inverter.kw} կՎտ (${inverter.type === 'on_grid' ? 'Ցանցային' : inverter.type === 'off_grid' ? 'Ավտոնոմ' : inverter.type === 'hybrid' ? 'Հիբրիդ' : 'Ցանցային'})${phaseText}`);
                
                // Debug logging for each option
                console.log('🔍 Adding inverter option:', {
                    id: inverter.id,
                    brand: inverter.brand,
                    model: inverter.model,
                    kw: inverter.kw,
                    type: inverter.type,
                    text: text
                });
                
                inverterSelect.appendChild(option);
            });
            
            // Set the best suitable inverter as default selected option (lowest price inverter that can handle system power)
            if (suitableInverters.length > 0) {
                // The suitableInverters are already sorted by price (a.price - b.price), so the first one is the cheapest
                const bestInverter = suitableInverters[0];
                inverterSelect.value = bestInverter.id; // Use inverter ID instead of power
                console.log('✅ Inverter dropdown populated successfully:', {
                    totalInverters: inverters.length,
                    typeFilteredCount: typeFilteredInverters.length,
                    phaseFilteredCount: phaseFilteredInverters.length,
                    suitableInverters: suitableInverters.length,
                    selectedInverter: bestInverter.kw + 'kW - ' + bestInverter.price.toLocaleString() + ' AMD (' + bestInverter.id + ')'
                });
                
                // Debug: Show final dropdown options
                console.log('🔍 Final dropdown options:', Array.from(inverterSelect.options).map(opt => ({
                    value: opt.value,
                    text: opt.textContent,
                    selected: opt.selected
                })));
            } else {
                console.log('❌ No suitable inverters found for system power');
            }
        }

        // Populate panel dropdown with intelligent options
        function populatePanelDropdown() {
            console.log('🔍 populatePanelDropdown called:', {
                panels: panels?.length || 0,
                inverters: inverters?.length || 0,
                dbProfitMargins: !!dbProfitMargins,
                dbSalesCommissions: !!dbSalesCommissions,
                dbUnanticipatedExpenses: !!dbUnanticipatedExpenses
            });
            
            // Check if all required data is loaded
            if (!panels || panels.length === 0) {
                console.log('❌ No panels data available');
                return;
            }
            
            if (!inverters || !dbProfitMargins || !dbSalesCommissions || !dbUnanticipatedExpenses) {
                console.log('❌ Missing required data:', {
                    inverters: !!inverters,
                    dbProfitMargins: !!dbProfitMargins,
                    dbSalesCommissions: !!dbSalesCommissions,
                    dbUnanticipatedExpenses: !!dbUnanticipatedExpenses
                });
                return;
            }
            
            console.log('✅ All data available, calling calculatePanelRequirements');
            // Use the intelligent calculation function
            calculatePanelRequirements();
        }

        // Manual inverter selection functions
        function toggleInverterSelection() {
            const toggle = document.getElementById('manualInverterToggle');
            const autoSelection = document.getElementById('autoInverterSelection');
            const manualSelection = document.getElementById('manualInverterSelection');
            

            
            if (toggle.checked) {
                // Switch to manual mode
                autoSelection.classList.add('hidden');
                manualSelection.classList.remove('hidden');
                populateManualBrands();
                populateManualPowers();
                

            } else {
                // Switch to auto mode
                autoSelection.classList.remove('hidden');
                manualSelection.classList.add('hidden');
                // Reset manual selections
                document.getElementById('manualBrand').value = '';
                document.getElementById('manualPower').value = '';
                

            }
            
            // Force recalculation when inverter selection mode changes
            forceRecalculate();
        }

        // Function to refresh manual inverter options when system power changes
        function refreshManualInverterOptions() {
            const toggle = document.getElementById('manualInverterToggle');
            if (toggle.checked) {
                // Only refresh if in manual mode
                populateManualBrands();
                populateManualPowers();
                // Reset both selections when system power changes
                document.getElementById('manualBrand').value = '';
                document.getElementById('manualPower').value = '';
            }
        }

        function populateManualBrands() {
            const brandSelect = document.getElementById('manualBrand');
            
            // Check if inverters are loaded
            if (!inverters || inverters.length === 0) {
                brandSelect.innerHTML = '<option value="">Loading brands...</option>';
                return;
            }
            brandSelect.innerHTML = '<option value="" data-en="Select brand" data-hy="Ընտրեք բրենդը">Select brand</option>';
            
            // Get system power, inverter type, and phase
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            const selectedInverterType = document.getElementById('inverterType').value;
            const selectedPhase = document.getElementById('phaseFilter').value;
            
            // Filter inverters by type strictly
            const typeFilteredInverters = inverters.filter(inverter => {
                // If inverter has no type specified, treat it as 'on_grid' for backward compatibility
                const inverterType = inverter.type || 'on_grid';
                return inverterType === selectedInverterType;
            });
            
            // Filter inverters by selected phase (if a specific phase is selected)
            const phaseFilteredInverters = selectedPhase 
                ? typeFilteredInverters.filter(inverter => {
                    const inverterPhase = inverter.phase || 'one phase';
                    return inverterPhase === selectedPhase;
                })
                : typeFilteredInverters;
            
            if (systemPower > 0) {
                // Calculate minimum power (inverter must be able to handle system power)
                const minPower = systemPower / 1.15; // Inverter must be able to handle system power
                
                // Filter brands: show all brands with inverters that can handle the system power
                const suitableBrands = [...new Set(phaseFilteredInverters
                    .filter(inv => inv.kw >= minPower) // Inverter must be able to handle system power
                    .map(inv => inv.brand)
                )].sort();
                
                if (suitableBrands.length > 0) {
                    suitableBrands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand;
                        option.textContent = brand;
                        option.setAttribute('data-en', brand);
                        option.setAttribute('data-hy', brand);
                        brandSelect.appendChild(option);
                    });
                } else {
                    // No suitable brands found
                    const option = document.createElement('option');
                    option.value = "";
                    option.disabled = true;
                    const text = currentLanguage === 'en' 
                        ? `No suitable ${selectedInverterType.replace('_', ' ')} brands (15% rule)`
                        : `Հարմար ${selectedInverterType === 'on_grid' ? 'ցանցային' : selectedInverterType === 'off_grid' ? 'ավտոնոմ' : 'հիբրիդ'} բրենդներ չկան (15% կանոն)`;
                    option.textContent = text;
                    option.setAttribute('data-en', `No suitable ${selectedInverterType.replace('_', ' ')} brands (15% rule)`);
                    option.setAttribute('data-hy', `Հարմար ${selectedInverterType === 'on_grid' ? 'ցանցային' : selectedInverterType === 'off_grid' ? 'ավտոնոմ' : 'հիբրիդ'} բրենդներ չկան (15% կանոն)`);
                    brandSelect.appendChild(option);
                }
            } else {
                // No system power entered yet - show all brands of selected type and phase
                const brands = [...new Set(phaseFilteredInverters.map(inv => inv.brand))].sort();
                
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    option.setAttribute('data-en', brand);
                    option.setAttribute('data-hy', brand);
                    brandSelect.appendChild(option);
                });
            }
        }

        function populateManualPowers() {
            const powerSelect = document.getElementById('manualPower');
            
            // Check if inverters loaded
            if (!inverters || inverters.length === 0) {
                powerSelect.innerHTML = '<option value="">Loading powers...</option>';
                return;
            }
            powerSelect.innerHTML = '<option value="" data-en="Select power" data-hy="Ընտրեք հզորությունը">Select power</option>';
            
            // Get system power, inverter type, and phase
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            const selectedInverterType = document.getElementById('inverterType').value;
            const selectedPhase = document.getElementById('phaseFilter').value;
            
            // Filter inverters by type strictly
            const typeFilteredInverters = inverters.filter(inverter => {
                // If inverter has no type specified, treat it as 'on_grid' for backward compatibility
                const inverterType = inverter.type || 'on_grid';
                return inverterType === selectedInverterType;
            });
            
            // Filter inverters by selected phase (if a specific phase is selected)
            const phaseFilteredInverters = selectedPhase 
                ? typeFilteredInverters.filter(inverter => {
                    const inverterPhase = inverter.phase || 'one phase';
                    return inverterPhase === selectedPhase;
                })
                : typeFilteredInverters;
            
            if (systemPower > 0) {
                // Calculate minimum power (inverter must be able to handle system power)
                const minPower = systemPower / 1.15; // Inverter must be able to handle system power
                
                // Filter inverters: show all inverters that can handle the system power
                const suitablePowers = [...new Set(phaseFilteredInverters
                    .filter(inv => inv.kw >= minPower) // Inverter must be able to handle system power
                    .map(inv => inv.kw)
                )].sort((a, b) => a - b);
                
                if (suitablePowers.length > 0) {
                    suitablePowers.forEach(power => {
                        const option = document.createElement('option');
                        option.value = power;
                        const text = currentLanguage === 'en' 
                            ? `${power} kW`
                            : `${power} կՎտ`;
                        option.textContent = text;
                        option.setAttribute('data-en', `${power} kW`);
                        option.setAttribute('data-hy', `${power} կՎտ`);
                        powerSelect.appendChild(option);
                    });
                } else {
                    // No suitable inverters found
                    const option = document.createElement('option');
                    option.value = "";
                    option.disabled = true;
                    const text = currentLanguage === 'en' 
                        ? `No suitable ${selectedInverterType.replace('_', ' ')} inverters (15% rule)`
                        : `Հարմար ${selectedInverterType === 'on_grid' ? 'ցանցային' : selectedInverterType === 'off_grid' ? 'ավտոնոմ' : 'հիբրիդ'} փոխակերպիչներ չկան (15% կանոն)`;
                    option.textContent = text;
                    option.setAttribute('data-en', `No suitable ${selectedInverterType.replace('_', ' ')} inverters (15% rule)`);
                    option.setAttribute('data-hy', `Հարմար ${selectedInverterType === 'on_grid' ? 'ցանցային' : selectedInverterType === 'off_grid' ? 'ավտոնոմ' : 'հիբրիդ'} փոխակերպիչներ չկան (15% կանոն)`);
                    powerSelect.appendChild(option);
                }
            } else {
                // No system power entered yet - show all powers of selected type and phase
                const powers = [...new Set(phaseFilteredInverters.map(inv => inv.kw))].sort((a, b) => a - b);
                
                powers.forEach(power => {
                    const option = document.createElement('option');
                    option.value = power;
                    const text = currentLanguage === 'en' 
                        ? `${power} kW`
                        : `${power} կՎտ`;
                    option.textContent = text;
                    option.setAttribute('data-en', `${power} kW`);
                    option.setAttribute('data-hy', `${power} կՎտ`);
                    powerSelect.appendChild(option);
                });
            }
        }

        // Battery selection functions
        function toggleBatterySelection() {
            const toggle = document.getElementById('manualBatteryToggle');
            const autoSelection = document.getElementById('autoBatterySelection');
            const manualSelection = document.getElementById('manualBatterySelection');
            
            if (toggle.checked) {
                // Switch to manual mode
                autoSelection.classList.add('hidden');
                manualSelection.classList.remove('hidden');
                            populateManualBatteryBrands();
            populateManualBatteryCapacities();
            populateManualBatteryChemistries();
            } else {
                // Switch to auto mode
                autoSelection.classList.remove('hidden');
                manualSelection.classList.add('hidden');
                // Reset manual selections
                document.getElementById('manualBatteryBrand').value = '';
                document.getElementById('manualBatteryCapacity').value = '';
                document.getElementById('manualBatteryChemistry').value = '';
            }
            
            // Force recalculation when battery selection mode changes
            forceRecalculate();
        }

        function populateBatteryDropdown() {
            const batterySelect = document.getElementById('batterySelect');
            
            // Check if batteries are loaded
            if (!batteries || batteries.length === 0) {
                batterySelect.innerHTML = '<option value="">Loading batteries...</option>';
                return;
            }
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            batterySelect.innerHTML = '';
            
            console.log('🔍 populateBatteryDropdown called:', {
                systemPower,
                totalBatteries: batteries.length,
                batteries: batteries.map(b => ({ id: b.id, capacity: b.capacity_kwh, brand: b.brand }))
            });
            
            // Debug: Show all batteries for troubleshooting
            debugShowAllBatteries();
            
            // More inclusive filtering: show batteries from 0.5x to 5x system power
            // This ensures small systems can see larger batteries and large systems can see smaller batteries
            const minCapacity = Math.max(0.5, systemPower * 0.3); // Minimum 0.5 kWh or 30% of system power
            const maxCapacity = Math.max(5, systemPower * 5); // Maximum 5 kWh or 500% of system power
            
            console.log('🔍 Battery filtering criteria:', { minCapacity, maxCapacity });
            
            // Filter and add suitable batteries
            const suitableBatteries = batteries
                .filter(battery => {
                    const isSuitable = battery.capacity_kwh >= minCapacity && battery.capacity_kwh <= maxCapacity;
                    console.log(`🔍 Battery ${battery.id} (${battery.capacity_kwh}kWh): ${isSuitable ? '✅' : '❌'}`);
                    return isSuitable;
                })
                .sort((a, b) => a.capacity_kwh - b.capacity_kwh);
            
            console.log('🔍 Suitable batteries found:', suitableBatteries.length);
            
            suitableBatteries.forEach(battery => {
                const option = document.createElement('option');
                option.value = battery.id;
                const text = currentLanguage === 'en' 
                    ? `${battery.brand} ${battery.model} - ${battery.capacity_kwh} kWh (${battery.chemistry})`
                    : `${battery.brand} ${battery.model} - ${battery.capacity_kwh} կՎտժ (${battery.chemistry})`;
                option.textContent = text;
                option.setAttribute('data-en', `${battery.brand} ${battery.model} - ${battery.capacity_kwh} kWh (${battery.chemistry})`);
                option.setAttribute('data-hy', `${battery.brand} ${battery.model} - ${battery.capacity_kwh} կՎտժ (${battery.chemistry})`);
                batterySelect.appendChild(option);
            });
            
            // Set the best suitable battery as default selected option
            if (suitableBatteries.length > 0) {
                // Find the battery closest to recommended capacity
                const recommendedCapacity = systemPower * 1.5; // 1.5 days of storage
                const bestBattery = suitableBatteries.reduce((prev, curr) => 
                    Math.abs(curr.capacity_kwh - recommendedCapacity) < Math.abs(prev.capacity_kwh - recommendedCapacity) ? curr : prev
                );
                batterySelect.value = bestBattery.id;
                console.log('🔍 Best battery selected:', bestBattery.id, bestBattery.capacity_kwh, 'kWh');
            } else {
                console.log('⚠️ No suitable batteries found for system power:', systemPower, 'kW');
                
                // Fallback: show all batteries with a note
                batterySelect.innerHTML = '<option value="" disabled>No batteries match system power - showing all options</option>';
                batteries.forEach(battery => {
                    const option = document.createElement('option');
                    option.value = battery.id;
                    const text = currentLanguage === 'en' 
                        ? `${battery.brand} ${battery.model} - ${battery.capacity_kwh} kWh (${battery.chemistry}) - May not be optimal`
                        : `${battery.brand} ${battery.model} - ${battery.capacity_kwh} կՎտժ (${battery.chemistry}) - Կարող է օպտիմալ չլինել`;
                    option.textContent = text;
                    option.setAttribute('data-en', `${battery.brand} ${battery.model} - ${battery.capacity_kwh} kWh (${battery.chemistry}) - May not be optimal`);
                    option.setAttribute('data-hy', `${battery.brand} ${battery.model} - ${battery.capacity_kwh} կՎտժ (${battery.chemistry}) - Կարող է օպտիմալ չլինել`);
                    batterySelect.appendChild(option);
                });
            }
        }

        function populateManualBatteryBrands() {
            const brandSelect = document.getElementById('manualBatteryBrand');
            
            if (!batteries || batteries.length === 0) {
                brandSelect.innerHTML = '<option value="">Loading brands...</option>';
                return;
            }
            brandSelect.innerHTML = '<option value="" data-en="Select brand" data-hy="Ընտրեք բրենդը">Select brand</option>';
            
            const brands = [...new Set(batteries.map(bat => bat.brand))].sort();
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                option.setAttribute('data-en', brand);
                option.setAttribute('data-hy', brand);
                brandSelect.appendChild(option);
            });
        }

        function populateManualBatteryCapacities() {
            const capacitySelect = document.getElementById('manualBatteryCapacity');
            
            if (!batteries || batteries.length === 0) {
                capacitySelect.innerHTML = '<option value="">Loading capacities...</option>';
                return;
            }
            capacitySelect.innerHTML = '<option value="" data-en="Select capacity" data-hy="Ընտրեք հզորությունը">Select capacity</option>';
            
            const capacities = [...new Set(batteries.map(bat => bat.capacity_kwh))].sort((a, b) => a - b);
            
            capacities.forEach(capacity => {
                const option = document.createElement('option');
                option.value = capacity;
                const text = currentLanguage === 'en' 
                    ? `${capacity} kWh`
                    : `${capacity} kWh`;
                option.textContent = text;
                option.setAttribute('data-en', `${capacity} kWh`);
                option.setAttribute('data-hy', `${capacity} կՎտժ`);
                capacitySelect.appendChild(option);
            });
        }

        function populateManualBatteryChemistries() {
            const chemistrySelect = document.getElementById('manualBatteryChemistry');
            
            if (!batteries || batteries.length === 0) {
                chemistrySelect.innerHTML = '<option value="">Loading chemistries...</option>';
                return;
            }
            chemistrySelect.innerHTML = '<option value="" data-en="Select chemistry" data-hy="Ընտրեք քիմիան">Select chemistry</option>';
            
            const chemistries = [...new Set(batteries.map(bat => bat.chemistry))].sort();
            
            chemistries.forEach(chemistry => {
                const option = document.createElement('option');
                option.value = chemistry;
                option.textContent = chemistry;
                option.setAttribute('data-en', chemistry);
                option.setAttribute('data-hy', chemistry);
                chemistrySelect.appendChild(option);
            });
        }

        // Panel selection functions
        function togglePanelSelection() {
            const toggle = document.getElementById('manualPanelToggle');
            const autoSelection = document.getElementById('autoPanelSelection');
            const manualSelection = document.getElementById('manualPanelSelection');
            
            if (toggle.checked) {
                // Switch to manual mode
                autoSelection.classList.add('hidden');
                manualSelection.classList.remove('hidden');
                populateManualPanelBrands();
                populateManualPanelWattages();
            } else {
                // Switch to auto mode
                autoSelection.classList.remove('hidden');
                manualSelection.classList.add('hidden');
                // Reset manual selections
                document.getElementById('manualPanelBrand').value = '';
                document.getElementById('manualPanelWattage').value = '';
                document.getElementById('manualPanelQuantity').value = '1';
                document.getElementById('manualPanelInfo').textContent = currentLanguage === 'en' ? 'None selected' : 'Ոչինչ ընտրված չէ';
                document.getElementById('panelSystemPowerInfo').textContent = '';
            }
            
            // Force recalculation when panel selection mode changes
            forceRecalculate();
        }

        function populateManualPanelBrands() {
            const brandSelect = document.getElementById('manualPanelBrand');
            
            // Check if panels are loaded
            if (!panels || panels.length === 0) {
                brandSelect.innerHTML = '<option value="">Loading brands...</option>';
                return;
            }
            brandSelect.innerHTML = '<option value="" data-en="Select brand" data-hy="Ընտրեք բրենդը">Select brand</option>';
            
            // Get all unique brands from panels
            const brands = [...new Set(panels.map(panel => panel.brand))].sort();
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                option.setAttribute('data-en', brand);
                option.setAttribute('data-hy', brand);
                brandSelect.appendChild(option);
            });
        }

        function populateManualPanelWattages() {
            const wattageSelect = document.getElementById('manualPanelWattage');
            
            // Check if panels are loaded
            if (!panels || panels.length === 0) {
                wattageSelect.innerHTML = '<option value="">Loading wattages...</option>';
                return;
            }
            wattageSelect.innerHTML = '<option value="" data-en="Select wattage" data-hy="Ընտրեք հզորությունը">Select wattage</option>';
            
            // Get all unique wattages from panels
            const wattages = [...new Set(panels.map(panel => panel.wattage))].sort((a, b) => a - b);
            
            wattages.forEach(wattage => {
                const option = document.createElement('option');
                option.value = wattage;
                const text = currentLanguage === 'en' 
                    ? `${wattage}W`
                    : `${wattage}Վտ`;
                option.textContent = text;
                option.setAttribute('data-en', `${wattage}W`);
                option.setAttribute('data-hy', `${wattage}Վտ`);
                wattageSelect.appendChild(option);
            });
        }



        // Function to calculate complete system cost for a panel option
        function calculateCompleteSystemCost(panelOption) {
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            const installationType = document.getElementById('installationType').value;
            const warrantyYears = parseInt(document.getElementById('warrantyYears').value);
            
            if (!systemPower || !inverters || !dbProfitMargins || !dbSalesCommissions || !dbUnanticipatedExpenses) {
                return panelOption.totalPrice; // Fallback to panel price only
            }
            
            // Use the currently selected inverter from the dropdown
            let selectedInverter = null;
            const inverterSelect = document.getElementById('inverterSelect');
            if (inverterSelect && inverterSelect.value) {
                const selectedInverterId = parseInt(inverterSelect.value);
                selectedInverter = inverters.find(inv => inv.id === selectedInverterId);
                console.log('🔍 calculateCompleteSystemCost using selected inverter ID:', selectedInverterId, selectedInverter);
            }
            
            // If no inverter is selected, fall back to auto-selection logic
            if (!selectedInverter) {
                // Find suitable inverter (smallest inverter where inverter.kw * 1.15 >= systemPower)
                for (let i = 0; i < inverters.length; i++) {
                    if (inverters[i].kw * 1.15 >= systemPower) {
                        selectedInverter = inverters[i];
                        break;
                    }
                }
                console.log('🔍 calculateCompleteSystemCost using auto-selected inverter:', selectedInverter?.kw + 'kW', selectedInverter);
            }
            
            if (!selectedInverter) {
                return panelOption.totalPrice; // Fallback to panel price only
            }
            
            // Calculate base price from installation costs - use same logic as main function
            // Convert camelCase to underscore format to match API response keys
            const installationTypeKey = installationType
                .replace(/([A-Z])/g, '_$1')
                .toLowerCase();
            const installationCostKey = `cost_per_kw_${installationTypeKey}`;
            const basePricePerKw = dbProfitMargins.installationCosts?.data?.[installationCostKey]?.value || 36000;
            const basePrice = Math.ceil(systemPower * basePricePerKw);
            

            
            // Get profit margin based on warranty years (profit margins are global, not per installation type)
            const profitKey = `profit_per_kw_${warrantyYears}Y`;
            
            // Check if profit margins data is loaded
            if (!dbProfitMargins.profitMargins?.data || Object.keys(dbProfitMargins.profitMargins.data).length === 0) {
                return panelOption.totalPrice; // Fallback to panel price only if data not loaded
            }
            
            const profitPerKw = dbProfitMargins.profitMargins?.data?.[profitKey]?.value;
            
            if (!profitPerKw) {
                console.error(`Profit value not found for warranty years: ${warrantyYears}`);
                return panelOption.totalPrice; // Fallback to panel price only if profit not found
            }
            const profitAmount = Math.ceil(systemPower * profitPerKw);
            
            // Get panel price from the option
            const panelPrice = panelOption.totalPrice;
            const inverterPrice = selectedInverter.price;
            
            // Calculate battery cost if hybrid system is selected
            let accumulatorPrice = 0;
            const selectedInverterType = document.getElementById('inverterType').value;
            if (selectedInverterType === 'hybrid' && batteries && batteries.length > 0) {
                const batterySelect = document.getElementById('batterySelect');
                if (batterySelect && batterySelect.value) {
                    const selectedBattery = batteries.find(bat => bat.id == batterySelect.value);
                    if (selectedBattery) {
                        accumulatorPrice = selectedBattery.price;
                    }
                }
            }
            
            // Get sales team and unanticipated expenses percentages - use same logic as main function
            const salesTeamPct = (dbSalesCommissions.salesCommissions?.data?.sales_team_pct?.value || 6) / 100;
            const unanticipatedExpensesPct = (dbUnanticipatedExpenses.unanticipatedExpenses?.data?.unanticipated_expenses_pct?.value || 2) / 100;
            
            // Calculate subtotal first (including battery for hybrid)
            const subtotal = basePrice + profitAmount + inverterPrice + panelPrice + accumulatorPrice;
            
            // Calculate final price using division: subtotal ÷ (1 - 6% - 2%) = subtotal ÷ 0.92
            const totalSystemPrice = Math.ceil(subtotal / (1 - salesTeamPct - unanticipatedExpensesPct));
            
            // Calculate sales team and unexpected expenses from final price
            const salesTeamAmount = Math.ceil(totalSystemPrice * salesTeamPct);
            const unanticipatedExpensesAmount = Math.ceil(totalSystemPrice * unanticipatedExpensesPct);
            
            // Calculate sales discount based on selected stage
            const salesStage = parseInt(document.getElementById('salesStage').value) || 0;
            const salesDiscountPerKw = salesStage === 0 ? 0 : salesStage === 1 ? 5000 : salesStage === 2 ? 10000 : 15000;
            const totalSalesDiscount = Math.ceil(systemPower * salesDiscountPerKw);
            
            // Apply sales discount to final price
            const finalSystemPrice = Math.max(0, totalSystemPrice - totalSalesDiscount);
            
            return finalSystemPrice;
        }

        // Function to calculate intelligent panel options based on system cost for a panel option
        function calculatePanelRequirements() {
            console.log('🔍 calculatePanelRequirements called');
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            console.log('🔍 System power:', systemPower, 'kW');
            console.log('🔍 Panels available:', panels?.length || 0);
            
            if (systemPower > 0 && panels && panels.length > 0) {
                const targetWattage = systemPower * 1000; // Convert kW to W
                const panelOptions = [];
                
                // Get unique panel types (brand + wattage combinations)
                const uniquePanelTypes = [];
                const seen = new Set();
                
                panels.forEach(panel => {
                    const key = `${panel.brand}_${panel.wattage}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniquePanelTypes.push({
                            brand: panel.brand,
                            wattage: panel.wattage,
                            efficiency: panel.efficiency,
                            price: panel.price
                        });
                    }
                });
                
                // Calculate options for each panel type
                uniquePanelTypes.forEach(panelType => {
                    const { brand, wattage, efficiency, price } = panelType;
                    
                    // Calculate quantity needed to reach target power
                    const exactQuantity = targetWattage / wattage;
                    const minQuantity = Math.floor(exactQuantity);
                    const maxQuantity = Math.ceil(exactQuantity);
                    
                    // Create options with different quantities around the target
                    const quantities = new Set(); // Use Set to ensure uniqueness
                    
                    // Add quantities below target (if reasonable)
                    for (let q = Math.max(1, minQuantity - 2); q <= minQuantity; q++) {
                        quantities.add(q);
                    }
                    
                    // Add quantities above target (if reasonable)
                    for (let q = maxQuantity; q <= maxQuantity + 2; q++) {
                        quantities.add(q);
                    }
                    
                    // Debug logging for quantity calculation
                    
                    // Calculate actual power and deviation for each quantity
                    quantities.forEach(quantity => {
                        const actualWattage = quantity * wattage;
                        const actualPower = actualWattage / 1000;
                        const deviation = Math.abs(actualPower - systemPower);
                        const totalPrice = quantity * price;
                        
                        panelOptions.push({
                            brand,
                            wattage,
                            quantity,
                            actualPower: actualPower.toFixed(2),
                            deviation,
                            efficiency,
                            totalPrice,
                            price_per_watt: (totalPrice / actualWattage)
                        });
                    });
                });
                
                // Sort options by deviation (closest to target first)
                panelOptions.sort((a, b) => a.deviation - b.deviation);
                
                // Debug logging for final panel options
                
                // Remove duplicate options (same brand, wattage, quantity)
                const uniquePanelOptions = [];
                const seenOptions = new Set();
                
                panelOptions.forEach(option => {
                    const optionKey = `${option.brand}_${option.wattage}_${option.quantity}`;
                    if (!seenOptions.has(optionKey)) {
                        seenOptions.add(optionKey);
                        uniquePanelOptions.push(option);
                    }
                });
                

                
                // Take top 9 closest unique options to target system power with complete system cost
                const bestOptions = uniquePanelOptions.slice(0, 9);
                
                // Debug logging for best options
                
                // Debug: Log price range for label assignment
                if (bestOptions.length > 0) {
                    const prices = bestOptions.map(opt => opt.totalPrice);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const firstMinIndex = bestOptions.findIndex(opt => opt.totalPrice === minPrice);
                    const firstMaxIndex = bestOptions.findIndex(opt => opt.totalPrice === maxPrice);

                }
                
                // Display panel options in the suggestions display
                const panelSuggestions = document.getElementById('panelSuggestions');
                
                if (!panelSuggestions) {
                    console.error('❌ Panel suggestions element not found!');
                    return;
                }
                

                
                // Clear and populate the suggestions display
                panelSuggestions.innerHTML = '';
                
                // Create a summary section
                const summarySection = document.createElement('div');
                summarySection.className = 'mb-3 p-2 bg-blue-50 border border-blue-200 rounded-md';
                summarySection.innerHTML = `
                    <div class="text-sm text-blue-800 font-medium">
                        ${currentLanguage === 'en' ? `Found ${bestOptions.length} panel combinations` : `Գտնվել է ${bestOptions.length} պանելների համակցություն`}
                    </div>
                    <div class="text-xs text-blue-600">
                        ${currentLanguage === 'en' ? 'Click any suggestion to select it' : 'Սեղմեք ցանկացած առաջարկ՝ այն ընտրելու համար'}
                    </div>
                `;
                panelSuggestions.appendChild(summarySection);
                
                // Create a grid container for better layout
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3';
                
                // Pre-calculate price labels to ensure uniqueness
                const prices = bestOptions.map(opt => opt.totalPrice);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                
                // Find the FIRST index of min and max prices to avoid duplicates
                const firstMinIndex = bestOptions.findIndex(opt => opt.totalPrice === minPrice);
                const firstMaxIndex = bestOptions.findIndex(opt => opt.totalPrice === maxPrice);
                
                // Additional validation: ensure min and max are different
                const hasPriceVariation = minPrice !== maxPrice;
                

                
                // Debug: Show all prices for verification
                
                bestOptions.forEach((option, index) => {
                    // Create suggestion card
                    const suggestionCard = document.createElement('div');
                    suggestionCard.className = 'bg-white p-3 rounded border border-gray-200 hover:border-tiamat-blue cursor-pointer transition-colors';
                    suggestionCard.onclick = () => {
                        // Update selected panel info directly when suggestion is clicked
                        updateSelectedPanelInfo(option);
                    };
                    
                    // Create descriptive text
                    const deviationText = option.deviation < 0.1 ? 'Perfect match' : 
                                        option.deviation < 0.5 ? 'Very close' : 
                                        option.deviation < 1.0 ? 'Close' : 'Near';
                    
                    const deviationColor = option.deviation < 0.1 ? 'text-green-600' : 
                                         option.deviation < 0.5 ? 'text-blue-600' : 
                                         option.deviation < 1.0 ? 'text-yellow-600' : 'text-gray-600';
                    
                    // Add price labels - ensure only one option gets each label
                    let priceLabel = '';
                    let priceLabelColor = '';
                    
                    // Assign labels based on pre-calculated indices
                    if (index === firstMinIndex && hasPriceVariation) {
                        priceLabel = currentLanguage === 'en' ? 'Lowest price' : 'Ամենացածր գին';
                        priceLabelColor = 'text-green-600';
                    } else if (index === firstMaxIndex && hasPriceVariation) {
                        priceLabel = currentLanguage === 'en' ? 'Highest price' : 'Ամենաբարձր գին';
                        priceLabelColor = 'text-red-600';
                    }
                    
                    // Debug: Log price label assignment for this option
                    
                    const text = currentLanguage === 'en' 
                        ? `${option.quantity} × ${option.brand} ${option.wattage}W = ${option.actualPower} kW`
                        : `${option.quantity} × ${option.brand} ${option.wattage}Վտ = ${option.actualPower} կՎտ`;
                    
                    // Calculate system value for debugging
                    const systemValue = calculateCompleteSystemCost(option) || option.totalPrice;
                    console.log(`🔍 Panel option ${index}: ${text} - System Value: ${systemValue.toLocaleString()} AMD`);
                    
                    suggestionCard.innerHTML = `
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800 text-sm">${text}</div>
                                    <div class="flex flex-wrap gap-2 text-xs items-center">
                                        <span class="${deviationColor} font-medium">${deviationText}</span>
                                        ${priceLabel ? `<span class="${priceLabelColor} font-medium px-2 py-1 bg-gray-100 rounded">${priceLabel}</span>` : ''}
                                    </div>
                                </div>
                                ${index === 0 ? '<span class="text-green-600 text-xs font-bold">⭐ BEST</span>' : ''}
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-600 font-medium">${currentLanguage === 'en' ? 'System Value' : 'Համակարգի արժեք'}: ${systemValue.toLocaleString()} AMD</span>
                            </div>
                        </div>
                    `;
                    
                    gridContainer.appendChild(suggestionCard);
                });
                
                // Append the grid container to the suggestions display
                panelSuggestions.appendChild(gridContainer);
                
                // Automatically select the best match (first option) by default
                if (bestOptions.length > 0) {
                    const bestOption = bestOptions[0]; // First option is the best match
                    updateSelectedPanelInfo(bestOption);
                }
                
                // Final validation: Log which options got which labels
                
                // Auto-recalculate when panel suggestions are updated
                autoRecalculate();
                
                console.log('✅ Panel suggestions completed with updated system values');
            } else {
                // Clear suggestions when no system power
                const panelSuggestions = document.getElementById('panelSuggestions');
                
                if (panelSuggestions) {
                    panelSuggestions.innerHTML = '<div class="text-sm text-gray-500 text-center py-4" data-en="Enter System Power above to see panel suggestions" data-hy="Մուտքագրեք համակարգի հզորությունը վերևում՝ պանելների առաջարկները տեսնելու համար">Enter System Power above to see panel suggestions</div>';
                }
                
                // Clear the selected panel option when no suggestions
                updateSelectedPanelInfo(null);
                
                // Clear results when no panel suggestions
                clearCalculationResults();
            }
        }

        function updateManualPanelInfo() {
            const brandSelect = document.getElementById('manualPanelBrand');
            const wattageSelect = document.getElementById('manualPanelWattage');
            const quantitySelect = document.getElementById('manualPanelQuantity');
            
            const selectedBrand = brandSelect.value;
            const selectedWattage = wattageSelect.value;
            const selectedQuantity = parseInt(quantitySelect.value) || 1;
            
            if (selectedBrand && selectedWattage) {
                // Find the first panel with matching brand and wattage
                const selectedPanel = panels.find(panel => 
                    panel.brand === selectedBrand && panel.wattage == selectedWattage
                );
                
                if (selectedPanel) {
                    const info = currentLanguage === 'en' 
                        ? `${selectedPanel.brand} (${selectedPanel.wattage}W, ${selectedPanel.efficiency}% efficiency)`
                        : `${selectedPanel.brand} (${selectedPanel.wattage}Վտ, ${selectedPanel.efficiency}% արդյունավետություն)`;
                    
                    document.getElementById('manualPanelInfo').textContent = info;
                    
                    // Calculate and display system power
                    const totalWattage = selectedPanel.wattage * selectedQuantity;
                    const systemPowerKw = (totalWattage / 1000).toFixed(2);
                    
                    const powerInfo = currentLanguage === 'en' 
                        ? `System Power: ${systemPowerKw} kW (${selectedQuantity} × ${selectedPanel.wattage}W)`
                        : `Համակարգի հզորություն: ${systemPowerKw} կՎտ (${selectedQuantity} × ${selectedPanel.wattage}Վտ)`;
                    
                    document.getElementById('panelSystemPowerInfo').textContent = powerInfo;
                    
                    // Update the system power input field
                    document.getElementById('systemPower').value = systemPowerKw;
                    
                    // Refresh inverter options based on new system power
                    refreshManualInverterOptions();
                    
                    // Automatically update inverter auto-selection for the new system power
                    updateInverterAutoSelection(systemPowerKw);
                    
                    // Force recalculation when manual panel selection changes system power
                    forceRecalculate();
                } else {
                    document.getElementById('manualPanelInfo').textContent = currentLanguage === 'en' ? 'No matching panel found' : 'Համապատասխան պանել չի գտնվել';
                    document.getElementById('panelSystemPowerInfo').textContent = '';
                }
            } else {
                document.getElementById('manualPanelInfo').textContent = currentLanguage === 'en' ? 'None selected' : 'Ոչինչ ընտրված չէ';
                document.getElementById('panelSystemPowerInfo').textContent = '';
            }
        }
        
        // Function to clear calculation results when system parameters change
        function clearCalculationResults() {
            // Clear the results display
            const resultsElement = document.getElementById('results');
            if (resultsElement) {
                resultsElement.innerHTML = `
                    <div class="text-center text-gray-500" data-en="Enter system parameters and click 'Calculate Loan Options' to see results" data-hy="Մուտքագրեք համակարգի պարամետրերը և սեղմեք 'Հաշվարկել վարկի տարբերակները' արդյունքները տեսնելու համար">
                        Enter system parameters and click "Calculate Loan Options" to see results
                    </div>
                `;
            }
            
            // Clear loan table if it exists
            const loanTable = document.getElementById('loanTable');
            if (loanTable) {
                loanTable.classList.add('hidden');
            }
            
            // Reset global variables
            allLoanOptions = [];
            selectedPanelOption = null;
            selectedPanelInfo = '';
        }

        // Function to automatically update inverter auto-selection based on system power
        function updateInverterAutoSelection(systemPower) {
            // Only update if we're in auto inverter mode
            const manualToggle = document.getElementById('manualInverterToggle');
            if (manualToggle.checked) {
                console.log('🔍 updateInverterAutoSelection: Manual mode enabled, skipping auto-update');
                return;
            }
            
            // Check if inverters are loaded
            if (!inverters || inverters.length === 0) {
                console.log('⚠️ updateInverterAutoSelection: No inverters loaded');
                return;
            }
            
            // Check if user has manually selected an inverter (even in auto mode)
            const inverterSelect = document.getElementById('inverterSelect');
            if (inverterSelect && inverterSelect.value) {
                const userSelectedInverterId = parseInt(inverterSelect.value);
                const userSelectedInverter = inverters.find(inv => inv.id === userSelectedInverterId);
                if (userSelectedInverter) {
                    console.log('🔍 updateInverterAutoSelection: User has manually selected inverter:', userSelectedInverter.kw + 'kW', userSelectedInverter.brand, '(ID:', userSelectedInverterId + ')');
                    console.log('🔍 updateInverterAutoSelection: Respecting user selection, skipping auto-update');
                    return; // Respect user's manual selection
                }
            }
            
            // Also check the global flag
            if (window.userHasSelectedInverter) {
                console.log('🔍 updateInverterAutoSelection: User has manually selected inverter (flag set), skipping auto-update');
                return; // Respect user's manual selection
            }
            
            console.log('🔍 updateInverterAutoSelection: Updating inverter selection for system power:', systemPower);
            
            // Find the best inverter for the system power (cheapest inverter where inverter.kw * 1.15 >= systemPower)
            let bestInverter = null;
            const minPower = systemPower / 1.15;
            
            // Filter inverters that can handle the system power, then find the cheapest one
            const suitableInverters = inverters.filter(inv => inv.kw >= minPower);
            if (suitableInverters.length > 0) {
                // Sort by price (lowest first) and take the first one
                suitableInverters.sort((a, b) => a.price - b.price);
                bestInverter = suitableInverters[0];
            }
            
            if (bestInverter) {
                // Update the inverter dropdown selection
                if (inverterSelect) {
                    // Find the option with the matching inverter ID
                    const targetOption = Array.from(inverterSelect.options).find(option => 
                        parseInt(option.value) === bestInverter.id
                    );
                    
                    if (targetOption) {
                        inverterSelect.value = targetOption.value;
                        console.log('🔍 updateInverterAutoSelection: Updated to inverter:', {
                            id: bestInverter.id,
                            kw: bestInverter.kw,
                            brand: bestInverter.brand,
                            price: bestInverter.price
                        });
                    } else {
                        console.log('⚠️ updateInverterAutoSelection: Target inverter option not found in dropdown');
                    }
                }
            } else {
                console.log('⚠️ updateInverterAutoSelection: No suitable inverter found for system power:', systemPower);
            }
        }

        // Debug function to show all batteries (for troubleshooting)
        function debugShowAllBatteries() {
            console.log('🔍 DEBUG: All batteries in system:', {
                totalBatteries: batteries?.length || 0,
                systemPower: parseFloat(document.getElementById('systemPower').value) || 0,
                batteries: batteries?.map(b => ({
                    id: b.id,
                    brand: b.brand,
                    model: b.model,
                    capacity_kwh: b.capacity_kwh,
                    price: b.price
                })) || []
            });
        }
        
        // Function to auto-recalculate when parameters change
        function autoRecalculate() {
            // Check if we have all required data
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            
            if (systemPower > 0 && isDataLoaded) {
                // Check if we have either a selected panel OR manual selections
                const hasPanelSelection = selectedPanelOption || 
                    (document.getElementById('manualPanelToggle').checked && 
                     document.getElementById('manualPanelBrand').value && 
                     document.getElementById('manualPanelWattage').value);
                
                // Check if we have inverter selection (either auto or manual)
                const hasInverterSelection = !document.getElementById('manualInverterToggle').checked || 
                    (document.getElementById('manualBrand').value && document.getElementById('manualPower').value);
                
                if (hasPanelSelection && hasInverterSelection) {
                    // Small delay to prevent rapid recalculations
                    clearTimeout(window.autoRecalculateTimer);
                    window.autoRecalculateTimer = setTimeout(() => {
                        calculateLoan();
                    }, 500); // 500ms delay for better performance
                }
            }
        }

        // Function to force recalculation when inverter or panel selections change
        function forceRecalculate() {
            // Clear any existing timer
            clearTimeout(window.autoRecalculateTimer);
            
            // Debug logging for inverter selection
            const isManualMode = document.getElementById('manualInverterToggle').checked;
            const manualBrand = document.getElementById('manualBrand').value;
            const manualPower = document.getElementById('manualPower').value;
            
            // Force immediate recalculation
            if (isDataLoaded) {
                calculateLoan();
            }
        }

        // Function to update selected panel info when a panel option is selected
        function updateSelectedPanelInfo(panelOption) {
            if (!panelOption) {
                selectedPanelOption = null;
                selectedPanelInfo = '';
                // Remove highlighting from all cards
                const allCards = document.querySelectorAll('#panelSuggestions .bg-white');
                allCards.forEach(card => {
                    card.classList.remove('ring-2', 'ring-tiamat-blue', 'bg-blue-50');
                    card.classList.add('bg-white');
                });
                return;
            }
            
            // Store the selected panel option globally
            selectedPanelOption = panelOption;
            
            // Update the selectedPanelInfo for display
            const { brand, wattage, quantity, actualPower } = panelOption;
            selectedPanelInfo = currentLanguage === 'en'
                ? `${quantity} × ${brand} ${wattage}W = ${actualPower} kW`
                : `${quantity} × ${brand} ${wattage}Վտ = ${actualPower} կՎտ`;
            
            // Remove highlighting from all cards first
            const allCards = document.querySelectorAll('#panelSuggestions .bg-white, #panelSuggestions .bg-blue-50');
            allCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-tiamat-blue', 'bg-blue-50');
                card.classList.add('bg-white');
            });
            
            // Find and highlight the selected card
            const selectedCard = Array.from(document.querySelectorAll('#panelSuggestions .bg-white')).find(card => {
                const cardText = card.textContent;
                const { brand, wattage, quantity, actualPower } = panelOption;
                // Check for both English and Armenian text formats
                const expectedTextEn = `${quantity} × ${brand} ${wattage}W = ${actualPower} kW`;
                const expectedTextHy = `${quantity} × ${brand} ${wattage}Վտ = ${actualPower} կՎտ`;
                return cardText.includes(expectedTextEn) || cardText.includes(expectedTextHy);
            });
            
            if (selectedCard) {
                selectedCard.classList.remove('bg-white');
                selectedCard.classList.add('ring-2', 'ring-tiamat-blue', 'bg-blue-50');
            }
            
            // Force recalculation when panel selection changes
            forceRecalculate();
        }


        // Set default values
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language from localStorage
            const savedLanguage = localStorage.getItem('loanCalculatorLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                // Update language buttons to reflect saved preference
                document.getElementById('langEn').className = savedLanguage === 'en' 
                    ? 'px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white'
                    : 'px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('langHy').className = savedLanguage === 'hy' 
                    ? 'px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white'
                    : 'px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
            }
            
            document.getElementById('systemPower').value = '10.44';
            
            // Initialize selectedPanelInfo to prevent undefined errors
            if (typeof selectedPanelInfo === 'undefined') {
                selectedPanelInfo = 'Auto-selected';
            }
            

            
            // Populate inverter dropdown with initial state (shows loading message)
            populateInverterDropdown();
            
            // Also populate manual inverter options with initial state
            populateManualBrands();
            populateManualPowers();
            
            // Also populate panel options with initial state
            populateManualPanelBrands();
            populateManualPanelWattages();
            
            // Add event listeners for filters
            document.getElementById('bankFilter').addEventListener('change', applyFilters);
            document.getElementById('periodFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applySorting);
            
            // Add event listener for system power to update inverter and panel dropdowns automatically
            document.getElementById('systemPower').addEventListener('input', function() {
                // Add a small delay to prevent rapid firing during typing
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    // Only update if data is loaded
                    if (isDataLoaded && inverters && inverters.length > 0) {
                        populateInverterDropdown();
                        refreshManualInverterOptions();
                        
                        // Update inverter auto-selection for the new system power
                        const systemPower = parseFloat(this.value) || 0;
                        if (systemPower > 0) {
                            updateInverterAutoSelection(systemPower);
                        }
                    }
                    if (isDataLoaded && panels && panels.length > 0) {
                        // This will automatically calculate and display panel suggestions
                        populatePanelDropdown();
                    }
                    
                    // Auto-recalculate when system power changes
                    autoRecalculate();
                }, 200); // Reduced delay for more responsive updates
            });
            
            // Add event listener for warranty years to recalculate when changed
            document.getElementById('warrantyYears').addEventListener('change', function() {
                // Update the profit per kW display immediately
                updateProfitPerKwDisplay();
                
                // Update panel suggestions immediately when warranty changes
                calculatePanelRequirements();
                
                // Auto-recalculate when warranty changes
                autoRecalculate();
            });
            
            // Add event listener for sales stage to recalculate when changed
            document.getElementById('salesStage').addEventListener('change', function() {
                // Update panel suggestions immediately when sales stage changes
                calculatePanelRequirements();
                // Auto-recalculate when sales stage changes
                autoRecalculate();
            });
            
            // Add event listener for installation type to recalculate when changed
            document.getElementById('installationType').addEventListener('change', function() {
                // Update the profit per kW display immediately
                updateProfitPerKwDisplay();
                
                // Update panel suggestions immediately when installation type changes
                calculatePanelRequirements();
                
                // Auto-recalculate when installation type changes
                autoRecalculate();
            });
            
            // Add event listener for inverter type to recalculate when changed
            document.getElementById('inverterType').addEventListener('change', function() {
                // Update inverter dropdown with filtered options
                populateInverterDropdown();
                
                // Show/hide battery selection based on inverter type
                const selectedType = this.value;
                const accumulatorContainer = document.getElementById('batterySelectionContainer');
                
                if (selectedType === 'hybrid') {
                    accumulatorContainer.classList.remove('hidden');
                    // Populate battery dropdown
                    populateBatteryDropdown();
                } else {
                    accumulatorContainer.classList.add('hidden');
                }
                
                // Update panel suggestions immediately when inverter type changes
                calculatePanelRequirements();
                
                // Auto-recalculate when inverter type changes
                autoRecalculate();
            });
            
            // Add event listener for phase filter to recalculate when changed
            document.getElementById('phaseFilter').addEventListener('change', function() {
                // Update inverter dropdown with filtered options
                populateInverterDropdown();
                
                // Update panel suggestions immediately when phase changes
                calculatePanelRequirements();
                
                // Auto-recalculate when phase changes
                autoRecalculate();
            });
            
            // Add real-time updates for phase filter
            document.getElementById('phaseFilter').addEventListener('input', function() {
                // Real-time update when phase changes
                populateInverterDropdown();
                
                // Update panel suggestions in real-time when phase changes
                calculatePanelRequirements();
                
                autoRecalculate();
            });
            
            // Add real-time updates for installation type and warranty years
            document.getElementById('warrantyYears').addEventListener('input', function() {
                // Real-time update when warranty changes
                updateProfitPerKwDisplay();
                
                // Update panel suggestions in real-time when warranty changes
                calculatePanelRequirements();
                
                autoRecalculate();
            });
            
            document.getElementById('installationType').addEventListener('input', function() {
                // Real-time update when installation type changes
                updateProfitPerKwDisplay();
                
                // Update panel suggestions in real-time when installation type changes
                calculatePanelRequirements();
                
                autoRecalculate();
            });
            
            document.getElementById('inverterType').addEventListener('input', function() {
                // Real-time update when inverter type changes
                populateInverterDropdown();
                
                // Show/hide battery selection based on inverter type
                const selectedType = this.value;
                const accumulatorContainer = document.getElementById('batterySelectionContainer');
                
                if (selectedType === 'hybrid') {
                    accumulatorContainer.classList.remove('hidden');
                    // Populate battery dropdown
                    populateBatteryDropdown();
                } else {
                    accumulatorContainer.classList.add('hidden');
                }
                
                // Update panel suggestions in real-time when inverter type changes
                calculatePanelRequirements();
                
                autoRecalculate();
            });
            
            // Add real-time updates for sales stage
            document.getElementById('salesStage').addEventListener('input', function() {
                // Real-time update when sales stage changes
                calculatePanelRequirements();
                autoRecalculate();
            });
            
            // Add event listeners for manual inverter selection changes with real-time updates
            document.getElementById('manualBrand').addEventListener('input', function() {
                // Real-time update when brand changes
                forceRecalculate();
            });
            
            document.getElementById('manualPower').addEventListener('input', function() {
                // Real-time update when power changes
                forceRecalculate();
            });
            
            // Also keep change events for compatibility
            document.getElementById('manualBrand').addEventListener('change', function() {
                forceRecalculate();
            });
            
            document.getElementById('manualPower').addEventListener('change', function() {
                forceRecalculate();
            });
            
            // Add event listener for auto inverter selection changes
            document.getElementById('inverterSelect').addEventListener('change', function() {
                const selectedInverterId = parseInt(this.value);
                const selectedInverter = inverters.find(inv => inv.id === selectedInverterId);
                console.log('🔍 Inverter selection changed to ID:', selectedInverterId, '->', selectedInverter ? `${selectedInverter.brand} ${selectedInverter.kw}kW` : 'Unknown');
                
                // Mark that user has manually selected an inverter
                window.userHasSelectedInverter = true;
                console.log('🔍 User has manually selected inverter, marking for respect');
                
                // Force recalculation for main calculations
                forceRecalculate();
                
                // Force refresh of panel suggestions to update system values
                if (typeof calculatePanelRequirements === 'function') {
                    console.log('🔍 Refreshing panel suggestions after inverter change...');
                    setTimeout(() => {
                        calculatePanelRequirements();
                        console.log('✅ Panel suggestions refreshed');
                    }, 100);
                } else {
                    console.log('❌ calculatePanelRequirements function not found');
                }
            });
            
            // Add event listener for auto battery selection changes
            document.getElementById('batterySelect').addEventListener('change', function() {
                forceRecalculate();
            });
            
            // Add event listeners for manual battery selection changes
            document.getElementById('manualBatteryBrand').addEventListener('change', function() {
                forceRecalculate();
            });
            
            document.getElementById('manualBatteryCapacity').addEventListener('change', function() {
                forceRecalculate();
            });
            
            document.getElementById('manualBatteryChemistry').addEventListener('change', function() {
                forceRecalculate();
            });
            
            // Add event listeners for manual panel selection changes with real-time updates
            document.getElementById('manualPanelBrand').addEventListener('input', function() {
                // Real-time update when brand changes
                updateManualPanelInfo();
            });
            
            document.getElementById('manualPanelWattage').addEventListener('input', function() {
                // Real-time update when wattage changes
                updateManualPanelInfo();
            });
            
            document.getElementById('manualPanelQuantity').addEventListener('input', function() {
                // Real-time update when quantity changes
                updateManualPanelInfo();
            });
            
            // Also keep change events for compatibility
            document.getElementById('manualPanelBrand').addEventListener('change', function() {
                forceRecalculate();
            });
            
            document.getElementById('manualPanelWattage').addEventListener('change', function() {
                forceRecalculate();
            });
            
            document.getElementById('manualPanelQuantity').addEventListener('change', function() {
                forceRecalculate();
            });
            
            // Load saved language preference
            if (savedLanguage) {
                switchLanguage(savedLanguage);
            }
            
            // ADDITIONAL SECURITY: Double-check security on window load
            window.addEventListener('load', function() {
                // Force security check again after all resources are loaded
                // enforceSecurityOnLoad(); // Temporarily disabled
            });
            
            // Ensure Armenian button is always visible
            const langHyButton = document.getElementById('langHy');
            if (langHyButton) {
                langHyButton.style.display = 'inline-block';
                langHyButton.style.visibility = 'visible';
                langHyButton.classList.remove('hidden');
            }
            
            // Initialize profit per kW display (hidden by default for non-admin users)
            hideProfitPerKwDisplay();
            
            // Load system data (banks, inverters, etc.) from database
            fetchSystemCostSettings().then(() => {
                // Data loaded successfully
                
                // Initialize manual inverter dropdowns if manual mode is enabled
                const manualToggle = document.getElementById('manualInverterToggle');
                if (manualToggle && manualToggle.checked) {
                    populateManualBrands();
                    populateManualPowers();
                }
            }).catch(error => {
                // Handle error silently
            });
            

        });
        
        // Function to update the profit per kW display based on selected warranty years and installation type
        function updateProfitPerKwDisplay() {
            // Only update if admin is logged in AND profit display exists
            if (!isAdminLoggedIn) {
                return;
            }
            
            const profitDisplay = document.getElementById('currentProfitPerKw');
            if (!profitDisplay) {
                return;
            }
            
            // Check if profit margins data is loaded
            if (!dbProfitMargins.profitMargins?.data || Object.keys(dbProfitMargins.profitMargins.data).length === 0) {
                profitDisplay.textContent = 'Loading...';
                return;
            }
            
            const installationType = document.getElementById('installationType')?.value || 'onRoof';
            const warrantyYears = parseInt(document.getElementById('warrantyYears')?.value) || 12;
            
            // Get profit from database based on warranty years (profit margins are global, not per installation type)
            const profitKey = `profit_per_kw_${warrantyYears}Y`;
            
            const profitPerKw = dbProfitMargins.profitMargins?.data?.[profitKey]?.value;
            
            if (!profitPerKw) {
                console.error(`Profit value not found for warranty years: ${warrantyYears}`);
                console.error('Available keys:', Object.keys(dbProfitMargins.profitMargins?.data || {}));
                profitDisplay.textContent = 'Not configured';
                return;
            }
            
            profitDisplay.textContent = profitPerKw.toLocaleString() + ' AMD';
        }

        function populateFilters() {
            const bankFilter = document.getElementById('bankFilter');
            const periodFilter = document.getElementById('periodFilter');
            
            // Get unique banks and periods
            const banks = [...new Set(allLoanOptions.map(option => option.bankName))];
            const periods = [...new Set(allLoanOptions.map(option => option.loanPeriod))].sort((a, b) => a - b);
            
            // Clear existing options (except first)
            bankFilter.innerHTML = '<option value="">All Banks</option>';
            periodFilter.innerHTML = '<option value="">All Periods</option>';
            
            // Add bank options
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankFilter.appendChild(option);
            });
            
            // Add period options
            periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                const monthsText = currentLanguage === 'en' ? 'months' : 'ամիս';
                option.textContent = `${period} ${monthsText}`;
                periodFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const bankFilter = document.getElementById('bankFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            
            let filteredOptions = allLoanOptions.filter(option => {
                const bankMatch = !bankFilter || option.bankName === bankFilter;
                const periodMatch = !periodFilter || option.loanPeriod === parseInt(periodFilter);
                return bankMatch && periodMatch;
            });
            
            // Apply current sorting
            if (currentSortField) {
                filteredOptions = sortOptions(filteredOptions, currentSortField, currentSortDirection);
            }
            
            displayLoanOptions(filteredOptions);
            updateResultCount(filteredOptions.length);
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            if (!sortBy) return;
            
            const [field, direction] = sortBy.includes('Desc') 
                ? [sortBy.replace('Desc', ''), 'desc'] 
                : [sortBy, 'asc'];
            
            currentSortField = field;
            currentSortDirection = direction;
            
            // Get current filtered options
            const bankFilter = document.getElementById('bankFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            
            let filteredOptions = allLoanOptions.filter(option => {
                const bankMatch = !bankFilter || option.bankName === bankFilter;
                const periodMatch = !periodFilter || option.loanPeriod === parseInt(periodFilter);
                return bankMatch && periodMatch;
            });
            
            filteredOptions = sortOptions(filteredOptions, field, direction);
            displayLoanOptions(filteredOptions);
        }

        function sortOptions(options, field, direction) {
            return options.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle string comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }

        function sortTable(field) {
            // Toggle direction if same field
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // Get current filtered options
            const bankFilter = document.getElementById('bankFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            
            let filteredOptions = allLoanOptions.filter(option => {
                const bankMatch = !bankFilter || option.bankName === bankFilter;
                const periodMatch = !periodFilter || option.loanPeriod === parseInt(periodFilter);
                return bankMatch && periodMatch;
            });
            
            filteredOptions = sortOptions(filteredOptions, field, currentSortDirection);
            displayLoanOptions(filteredOptions);
            updateSortIcons(field, currentSortDirection);
        }

        function updateSortIcons(field, direction) {
            // Reset all icons
            const icons = ['bankSortIcon', 'periodSortIcon', 'rateSortIcon', 'commissionSortIcon',
                          'amountSortIcon', 'paymentSortIcon', 'interestSortIcon', 'totalSortIcon'];
            icons.forEach(id => {
                document.getElementById(id).textContent = '↕';
            });
            
            // Set active icon
            const iconMap = {
                'bankName': 'bankSortIcon',
                'loanPeriod': 'periodSortIcon',
                'interestRate': 'rateSortIcon',
                'commission': 'commissionSortIcon',
                'loanAmount': 'amountSortIcon',
                'monthlyPayment': 'paymentSortIcon',
                'totalInterest': 'interestSortIcon',
                'totalAmount': 'totalSortIcon'
            };
            
            const activeIcon = document.getElementById(iconMap[field]);
            if (activeIcon) {
                activeIcon.textContent = direction === 'asc' ? '↑' : '↓';
            }
        }

        function clearFilters() {
            document.getElementById('bankFilter').value = '';
            document.getElementById('periodFilter').value = '';
            document.getElementById('sortBy').value = 'monthlyPayment';
            
            currentSortField = 'monthlyPayment';
            currentSortDirection = 'asc';
            
            // Reset sort icons
            updateSortIcons('monthlyPayment', 'asc');
            
            // Display all options sorted by monthly payment
            const sortedOptions = sortOptions([...allLoanOptions], 'monthlyPayment', 'asc');
            displayLoanOptions(sortedOptions);
            updateResultCount(sortedOptions.length);
        }

        function updateResultCount(count) {
            const totalCount = allLoanOptions.length;
            const resultCount = document.getElementById('resultCount');
            
            if (currentLanguage === 'en') {
                resultCount.textContent = count === totalCount 
                    ? `Showing all ${totalCount} results` 
                    : `Showing ${count} of ${totalCount} results`;
            } else {
                resultCount.textContent = count === totalCount 
                    ? `Ցուցադրվում են բոլոր ${totalCount} արդյունքները` 
                    : `Ցուցադրվում են ${count} ${totalCount}-ից`;
            }
        }

        function displayLoanOptions(options) {
            const tableBody = document.getElementById('loanTableBody');
            tableBody.innerHTML = '';

            options.forEach(option => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const monthsText = currentLanguage === 'en' ? 'months' : 'ամիս';
                
                // Create commission cell conditionally
                const commissionCell = isSensitiveInfoVisible() 
                    ? `<td class="border p-3 text-center w-24 text-orange-600 font-medium">${(option.commission * 100).toFixed(1)}%</td>`
                    : '';
                
                row.innerHTML = `
                    <td class="border p-3 font-medium">${option.bankName}</td>
                    <td class="border p-3 text-center w-32">${option.loanPeriod} ${monthsText}</td>
                    <td class="border p-3 text-center w-24">${(option.interestRate * 100).toFixed(1)}%</td>
                    ${commissionCell}
                    <td class="border p-3 text-center font-semibold text-green-600 w-40">${option.loanAmount.toLocaleString()}</td>
                    <td class="border p-3 text-center font-semibold text-blue-600 w-36">${option.monthlyPayment.toLocaleString()}</td>
                    <td class="border p-3 text-center font-semibold text-red-600 w-40">${Math.abs(option.totalInterest).toLocaleString()}</td>
                    <td class="border p-3 text-center font-semibold text-purple-600 w-44">${option.totalAmount.toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Admin functionality - Database-based authentication
        let isAdminLoggedIn = false;
        let currentAdminUser = null;



                // Check if current Supabase user has admin privileges
        async function checkAdminStatus() {
            try {
                // Import auth functions
                const { getCurrentUser, isAuthenticated } = await import('/public/auth.js');
                
                if (!isAuthenticated()) {
                    isAdminLoggedIn = false;
                    hideAdminPanel();
                    return;
                }
                
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    isAdminLoggedIn = false;
                    hideAdminPanel();
                    return;
                }
                
                // Check if user has admin role in Supabase
                // Prefer role from app_metadata, fallback to user_metadata, or known admin emails
                const isAdmin = (currentUser.app_metadata && currentUser.app_metadata.role === 'admin') ||
                               (currentUser.user_metadata && currentUser.user_metadata.role === 'admin') ||
                               currentUser.email === 'admin@tiamat.com' ||
                               currentUser.email === 'admin@gmail.com';
                
                if (isAdmin) {
                isAdminLoggedIn = true;
                    currentAdminUser = {
                        id: currentUser.id,
                        username: currentUser.email,
                        full_name: (currentUser.user_metadata && (currentUser.user_metadata.name || currentUser.user_metadata.full_name)) || currentUser.email,
                        role: 'admin'
                    };
                    
                    // Show admin toggle checkbox first
                    showAdminToggleCheckbox();
                    
                    // Keep admin panels hidden by default - admin must use toggle to show them
                    // showAdminPanel(); // Commented out - admin panel stays hidden by default
                showAdminDetails();
                showCommissionColumn();
                showProfitPerKwDisplay();
                    
                    // DO NOT auto-reveal sensitive info - keep it hidden by default
                    // revealAllSensitiveInfo(); // Commented out - sensitive info stays hidden
                    
            } else {
                    isAdminLoggedIn = false;
                    hideAdminPanel();
                }
                
            } catch (error) {
                console.error('Error checking admin status:', error);
                isAdminLoggedIn = false;
                hideAdminPanel();
            }
        }

        function hideAdminPanel() {
            isAdminLoggedIn = false;
            
            // Hide the main admin panel
            const adminPanelMain = document.getElementById('adminPanelMain');
            if (adminPanelMain) {
                adminPanelMain.style.display = 'none';
                adminPanelMain.style.visibility = 'hidden';
            }
            
            hideAdminDetails();
            hideCommissionColumn();
            hideProfitPerKwDisplay();
            hideAllSensitiveInfo(); // Hide all sensitive information
            
            // Remove the toggle container when admin panel is hidden/logged out
            const toggleContainer = document.getElementById('toggleSensitiveInfoContainer');
            if (toggleContainer) {
                toggleContainer.remove();
            }
            
            // Recalculate to hide detailed breakdown
            if (allLoanOptions.length > 0) {
                calculateLoan();
            }
        }
        
        function logoutAdmin() {
            isAdminLoggedIn = false;
            
            // Hide all sensitive information and remove toggle
            hideAllSensitiveInfo();
            const toggleContainer = document.getElementById('toggleSensitiveInfoContainer');
            if (toggleContainer) {
                toggleContainer.remove();
            }
            
            // Reset admin state
            hideAdminDetails();
            hideCommissionColumn();
            hideProfitPerKwDisplay();
        }

        function showCommissionColumn() {
            // Show commission header
            const commissionHeader = document.querySelector('.admin-only');
            if (commissionHeader) {
                commissionHeader.style.display = 'table-cell';
            }
        }

        function hideCommissionColumn() {
            // Hide commission header
            const commissionHeader = document.querySelector('.admin-only');
            if (commissionHeader) {
                commissionHeader.style.display = 'none';
            }
        }
        
        function showProfitPerKwDisplay() {
            // Create and show profit per kW display
            const container = document.getElementById('profitPerKwDisplayContainer');
            if (container) {
                container.innerHTML = `
                    <div id="profitPerKwDisplay" class="mt-2 text-sm text-gray-600">
                        <span data-en="Current Profit per kW:" data-hy="Ընթացիկ շահույթ կՎտ-ի համար:">Current Profit per kW:</span>
                        <span id="currentProfitPerKw" class="font-semibold text-tiamat-blue ml-1">30,000 AMD</span>
                    </div>
                `;
                // Update the display with current warranty value
                updateProfitPerKwDisplay();
            }
        }
        
        function hideProfitPerKwDisplay() {
            // Remove profit per kW display completely
            const container = document.getElementById('profitPerKwDisplayContainer');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Spoiler functionality - CSS-independent security
        function toggleSpoiler(element) {
            if (element.classList.contains('spoiler')) {
                // Show the actual value
                element.textContent = element.getAttribute('data-value');
                element.classList.remove('spoiler');
                element.classList.add('spoiler-revealed');
            } else {
                // Hide the value
                element.textContent = '████████████';
                element.classList.add('spoiler');
                element.classList.remove('spoiler-revealed');
            }
        }

        // CRITICAL SECURITY: Ensure all sensitive data is hidden on page load
        function enforceSecurityOnLoad() {
            // Don't remove admin toggle checkbox if user is already admin
            if (!isAdminLoggedIn) {
                const toggleContainer = document.getElementById('toggleSensitiveInfoContainer');
                if (toggleContainer) {
                    toggleContainer.remove();
                }
            }
            
            // Hide all admin panels (will be shown again if user is admin)
            const adminElements = ['adminPanelMain', 'adminDetails', 'profitPerKwDisplayContainer'];
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                }
            });
            
            // Hide all admin-only table headers
            const commissionHeaders = document.querySelectorAll('.admin-only');
            commissionHeaders.forEach(header => {
                header.style.display = 'none';
            });
            
            // Hide all spoiler elements
            const spoilerElements = document.querySelectorAll('[data-value]');
            spoilerElements.forEach(element => {
                if (element.classList.contains('spoiler-revealed')) {
                    element.textContent = '████████████';
                    element.classList.remove('spoiler-revealed');
                    element.classList.add('spoiler');
                }
            });
            
            // Hide all Calculation Breakdown sections by default
            const breakdownSections = document.querySelectorAll('.bg-gray-50.p-4.rounded-md.space-y-4');
            breakdownSections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Only reset admin state if user is not authenticated as admin
            if (!isAdminLoggedIn) {
                isAdminLoggedIn = false;
                currentAdminUser = null;
            }
        }

        // ADMIN FUNCTION: Automatically reveal all sensitive information
        function revealAllSensitiveInfo() {
            if (!isAdminLoggedIn) return;
            
            console.log('Revealing all sensitive information for admin user');
            
            // Ensure toggle checkbox reflects the revealed state
            const toggleCheckbox = document.getElementById('toggleSensitiveInfoCheckbox');
            if (toggleCheckbox) {
                toggleCheckbox.checked = true;
                const label = toggleCheckbox.closest('label');
                if (label) {
                    const labelText = label.querySelector('span');
                    if (labelText) {
                        // Use currentLanguage variable if available, otherwise default to English
                        const currentLang = typeof currentLanguage !== 'undefined' ? currentLanguage : 'en';
                        if (labelText) {
                            if (currentLang === 'hy') {
                                labelText.textContent = 'Թաքցնել զգայուն տվյալները';
            } else {
                                labelText.textContent = 'Hide Sensitive Info';
                            }
                        }
                    }
                }
            }
            
            // Reveal all spoiler elements - be more aggressive to catch all cases
            const spoilerElements = document.querySelectorAll('[data-value]');
            spoilerElements.forEach(element => {
                const dataValue = element.getAttribute('data-value');
                if (dataValue) {
                    // Always show the actual value, regardless of current class
                    element.textContent = dataValue;
                    element.classList.remove('spoiler');
                    element.classList.add('spoiler-revealed');
                }
            });
            
            // Also look for any elements with spoiler class that might not have data-value
            const spoilerClassElements = document.querySelectorAll('.spoiler');
            spoilerClassElements.forEach(element => {
                // Remove spoiler class and show content if possible
                element.classList.remove('spoiler');
                if (element.textContent === '████████████') {
                    // If it's still showing placeholder, try to find the actual value
                    const dataValue = element.getAttribute('data-value');
                    if (dataValue) {
                        element.textContent = dataValue;
                        element.classList.add('spoiler-revealed');
                    }
                }
            });
            
            // Show all admin-only elements
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(element => {
                element.style.display = 'table-cell';
            });
            
            // Force show all admin panels
            const adminElements = [
                'adminPanelMain',
                'adminDetails',
                'profitPerKwDisplayContainer'
            ];
            
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'block';
                    element.style.visibility = 'visible';
                }
            });
            
            // Show the Calculation Breakdown section(s) - use multiple selectors for robustness
            const breakdownSelectors = [
                '.bg-gray-50.p-4.rounded-md.space-y-4',
                '[class*="bg-gray-50"][class*="p-4"][class*="rounded-md"][class*="space-y-4"]',
                '.bg-gray-50.p-4.rounded-md.space-y-4',
                'div[class*="bg-gray-50"]'
            ];
            
            let breakdownFound = false;
            breakdownSelectors.forEach(selector => {
                const breakdownSections = document.querySelectorAll(selector);
                breakdownSections.forEach(section => {
                    section.style.display = 'block';
                    section.style.visibility = 'visible';
                    breakdownFound = true;
                });
            });
        }

        // ADMIN FUNCTION: Hide all sensitive information when admin logs out or toggled off
        function hideAllSensitiveInfo() {
            // Keep admin toggle checkbox visible; just reset its state and visuals
            const toggleCheckbox = document.getElementById('toggleSensitiveInfoCheckbox');
            if (toggleCheckbox) {
                toggleCheckbox.checked = false;
                // Update label texts based on currentLanguage
                const label = toggleCheckbox.closest('label');
                if (label) {
                    const labelText = label.querySelector('span');
                    if (labelText) {
                        // Use currentLanguage variable if available, otherwise default to English
                        const currentLang = typeof currentLanguage !== 'undefined' ? currentLanguage : 'en';
                        if (currentLang === 'hy') {
                            labelText.textContent = 'Ցույց տալ զգայուն տվյալները';
                        } else {
                            labelText.textContent = 'Show Sensitive Info';
                        }
                    }
                }
            }
            
            // Hide all spoiler elements
            const spoilerElements = document.querySelectorAll('[data-value]');
            spoilerElements.forEach(element => {
                if (element.classList.contains('spoiler-revealed')) {
                    element.textContent = '████████████';
                    element.classList.remove('spoiler-revealed');
                    element.classList.add('spoiler');
                }
            });
            
            // Hide all admin-only elements
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // Hide all admin panels
            const adminElements = [
                'adminPanelMain',
                'adminDetails',
                'profitPerKwDisplayContainer'
            ];
            
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                }
            });
            
            // Hide all Calculation Breakdown sections
            const breakdownSections = document.querySelectorAll('.bg-gray-50.p-4.rounded-md.space-y-4');
            breakdownSections.forEach(section => {
                section.style.display = 'none';
            });
        }

        // ADMIN FUNCTION: Toggle all sensitive information visibility
        function toggleAllSensitiveInfo() {
            if (!isAdminLoggedIn) return;
            
            const toggleCheckbox = document.getElementById('toggleSensitiveInfoCheckbox');
            if (!toggleCheckbox) return;
            
            if (toggleCheckbox.checked) {
                // Currently hidden, so show all
                revealAllSensitiveInfo();
                showAdminPanel(); // Show admin panel when revealing sensitive info
                
                // Always recalculate to show fresh content without spoiler elements
                calculateLoan();
            } else {
                // Currently shown, so hide all
                hideAllSensitiveInfo();
                hideAdminPanel(); // Hide admin panel when hiding sensitive info
            }
        }

        // Create and show admin toggle checkbox
        function showAdminToggleCheckbox() {
            if (!isAdminLoggedIn) return;
            
            // Remove existing checkbox if it exists
            const existingCheckbox = document.getElementById('toggleSensitiveInfoContainer');
            if (existingCheckbox) {
                existingCheckbox.remove();
            }
            
            // Create simple checkbox near the welcome message
            const toggleContainer = document.createElement('div');
            toggleContainer.id = 'toggleSensitiveInfoContainer';
            toggleContainer.className = 'inline-flex items-center space-x-3 bg-white rounded-lg shadow-md border border-gray-200 p-3 mb-4';
            
            // Create checkbox with simple label
            toggleContainer.innerHTML = `
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="toggleSensitiveInfoCheckbox" class="w-4 h-4 text-tiamat-blue bg-gray-100 border-gray-300 rounded focus:ring-tiamat-blue focus:ring-2">
                    <span class="text-sm font-medium text-gray-700" data-en="Show Sensitive Info" data-hy="Ցույց տալ զգայուն տվյալները">Show Sensitive Info</span>
                </label>
            `;
            
            // Insert after the welcome message (after the h1 title)
            const welcomeTitle = document.querySelector('h1[data-en="Solar Loan Calculator"]');
            if (welcomeTitle && welcomeTitle.parentElement) {
                const parent = welcomeTitle.parentElement;
                parent.insertBefore(toggleContainer, welcomeTitle.nextSibling);
            } else {
                // Fallback: add to the top of the form area
                const formArea = document.querySelector('.lg\\:col-span-7.bg-white.rounded-lg.shadow-md.p-6');
                if (formArea) {
                    formArea.insertBefore(toggleContainer, formArea.firstChild);
                }
            }
            
            // DO NOT reveal sensitive info by default - keep it hidden
            // revealAllSensitiveInfo();
            
            // Ensure sensitive info is hidden by default even for admin users
            hideAllSensitiveInfo();
            
            // Add event listener to the checkbox after it's created
            const checkbox = document.getElementById('toggleSensitiveInfoCheckbox');
            if (checkbox) {
                checkbox.addEventListener('change', toggleAllSensitiveInfo);
            }
        }



        function showAdminDetails() {
            const adminDetails = document.getElementById('adminDetails');
            if (adminDetails) {
                adminDetails.style.display = 'block';
                adminDetails.style.visibility = 'visible';
            }
        }

        function hideAdminDetails() {
            const adminDetails = document.getElementById('adminDetails');
            if (adminDetails) {
                adminDetails.style.display = 'none';
                adminDetails.style.visibility = 'hidden';
            }
        }



        // New admin panel functions - CSS-independent security
        function showAdminPanel() {
            if (!isAdminLoggedIn) return;
            
            // Show the admin panel on the main page
            const adminPanelMain = document.getElementById('adminPanelMain');
            if (adminPanelMain) {
                adminPanelMain.style.display = 'block';
                adminPanelMain.style.visibility = 'visible';
                
                // Update the last updated timestamp
                const lastUpdatedElement = document.getElementById('adminLastUpdated');
                if (lastUpdatedElement) {
                    lastUpdatedElement.textContent = new Date().toLocaleString();
                }
                
                // Do not auto-scroll on load; keep the current viewport position
            }
        }

        function logoutAdmin() {
            isAdminLoggedIn = false;
            const adminPanelMain = document.getElementById('adminPanelMain');
            if (adminPanelMain) {
                adminPanelMain.style.display = 'none';
                adminPanelMain.style.visibility = 'hidden';
            }
            // Reset admin state
            hideAdminDetails();
            hideCommissionColumn();
            hideProfitPerKwDisplay();
        }

        function refreshAdminData() {
            if (!isAdminLoggedIn) return;
            
            // Update the last updated timestamp
            const lastUpdatedElement = document.getElementById('adminLastUpdated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = new Date().toLocaleString();
            }
            

        }

        // Add admin details section to the page
        function addAdminSection() {
            const adminSection = `
                <div id="adminDetails" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-tiamat-blue" data-en="Admin: Calculation Details" data-hy="Ադմին: Հաշվարկի մանրամասները">Admin: Calculation Details</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-10 gap-6">
                        <!-- Base Prices -->
                        <div class="lg:col-span-7 space-y-4">
                            <h3 class="font-semibold text-gray-800" data-en="Base Prices (per kW, without inverter)" data-hy="Բազային գները (կՎտ-ի համար, առանց փոխակերպիչի)">Base Prices (per kW, without inverter)</h3>
                            <div class="bg-gray-50 p-4 rounded-md space-y-2">
                                <div class="flex justify-between">
                                    <span data-en="Aluminium Construction on Roof" data-hy="Ալյումինե կոնստրուկցիա տանիքի վրա">Aluminium Construction on Roof:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="130,000 AMD">████████████</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="Metal Construction on Roof" data-hy="Մետաղական կոնստրուկցիա տանիքի վրա">Metal Construction on Roof:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="115,000 AMD">████████████</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="On Roof (Sloped)" data-hy="Տանիքի վրա (լանջային)">On Roof (Sloped):</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="105,000 AMD">████████████</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="System on Ground" data-hy="Համակարգ գետնի վրա">System on Ground:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="117,000 AMD">████████████</span>
                                </div>
                            </div>
                        </div>

                        <!-- Profit by Warranty -->
                        <div class="lg:col-span-3 space-y-4">
                            <h3 class="font-semibold text-gray-800" data-en="Profit per kW by Warranty" data-hy="Շահույթ կՎտ-ի համար ըստ երաշխիքի">Profit per kW by Warranty</h3>
                            <div class="bg-gray-50 p-4 rounded-md space-y-2">
                                <div class="flex justify-between">
                                    <span data-en="2 Years" data-hy="2 Տարի">2 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="15,000 AMD">████████████</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="3 Years" data-hy="3 Տարի">3 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="20,000 AMD">████████████</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="6 Years" data-hy="6 Տարի">6 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="25,000 AMD">████████████</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="12 Years" data-hy="12 Տարի">12 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="30,000 AMD">████████████</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Commission Rates -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-800 mb-4" data-en="Bank Commission Rates" data-hy="Բանկի կոմիսիոն վճարներ">Bank Commission Rates</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-10 gap-6">
                            <!-- ArmEconomBank -->
                            <div class="lg:col-span-7">
                                <h4 class="font-medium text-gray-700 mb-2">ArmEconomBank</h4>
                                <div class="bg-gray-50 p-4 rounded-md text-sm space-y-1">
                                    <div class="grid grid-cols-3 gap-2 text-xs font-medium text-gray-600">
                                        <span>Period</span>
                                        <span>Interest</span>
                                        <span>Commission</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>0%</span><span>21%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>0%</span><span>32%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>0%</span><span>41%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>3%</span><span>18%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>3%</span><span>27%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>3%</span><span>34%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>5%</span><span>16%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>5%</span><span>23%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>5%</span><span>30%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>9%</span><span>10%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>9%</span><span>15%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>9%</span><span>19%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>12%</span><span>6%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>12%</span><span>9%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>12%</span><span>11%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>15%</span><span>2%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>15%</span><span>3%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>15%</span><span>4%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ACBA Bank -->
                            <div class="lg:col-span-3">
                                <h4 class="font-medium text-gray-700 mb-2">ACBA Bank</h4>
                                <div class="bg-gray-50 p-4 rounded-md text-sm space-y-1">
                                    <div class="grid grid-cols-3 gap-2 text-xs font-medium text-gray-600">
                                        <span>Period</span>
                                        <span>Interest</span>
                                        <span>Commission</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>96m</span><span>11%</span><span>4%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logout Button -->
                    <div class="mt-6 text-center">
                        <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                            <span data-en="Logout Admin" data-hy="Դուրս գալ ադմինից">Logout Admin</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Insert admin section after the loan table
            const loanTable = document.getElementById('loanTable');
            loanTable.insertAdjacentHTML('afterend', adminSection);
        }

        // Initialize admin section on page load
        document.addEventListener('DOMContentLoaded', function() {
            addAdminSection();
        });

        // Listen for auth changes to update admin UI immediately after login/logout
        document.addEventListener('authStateChanged', (event) => {
            const detail = event && event.detail ? event.detail : { isAuthenticated: false, user: null };
            if (detail.isAuthenticated) {
                checkAdminStatus();
            } else {
                hideAdminPanel();
            }
        });

        // Function to update checkbox language
        function updateCheckboxLanguage() {
            const toggleCheckbox = document.getElementById('toggleSensitiveInfoCheckbox');
            if (!toggleCheckbox || !isAdminLoggedIn) return;
            
            const label = toggleCheckbox.closest('label');
            if (label) {
                const labelText = label.querySelector('span');
                
                if (labelText) {
                    if (toggleCheckbox.checked) {
                        // Currently showing sensitive info
                        labelText.textContent = currentLanguage === 'hy' ? 'Թաքցնել զգայուն տվյալները' : 'Hide Sensitive Info';
                    } else {
                        // Currently hiding sensitive info
                        labelText.textContent = currentLanguage === 'hy' ? 'Ցույց տալ զգայուն տվյալները' : 'Show Sensitive Info';
                    }
                }
            }
        }

        // Helper: whether sensitive info should be visible (admin AND checkbox checked)
        function isSensitiveInfoVisible() {
            if (!isAdminLoggedIn) {
                return false;
            }
            
            const checkbox = document.getElementById('toggleSensitiveInfoCheckbox');
            
            // If checkbox exists, use its checked state
            if (checkbox) {
                return checkbox.checked;
            }
            
            // If checkbox doesn't exist yet, hide sensitive info by default
            // This ensures sensitive info is hidden until user explicitly chooses to show it
            return false;
        }
        
        // Helper: render sensitive value either as spoiler or direct value
        function renderSensitiveValue(value, suffix = '') {
            const fullValue = suffix ? `${value}${suffix}` : value;
            if (isSensitiveInfoVisible()) {
                // Show actual value directly when sensitive info is visible
                return `<span class="font-mono">${fullValue}</span>`;
            } else {
                // Show as clickable spoiler when sensitive info is hidden
                return `<span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="${fullValue}">████████████</span>`;
            }
        }

    </script>

    <!-- Authentication Script -->
            <script type="module" src="/public/auth.js"></script>
        <script type="module" src="/public/route-protection.js"></script>
    <script>
        // Initialize authentication and route protection when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Import and initialize auth
            const { initAuth } = await import('/public/auth.js');
            await initAuth();
            
            // Initialize route protection
            const { initRouteProtection } = await import('/public/route-protection.js');
            initRouteProtection();
            
            // Enforce security immediately on page load
            // enforceSecurityOnLoad(); // Temporarily disabled
            
            // Fetch system cost settings first, then check admin status
            try {
                await fetchSystemCostSettings();
                
                // Now check admin status after data is loaded
                setTimeout(() => {
                    checkAdminStatus();
                    // DO NOT auto-reveal sensitive info - keep it hidden by default
                    // if (isAdminLoggedIn) {
                    //     revealAllSensitiveInfo();
                    // }
                }, 1000);
            } catch (error) {
                console.error('❌ Failed to load system cost settings:', error);
            }
        });
        
        // Also enforce security when window loads to catch any late elements
        window.addEventListener('load', function() {
            // enforceSecurityOnLoad(); // Temporarily disabled
        });
    </script>

    </div> <!-- Close appContainer -->


</body>
</html> 