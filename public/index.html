<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Loan Calculator</title>
    <link rel="icon" type="image/x-icon" href="tIAMAT white blue-06.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuration is now loaded from config.js and database
        let CONFIG = {
            // Only essential fallback values remain
            ADMIN_PASSWORD: 'Gordzara!12'
        };

        try {
            // Try to load config.js
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onload = function() {
                // If config.js loads successfully, it will override the default CONFIG
            };
            script.onerror = function() {
                // config.js should always be available since it's included in git
            };
            document.head.appendChild(script);
        } catch (e) {
            // Silent fallback
        }

        function showConfigSetupMessage() {
            // No longer needed since config.js is included in git
            // This function is kept for backward compatibility but does nothing
        }
    </script>
    <style>
        .spoiler {
            cursor: pointer;
            user-select: none;
            background: linear-gradient(45deg, #333 25%, transparent 25%), 
                        linear-gradient(-45deg, #333 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #333 75%), 
                        linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 4px 4px;
            background-position: 0 0, 0 2px, 2px -2px, -2px 0px;
            color: transparent;
            transition: all 0.3s ease;
        }
        
        .spoiler:hover {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .spoiler-revealed {
            cursor: pointer;
            background: #f3f4f6;
            color: inherit;
            transition: all 0.3s ease;
        }
        
        .spoiler-revealed:hover {
            background: #e5e7eb;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tiamat-blue': '#0066CC',
                        'tiamat-light-blue': '#4A90E2',
                        'tiamat-dark-blue': '#004499',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 space-y-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <img src="tIAMAT white blue-06.ico" alt="Tiamat Logo" class="h-8 w-8">
                <h1 class="text-3xl font-bold text-tiamat-blue" data-en="Solar Loan Calculator" data-hy="‘±÷Ä÷á’°’µ’´’∂ ’Ø’°’µ’°’∂’´ ’æ’°÷Ä’Ø’´ ’∞’°’∑’æ’´’π">Solar Loan Calculator</h1>
            </div>
            
            <!-- Language Switcher -->
            <div class="flex items-center gap-2">
                <button onclick="switchLanguage('en')" id="langEn" class="px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white">EN</button>
                <button onclick="switchLanguage('hy')" id="langHy" class="px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 hidden" style="display: none !important; visibility: hidden;">’Ä‘±’Ö</button>
                
                </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Input Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4" data-en="System Configuration" data-hy="’Ä’°’¥’°’Ø’°÷Ä’£’´ ’Ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥">System Configuration</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="System Power (kW)" data-hy="’Ä’°’¥’°’Ø’°÷Ä’£’´ ’∞’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (’Ø’é’ø)">System Power (kW)</label>
                        <input type="number" id="systemPower" data-en-placeholder="Enter system power" data-hy-placeholder="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’∞’°’¥’°’Ø’°÷Ä’£’´ ’∞’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®" placeholder="Enter system power" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Installation Type" data-hy="’è’•’≤’°’§÷Ä’¥’°’∂ ’ø’•’Ω’°’Ø’®">Installation Type</label>
                        <select id="installationType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <option value="onRoof" data-en="On Roof" data-hy="’è’°’∂’´÷Ñ’´ ’æ÷Ä’° (’¨’°’∂’ª’°’µ’´’∂)">On Roof</option>
                            <option value="metalConstructionOnRoof" data-en="Metal Construction on Roof" data-hy="’Ñ’•’ø’°’≤’°’Ø’°’∂ ’Ø’∏’∂’Ω’ø÷Ä’∏÷Ç’Ø÷Å’´’° ’ø’°’∂’´÷Ñ’´ ’æ÷Ä’°">Metal Construction on Roof</option>
                            <option value="aluminiumConstructionOnRoof" data-en="Aluminium Construction on Roof" data-hy="‘±’¨’µ’∏÷Ç’¥’´’∂’• ’Ø’∏’∂’Ω’ø÷Ä’∏÷Ç’Ø÷Å’´’° ’ø’°’∂’´÷Ñ’´ ’æ÷Ä’°">Aluminium Construction on Roof</option>
                            <option value="systemOnGround" data-en="System on Ground" data-hy="’Ä’°’¥’°’Ø’°÷Ä’£ ’£’•’ø’∂’´ ’æ÷Ä’°">System on Ground</option>
                        </select>
                    </div>

                                    <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700" data-en="Inverter Selection:" data-hy="‘ª’∂’æ’•÷Ä’ø’∏÷Ä’´ ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂:">Inverter Selection:</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500" data-en="Auto" data-hy="‘±’æ’ø’∏">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="manualInverterToggle" class="sr-only peer" onchange="toggleInverterSelection()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-tiamat-blue/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tiamat-blue"></div>
                            </label>
                            <span class="text-xs text-gray-500" data-en="Manual" data-hy="’Å’•’º÷Ñ’∏’æ">Manual</span>
                        </div>
                    </div>
                    
                    <!-- Auto Selection (Default) -->
                    <div id="autoInverterSelection">
                        <select id="inverterSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <option value="auto" data-en="Auto Select (Recommended)" data-hy="‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥)">Auto Select (Recommended)</option>
                        </select>
                    </div>
                    
                    <!-- Manual Selection (Hidden by default) -->
                    <div id="manualInverterSelection" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label for="manualBrand" class="block text-xs font-medium text-gray-600 mb-1" data-en="Brand:" data-hy="‘≤÷Ä’•’∂’§:">Brand:</label>
                                <select id="manualBrand" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualModels()">
                                    <option value="" data-en="Select brand" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¢÷Ä’•’∂’§’®">Select brand</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualPower" class="block text-xs font-medium text-gray-600 mb-1" data-en="Power (kW):" data-hy="’Ä’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (’Ø’é’ø):">Power (kW):</label>
                                <select id="manualPower" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualModels()">
                                    <option value="" data-en="Select power" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’∞’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®">Select power</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualModel" class="block text-xs font-medium text-gray-600 mb-1" data-en="Model:" data-hy="’Ñ’∏’§’•’¨:">Model:</label>
                                <select id="manualModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualInverterInfo()">
                                    <option value="" data-en="Select model" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¥’∏’§’•’¨’®">Select model</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700" data-en="Selected Inverter:" data-hy="‘∏’∂’ø÷Ä’æ’°’Æ ’´’∂’æ’•÷Ä’ø’∏÷Ä’®:">Selected Inverter:</span>
                                <span id="manualInverterInfo" class="text-sm text-gray-500" data-en="None selected" data-hy="’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß">None selected</span>
                            </div>
                        </div>
                    </div>
                                </div>
                
                <!-- Panel Selection -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700" data-en="Panel Selection:" data-hy="’ä’°’∂’•’¨’∂’•÷Ä’´ ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂:">Panel Selection:</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500" data-en="Auto" data-hy="‘±’æ’ø’∏">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="manualPanelToggle" class="sr-only peer" onchange="togglePanelSelection()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-tiamat-blue/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tiamat-blue"></div>
                            </label>
                            <span class="text-xs text-gray-500" data-en="Manual" data-hy="’Å’•’º÷Ñ’∏’æ">Manual</span>
                        </div>
                    </div>
                    
                    <!-- Auto Selection (Default) -->
                    <div id="autoPanelSelection">
                        <select id="panelSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                            <option value="auto" data-en="Auto Select (Recommended)" data-hy="‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥)">Auto Select (Recommended)</option>
                        </select>
                    </div>
                    
                    <!-- Manual Selection (Hidden by default) -->
                    <div id="manualPanelSelection" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label for="manualPanelBrand" class="block text-xs font-medium text-gray-600 mb-1" data-en="Brand:" data-hy="‘≤÷Ä’•’∂’§:">Brand:</label>
                                <select id="manualPanelBrand" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualPanelModels()">
                                    <option value="" data-en="Select brand" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¢÷Ä’•’∂’§’®">Select brand</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualPanelWattage" class="block text-xs font-medium text-gray-600 mb-1" data-en="Wattage:" data-hy="’Ä’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (’é’ø):">Wattage:</label>
                                <select id="manualPanelWattage" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualPanelModels()">
                                    <option value="" data-en="Select wattage" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’∞’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®">Select wattage</option>
                                </select>
                            </div>
                            <div>
                                <label for="manualPanelModel" class="block text-xs font-medium text-gray-600 mb-1" data-en="Model:" data-hy="’Ñ’∏’§’•’¨:">Model:</label>
                                <select id="manualPanelModel" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onchange="updateManualPanelInfo()">
                                    <option value="" data-en="Select model" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¥’∏’§’•’¨’®">Select model</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700" data-en="Selected Panel:" data-hy="‘∏’∂’ø÷Ä’æ’°’Æ ’∫’°’∂’•’¨’®:">Selected Panel:</span>
                                <span id="manualPanelInfo" class="text-sm text-gray-500" data-en="None selected" data-hy="’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß">None selected</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Warranty Years" data-hy="‘µ÷Ä’°’∑’≠’´÷Ñ’°’µ’´’∂ ’ø’°÷Ä’´’∂’•÷Ä">Warranty Years</label>
                        <select id="warrantyYears" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="2" data-en="2 Years" data-hy="2 ’è’°÷Ä’´">2 Years</option>
                        <option value="3" data-en="3 Years" data-hy="3 ’è’°÷Ä’´">3 Years</option>
                        <option value="6" data-en="6 Years" data-hy="6 ’è’°÷Ä’´">6 Years</option>
                                                        <option value="12" data-en="12 Years" data-hy="12 ’è’°÷Ä’´" selected>12 Years</option>
                        </select>
                    
                    <!-- Current Profit per kW Display (Admin Only) - Will be created dynamically -->
                    <div id="profitPerKwDisplayContainer"></div>
                    </div>

                    <button id="calculateBtn" onclick="calculateLoan()" 
                            class="w-full bg-tiamat-blue hover:bg-tiamat-dark-blue text-white font-semibold py-2 px-4 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            data-en="Calculate Loan Options" data-hy="’Ä’°’∑’æ’°÷Ä’Ø’•’¨ ’æ’°÷Ä’Ø’´ ’ø’°÷Ä’¢’•÷Ä’°’Ø’∂’•÷Ä’®"
                            disabled>
                        Loading...
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4" data-en="Calculation Results" data-hy="’Ä’°’∑’æ’°÷Ä’Ø’´ ’°÷Ä’§’µ’∏÷Ç’∂÷Ñ’∂’•÷Ä’®">Calculation Results</h2>
                
                <div id="results" class="space-y-4">
                    <div class="text-center text-gray-500" data-en="Enter system parameters and click 'Calculate Loan Options' to see results" data-hy="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’∞’°’¥’°’Ø’°÷Ä’£’´ ’∫’°÷Ä’°’¥’•’ø÷Ä’•÷Ä’® ÷á ’Ω’•’≤’¥’•÷Ñ '’Ä’°’∑’æ’°÷Ä’Ø’•’¨ ’æ’°÷Ä’Ø’´ ’ø’°÷Ä’¢’•÷Ä’°’Ø’∂’•÷Ä’®' ’°÷Ä’§’µ’∏÷Ç’∂÷Ñ’∂’•÷Ä’® ’ø’•’Ω’∂’•’¨’∏÷Ç ’∞’°’¥’°÷Ä">
                        Enter system parameters and click "Calculate Loan Options" to see results
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanelMain" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-blue-600">üîê Admin Panel</h2>
                <button onclick="logoutAdmin()" class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400">Logout</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Configuration Details -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-lg text-blue-600">Configuration Details</h4>
                    <details class="space-y-3">
                        <summary class="cursor-pointer font-medium text-blue-600 hover:text-blue-800 transition-colors">Click to reveal sensitive information</summary>
                        <div class="mt-3 space-y-2 text-sm">
                            <p><strong>Admin Password:</strong> <span class="text-red-600">Hidden for security</span></p>
                            <p><strong>Database Connection:</strong> <span class="text-green-600">Connected to Supabase</span></p>
                            <p><strong>API Endpoints:</strong> <span class="text-blue-600">All endpoints working</span></p>
                            <p><strong>Tables:</strong> <span class="text-green-600">system_cost_settings, inverter_options, panel_options, bank_configurations</span></p>
                        </div>
                    </details>
                </div>
                
                <!-- Current Settings -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-lg text-blue-600">Current Settings</h4>
                    <div class="space-y-2 text-sm">
                                                 <div class="p-2 bg-white rounded">
                             <strong class="text-blue-600">Common Sales Team %:</strong> <span class="text-green-600 font-semibold" id="adminSalesTeamPct">Loading...</span>
                         </div>
                                                 <div class="p-2 bg-white rounded">
                             <strong class="text-blue-600">Common Unanticipated Expenses %:</strong> <span class="text-yellow-600 font-semibold" id="adminUnanticipatedExpensesPct">Loading...</span>
                         </div>
                         <div class="p-2 bg-white rounded text-xs text-gray-600">
                             <em>Note: Unanticipated expenses now use a single common percentage that applies to all installation types. Legacy installation-specific records have been deprecated.</em>
                         </div>
                        <div class="p-2 bg-white rounded text-xs text-gray-500 bg-gray-50">
                            <strong>Database Status:</strong> 1 active record (ID: 635), all deprecated records completely removed
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-lg text-blue-600">System Status</h4>
                    <div class="space-y-2 text-sm">
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Database:</strong> <span class="text-green-600 font-semibold">Connected</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">API Server:</strong> <span class="text-green-600 font-semibold">Running</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Frontend:</strong> <span class="text-green-600 font-semibold">Live Data</span>
                        </div>
                        <div class="p-2 bg-white rounded">
                            <strong class="text-blue-600">Last Updated:</strong> <span class="text-blue-600 font-semibold" id="adminLastUpdated"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Options Table -->
        <div id="loanTable" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Available Loan Options</h2>
            
            <!-- Filters and Sorting -->
            <div class="mb-4 flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700" data-en="Filter by Bank:" data-hy="‘∂’ø’•’¨ ’®’Ω’ø ’¢’°’∂’Ø’´:">Filter by Bank:</label>
                    <select id="bankFilter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="" data-en="All Banks" data-hy="‘≤’∏’¨’∏÷Ä ’¢’°’∂’Ø’•÷Ä’®">All Banks</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700" data-en="Filter by Period:" data-hy="‘∂’ø’•’¨ ’®’Ω’ø ’™’°’¥’Ø’•’ø’´:">Filter by Period:</label>
                    <select id="periodFilter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="" data-en="All Periods" data-hy="‘±’¥’¢’∏’≤’ª’®">All Periods</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700" data-en="Sort by:" data-hy="‘¥’°’Ω’°’æ’∏÷Ä’•’¨ ’®’Ω’ø:">Sort by:</label>
                    <select id="sortBy" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-tiamat-blue">
                        <option value="monthlyPayment" data-en="Monthly Payment (Low to High)" data-hy="‘±’¥’Ω’°’Ø’°’∂ ’æ’≥’°÷Ä (÷Å’°’Æ÷Ä’´÷Å ’¢’°÷Ä’±÷Ä)">Monthly Payment (Low to High)</option>
                        <option value="monthlyPaymentDesc" data-en="Monthly Payment (High to Low)" data-hy="‘±’¥’Ω’°’Ø’°’∂ ’æ’≥’°÷Ä (’¢’°÷Ä’±÷Ä’´÷Å ÷Å’°’Æ÷Ä)">Monthly Payment (High to Low)</option>
                        <option value="loanAmount" data-en="Loan Amount (Low to High)" data-hy="’é’°÷Ä’Ø’´ ’£’∏÷Ç’¥’°÷Ä (÷Å’°’Æ÷Ä’´÷Å ’¢’°÷Ä’±÷Ä)">Loan Amount (Low to High)</option>
                        <option value="loanAmountDesc" data-en="Loan Amount (High to Low)" data-hy="’é’°÷Ä’Ø’´ ’£’∏÷Ç’¥’°÷Ä (’¢’°÷Ä’±÷Ä’´÷Å ÷Å’°’Æ÷Ä)">Loan Amount (High to Low)</option>
                        <option value="totalAmount" data-en="Total Amount (Low to High)" data-hy="‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’£’∏÷Ç’¥’°÷Ä (÷Å’°’Æ÷Ä’´÷Å ’¢’°÷Ä’±÷Ä)">Total Amount (Low to High)</option>
                        <option value="totalAmountDesc" data-en="Total Amount (High to Low)" data-hy="‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’£’∏÷Ç’¥’°÷Ä (’¢’°÷Ä’±÷Ä’´÷Å ÷Å’°’Æ÷Ä)">Total Amount (High to Low)</option>
                        <option value="interestRate" data-en="Interest Rate (Low to High)" data-hy="’è’∏’Ø’∏’Ω’°’§÷Ä’∏÷Ç’µ÷Ñ (÷Å’°’Æ÷Ä’´÷Å ’¢’°÷Ä’±÷Ä)">Interest Rate (Low to High)</option>
                        <option value="interestRateDesc" data-en="Interest Rate (High to Low)" data-hy="’è’∏’Ø’∏’Ω’°’§÷Ä’∏÷Ç’µ÷Ñ (’¢’°÷Ä’±÷Ä’´÷Å ÷Å’°’Æ÷Ä)">Interest Rate (High to Low)</option>

                        <option value="loanPeriod" data-en="Loan Period (Low to High)" data-hy="’é’°÷Ä’Ø’´ ’™’°’¥’Ø’•’ø (÷Å’°’Æ÷Ä’´÷Å ’¢’°÷Ä’±÷Ä)">Loan Period (Low to High)</option>
                        <option value="loanPeriodDesc" data-en="Loan Period (High to Low)" data-hy="’é’°÷Ä’Ø’´ ’™’°’¥’Ø’•’ø (’¢’°÷Ä’±÷Ä’´÷Å ÷Å’°’Æ÷Ä)">Loan Period (High to Low)</option>
                    </select>
                </div>
                
                <button onclick="clearFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-sm transition-colors"
                        data-en="Clear Filters" data-hy="’Ñ’°÷Ñ÷Ä’•’¨ ’¶’ø’´’π’∂’•÷Ä’®">
                    Clear Filters
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border p-3 text-left font-medium cursor-pointer hover:bg-gray-100" onclick="sortTable('bankName')">
                                <span data-en="Bank" data-hy="‘≤’°’∂’Ø">Bank</span> <span id="bankSortIcon" class="ml-1">‚Üï</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-32 cursor-pointer hover:bg-gray-100" onclick="sortTable('loanPeriod')">
                                <span data-en="Loan Period" data-hy="’é’°÷Ä’Ø’´ ’™’°’¥’Ø’•’ø">Loan Period</span> <span id="periodSortIcon" class="ml-1">‚Üï</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-24 cursor-pointer hover:bg-gray-100" onclick="sortTable('interestRate')">
                                <span data-en="Interest Rate" data-hy="’è’∏’Ø’∏’Ω’°’§÷Ä’∏÷Ç’µ÷Ñ">Interest Rate</span> <span id="rateSortIcon" class="ml-1">‚Üï</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-24 cursor-pointer hover:bg-gray-100 admin-only" onclick="sortTable('commission')" style="display: none;">
                                <span data-en="Commission" data-hy="‘ø’∏’¥’´’Ω’´’°">Commission</span> <span id="commissionSortIcon" class="ml-1">‚Üï</span>
                            </th>

                            <th class="border p-3 text-center font-medium w-40 cursor-pointer hover:bg-gray-100" onclick="sortTable('loanAmount')">
                                <span data-en="Loan Amount" data-hy="’é’°÷Ä’Ø’´ ’£’∏÷Ç’¥’°÷Ä">Loan Amount</span> <span id="amountSortIcon" class="ml-1">‚Üï</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-36 cursor-pointer hover:bg-gray-100" onclick="sortTable('monthlyPayment')">
                                <span data-en="Monthly Payment" data-hy="‘±’¥’Ω’°’Ø’°’∂ ’æ’≥’°÷Ä">Monthly Payment</span> <span id="paymentSortIcon" class="ml-1">‚Üï</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-40 cursor-pointer hover:bg-gray-100" onclick="sortTable('totalInterest')">
                                <span data-en="Total Interest" data-hy="‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’ø’∏’Ø’∏’Ω">Total Interest</span> <span id="interestSortIcon" class="ml-1">‚Üï</span>
                            </th>
                            <th class="border p-3 text-center font-medium w-44 cursor-pointer hover:bg-gray-100" onclick="sortTable('totalAmount')">
                                <span data-en="Total Amount" data-hy="‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’£’∏÷Ç’¥’°÷Ä">Total Amount</span> <span id="totalSortIcon" class="ml-1">‚Üï</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="loanTableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-600">
                <span id="resultCount" data-en="Showing all results" data-hy="’ë’∏÷Ç÷Å’°’§÷Ä’æ’∏÷Ç’¥ ’•’∂ ’¢’∏’¨’∏÷Ä ’°÷Ä’§’µ’∏÷Ç’∂÷Ñ’∂’•÷Ä’®">Showing all results</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables for database values
        let dbBasePrices = {};
        let dbProfitMargins = {};
        let dbSalesCommissions = {};
        let dbUnanticipatedExpenses = {};
        let dbBanks = [];
        let dbInverters = [];
        let bankConfigurations = []; // Bank configurations for loan calculations
        let inverters = []; // Inverter list for system calculations
        let panels = []; // Panel list for system calculations
        let isDataLoaded = false; // Track if database data is fully loaded
        
        // Function to fetch system cost settings from database
        async function fetchSystemCostSettings() {
            try {
                // Initialize default values
                let commonExpensesPct = 2; // Default fallback for unanticipated expenses
                let commonSalesTeamPct = 6; // Default fallback for sales team commission
                
                const response = await fetch('http://localhost:3001/api/system-cost-settings');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {

                    // Extract installation costs
                    if (result.data.installationCosts && result.data.installationCosts.data) {
                        const costs = result.data.installationCosts.data;
                        
                        // Map database keys to frontend keys - no hardcoded fallbacks
                        dbBasePrices = {
                            onRoof: costs.cost_per_kw_on_roof?.value,
                            metalConstructionOnRoof: costs.cost_per_kw_metal_construction_on_roof?.value,
                            systemOnGround: costs.cost_per_kw_system_on_ground?.value,
                            aluminiumConstructionOnRoof: costs.cost_per_kw_aluminium_construction_on_roof?.value
                        };

                    }
                    
                                         // Extract profit margins - now warranty-based instead of installation-type-based
                     if (result.data.profitMargins && result.data.profitMargins.data) {
                         const profits = result.data.profitMargins.data;
                         
                         // Load warranty-based profit margins - no hardcoded fallbacks
                         dbProfitMargins = {
                             profit_per_kw_2Y: profits.profit_per_kw_2Y?.value,
                             profit_per_kw_3Y: profits.profit_per_kw_3Y?.value,
                             profit_per_kw_6Y: profits.profit_per_kw_6Y?.value,
                             profit_per_kw_12Y: profits.profit_per_kw_12Y?.value
                         };

                     }
                    
                    // Extract sales commissions - now using common percentage for all installation types
                    // Look for sales_team_pct record in any category
                    if (result.data.salesCommissions && result.data.salesCommissions.data) {
                        const commissions = result.data.salesCommissions.data;
                        
                        if (commissions.sales_team_pct && commissions.sales_team_pct.value > 0) {
                            commonSalesTeamPct = commissions.sales_team_pct.value;

                        }
                    }
                    
                    // Also check unanticipatedExpenses section in case it's categorized there
                    if (result.data.unanticipatedExpenses && result.data.unanticipatedExpenses.data) {
                        const expenses = result.data.unanticipatedExpenses.data;
                        
                        if (expenses.sales_team_pct && expenses.sales_team_pct.value > 0) {
                            commonSalesTeamPct = expenses.sales_team_pct.value;

                        }
                    }
                    
                    // Apply common percentage to all installation types
                    dbSalesCommissions = {
                        onRoof: commonSalesTeamPct / 100,
                        metalConstructionOnRoof: commonSalesTeamPct / 100,
                        systemOnGround: commonSalesTeamPct / 100,
                        aluminiumConstructionOnRoof: commonSalesTeamPct / 100
                    };

                                         // Update admin panel with actual database values
                     const adminSalesTeamPct = document.getElementById('adminSalesTeamPct');
                     if (adminSalesTeamPct) {
                         adminSalesTeamPct.textContent = commonSalesTeamPct + '% (Common for all installation types)';
                     }
                     
                     // Update unanticipated expenses display in admin panel
                     const adminUnanticipatedExpensesPct = document.getElementById('adminUnanticipatedExpensesPct');
                     if (adminUnanticipatedExpensesPct) {
                         adminUnanticipatedExpensesPct.textContent = commonExpensesPct + '% (Common for all installation types)';
                     }
                    
                    // Extract unanticipated expenses - now single common value for all installation types
                    if (result.data.unanticipatedExpenses && result.data.unanticipatedExpenses.data) {
                        const expenses = result.data.unanticipatedExpenses.data;
                        
                        // Look for the active common record - now using the new key name
                        if (expenses.unanticipated_expenses_pct && expenses.unanticipated_expenses_pct.value > 0) {
                            commonExpensesPct = expenses.unanticipated_expenses_pct.value;

                        } else {
                            // Fallback: scan all records for active ones
                            for (const [key, record] of Object.entries(expenses)) {
                                if (record.description && !record.description.includes('DEPRECATED') && record.value > 0) {
                                    commonExpensesPct = record.value;

                                    break;
                                }
                            }
                        }
                        
                        // Apply common percentage to all installation types
                        dbUnanticipatedExpenses = {
                            onRoof: commonExpensesPct / 100,
                            metalConstructionOnRoof: commonExpensesPct / 100,
                            systemOnGround: commonExpensesPct / 100,
                            aluminiumConstructionOnRoof: commonExpensesPct / 100
                        };

                    }

                    // Load banks and inverters from their respective endpoints
                    await Promise.all([
                        fetch('http://localhost:3001/api/banks')
                            .then(response => response.json())
                            .then(result => {
                                if (result.success && result.data && result.data.banks) {
                                    dbBanks = result.data.banks;
                                    bankConfigurations = result.data.banks; // Update the variable used by the loan calculation

                                }
                            })
                            .catch(error => {}),
                        
                        fetch('http://localhost:3001/api/inverters')
                            .then(response => response.json())
                            .then(result => {
                                if (result.success && result.data && result.data.inverters) {
                                    dbInverters = result.data.inverters;
                                    inverters = result.data.inverters; // Update the variable used by the loan calculation
                                }
                            })
                            .catch(error => {}),
                        
                        fetch('http://localhost:3001/api/panels')
                            .then(response => response.json())
                            .then(result => {
                                if (result.success && result.data && result.data.panels) {
                                    panels = result.data.panels; // Update the variable used by the loan calculation
                                }
                            })
                            .catch(error => {})
                    ]);
                    
                    // Mark data as loaded
                    isDataLoaded = true;
                    
                    // Enable calculate button
                    const calculateBtn = document.getElementById('calculateBtn');
                    if (calculateBtn) {
                        const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                        calculateBtn.disabled = false;
                        calculateBtn.textContent = currentLanguage === 'en' ? 'Calculate Loan Options' : '’Ä’°’∑’æ’°÷Ä’Ø’•’¨ ’æ’°÷Ä’Ø’´ ’ø’°÷Ä’¢’•÷Ä’°’Ø’∂’•÷Ä’®';
                    }
                    
                    // Pre-populate manual selection dropdowns for immediate use
                    populateManualBrands();
                    populateManualPowers();
                    
                    // Pre-populate manual panel selection dropdowns
                    populateManualPanelBrands();
                    populateManualPanelWattages();
                    
                    // Update the main inverter dropdown with new data
                    populateInverterDropdown();
                    
                    // Update the main panel dropdown with new data
                    populatePanelDropdown();
                }
            } catch (error) {
                // Silent error handling - show user-friendly message instead
            }
        }

        function calculateLoanPayment(principal, annualRate, months) {
            const monthlyRate = annualRate / 12;
            if (monthlyRate === 0) return principal / months;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        }

        // Base prices per kW (without inverter) - will be loaded from database

        function calculateLoan() {
            // Check if database data is loaded
            if (!isDataLoaded) {
                const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                const message = currentLanguage === 'en' 
                    ? 'Please wait, database data is still loading...'
                    : '‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ω’∫’°’Ω’•’¨, ’ø’æ’µ’°’¨’∂’•÷Ä’´ ’¢’°’¶’°’µ’´ ’ø’æ’µ’°’¨’∂’•÷Ä’® ’§’•’º ’¢’•’º’∂’æ’∏÷Ç’¥ ’•’∂...';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Check if bank configurations are loaded and have data
            if (!bankConfigurations || bankConfigurations.length === 0) {
                const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                const message = currentLanguage === 'en' 
                    ? 'Bank configurations not loaded. Please refresh the page and try again.'
                    : '‘≤’°’∂’Ø’´ ’Ø’∏’∂÷Ü’´’£’∏÷Ç÷Ä’°÷Å’´’°’∂’•÷Ä’® ’¢’•’º’∂’æ’°’Æ ’π’•’∂: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’©’°÷Ä’¥’°÷Å’∂’•’¨ ’ß’ª’® ÷á ’Ø÷Ä’Ø’´’∂ ÷É’∏÷Ä’±’•’¨:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-red-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Get input values
            const systemPower = parseFloat(document.getElementById('systemPower').value);
            const installationType = document.getElementById('installationType').value;

            if (!systemPower) {
                alert('Please enter system power');
                return;
            }

            // Get base price per kW (without inverter) - prefer database values
                        let basePricePerKw = dbBasePrices[installationType];
            
            if (!basePricePerKw) {
                const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                const message = currentLanguage === 'en' 
                    ? `Base price not found for installation type: ${installationType}. Please check database configuration.`
                    : `${installationType} ’ø’•’≤’°’§÷Ä’¥’°’∂ ’ø’´’∫’´ ’∞’°’¥’°÷Ä ’¢’°’¶’°’µ’´’∂ ’£’´’∂’® ’π’´ ’£’ø’∂’æ’•’¨: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ω’ø’∏÷Ç’£’•’¨ ’ø’æ’µ’°’¨’∂’•÷Ä’´ ’¢’°’¶’°’µ’´ ’Ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä’®:`;
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-red-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Get warranty years and determine profit per kW - profit is warranty-based, not installation-type-based
             const warrantyYears = parseInt(document.getElementById('warrantyYears').value) || 12;
             
             // Map warranty years to database keys
             let dbKey;
             if (warrantyYears === 2) dbKey = 'profit_per_kw_2Y';
             else if (warrantyYears === 3) dbKey = 'profit_per_kw_3Y';
             else if (warrantyYears === 6) dbKey = 'profit_per_kw_6Y';
             else if (warrantyYears === 12) dbKey = 'profit_per_kw_12Y';
             else dbKey = 'profit_per_kw_12Y'; // Default to 12Y
             
                          const profitPerKw = dbProfitMargins[dbKey];
             
             if (!profitPerKw) {
                 const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                 const message = currentLanguage === 'en' 
                     ? `Profit value not found for ${warrantyYears}-year warranty. Please check database configuration.`
                     : `${warrantyYears}-’ø’°÷Ä’µ’° ’•÷Ä’°’∑’≠’´÷Ñ’´ ’∞’°’¥’°÷Ä ’∑’°’∞’∏÷Ç’µ’©’´ ’°÷Ä’™’•÷Ñ’® ’π’´ ’£’ø’∂’æ’•’¨: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ω’ø’∏÷Ç’£’•’¨ ’ø’æ’µ’°’¨’∂’•÷Ä’´ ’¢’°’¶’°’µ’´ ’Ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä’®:`;
                 
                 document.getElementById('results').innerHTML = `
                     <div class="space-y-3">
                         <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                             <div class="flex items-center">
                                 <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                     <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                 </svg>
                                 <span class="text-red-800 font-medium">${message}</span>
                             </div>
                         </div>
                     </div>
                 `;
                 return;
             }
             
             const basePrice = Math.ceil(systemPower * basePricePerKw);
            const profitAmount = Math.ceil(systemPower * profitPerKw);

            // Check if system is larger than 110 kW
            if (systemPower > 110) {
                const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                const message = currentLanguage === 'en' 
                    ? 'System size exceeds 110 kW. Please contact upper management for pricing.'
                    : '’Ä’°’¥’°’Ø’°÷Ä’£’´ ’π’°÷É’® ’£’•÷Ä’°’¶’°’∂÷Å’∏÷Ç’¥ ’ß 110 ’Ø’é’ø-’®: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ø’°’∫ ’∞’°’Ω’ø’°’ø’•’¨ ’æ’°’≥’°’º÷Ñ’´ ’¢’°’™’∂’´ ’∞’•’ø ’£’∂’°’£’∏’µ’°÷Å’¥’°’∂ ’∞’°’¥’°÷Ä:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get selected inverter
            let selectedInverter = null;
            
            // Check if manual mode is enabled
            const isManualMode = document.getElementById('manualInverterToggle').checked;
            
            if (isManualMode) {
                // Manual selection mode
                const selectedModelId = document.getElementById('manualModel').value;
                if (!selectedModelId) {
                    const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                    const message = currentLanguage === 'en' 
                        ? 'Please select an inverter model in manual mode.'
                        : '‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’®’∂’ø÷Ä’•’¨ ’´’∂’æ’•÷Ä’ø’∏÷Ä’´ ’¥’∏’§’•’¨’® ’±’•’º÷Ñ’∏’æ ’º’•’™’´’¥’∏÷Ç’¥:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                selectedInverter = inverters.find(inv => inv.id == selectedModelId);
                if (!selectedInverter) {
                    const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                    const message = currentLanguage === 'en' 
                        ? 'Selected inverter not found!'
                        : '‘∏’∂’ø÷Ä’æ’°’Æ ’´’∂’æ’•÷Ä’ø’∏÷Ä’® ’π’´ ’£’ø’∂’æ’•’¨:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
            }

            // Check if manual panel mode is enabled and validate required fields
            let isManualPanelMode = document.getElementById('manualPanelToggle').checked;
            if (isManualPanelMode) {
                const selectedPanelBrand = document.getElementById('manualPanelBrand').value;
                const selectedPanelWattage = document.getElementById('manualPanelWattage').value;
                const selectedPanelModel = document.getElementById('manualPanelModel').value;
                
                if (!selectedPanelBrand || !selectedPanelWattage || !selectedPanelModel) {
                    const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                    const message = currentLanguage === 'en' 
                        ? 'In manual panel mode, Brand, Wattage, and Model are all mandatory. Please select all three fields before calculating.'
                        : '’Å’•’º÷Ñ’∏’æ ’∫’°’∂’•’¨’´ ’º’•’™’´’¥’∏÷Ç’¥ ‘≤÷Ä’•’∂’§’®, ’Ä’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’® ÷á ’Ñ’∏’§’•’¨’® ’∫’°÷Ä’ø’°’§’´÷Ä ’•’∂: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’®’∂’ø÷Ä’•’¨ ’¢’∏’¨’∏÷Ä ’•÷Ä’•÷Ñ ’§’°’∑’ø’•÷Ä’® ’∞’°’∑’æ’°÷Ä’Ø’´÷Å ’°’º’°’ª:';
                    
                    document.getElementById('results').innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <span class="w-5 h-5 text-red-400 mr-2 text-xl font-bold">‚úï</span>
                                    <span class="text-red-800 font-medium">${message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
            }

            } else {
                // Auto selection mode
                const selectedInverterKw = document.getElementById('inverterSelect').value;
                
                if (selectedInverterKw === 'auto') {
                    // Auto select: smallest inverter where inverter.kw * 1.15 >= systemPower
                    for (let i = 0; i < inverters.length; i++) {
                        if (inverters[i].kw * 1.15 >= systemPower) {
                            selectedInverter = inverters[i];
                            break;
                        }
                    }
                    if (!selectedInverter) {
                        const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                        const message = currentLanguage === 'en' 
                            ? 'No suitable inverter found for this system size!'
                            : '‘±’µ’Ω ’∞’°’¥’°’Ø’°÷Ä’£’´ ’π’°÷É’´ ’∞’°’¥’°÷Ä ’∞’°÷Ä’¥’°÷Ä ’´’∂’æ’•÷Ä’ø’∏÷Ä ’π’´ ’£’ø’∂’æ’•’¨:';
                        
                        document.getElementById('results').innerHTML = `
                            <div class="space-y-3">
                                <div class="space-y-3">
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <div class="flex items-center">
                                            <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="text-red-800 font-medium">${message}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        return;
                    }
                } else {
                    // Manual selection from auto dropdown
                    selectedInverter = inverters.find(inv => inv.kw == selectedInverterKw);
                    if (!selectedInverter) {
                        const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                        const message = currentLanguage === 'en' 
                            ? 'Selected inverter not found!'
                            : '‘∏’∂’ø÷Ä’æ’°’Æ ’´’∂’æ’•÷Ä’ø’∏÷Ä’® ’π’´ ’£’ø’∂’æ’•’¨:';
                        
                        document.getElementById('results').innerHTML = `
                            <div class="space-y-3">
                                <div class="bg-red-500 border border-red-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-red-800 font-medium">${message}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        return;
                    }
                }
            }
            
            const inverterPrice = selectedInverter.price;
            const inverterKw = selectedInverter.kw;

                        // Calculate total system price including sales team and unexpected expenses - database values only
            const salesTeamPct = dbSalesCommissions.onRoof;
            const unanticipatedExpensesPct = dbUnanticipatedExpenses.onRoof;
            
            if (!salesTeamPct || !unanticipatedExpensesPct) {
                const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                const message = currentLanguage === 'en' 
                    ? 'Sales team percentage or unanticipated expenses percentage not found. Please check database configuration.'
                    : '’é’°’≥’°’º÷Ñ’´ ’©’´’¥’´ ’ø’∏’Ø’∏’Ω’® ’Ø’°’¥ ’°’∂’Ω’∫’°’Ω’•’¨’´ ’Æ’°’≠’Ω’•÷Ä’´ ’ø’∏’Ø’∏’Ω’® ’π’´ ’£’ø’∂’æ’•’¨: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ω’ø’∏÷Ç’£’•’¨ ’ø’æ’µ’°’¨’∂’•÷Ä’´ ’¢’°’¶’°’µ’´ ’Ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä’®:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 0 11-16 0 8 8 0 0 1 16 0zm-7 4a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-red-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Total system price including sales team and unexpected expenses
            const totalSystemPrice = Math.ceil((basePrice + profitAmount + inverterPrice) / (1 - salesTeamPct - unanticipatedExpensesPct));

            // Display results
            const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
            const systemValueText = currentLanguage === 'en' ? 'System Value for Cash:' : '‘ø’°’∂’≠’´’Ø ’æ’°’≥’°’º÷Ñ’´ ’£’´’∂:';
            const breakdownTitle = currentLanguage === 'en' ? 'Calculation Breakdown:' : '’Ä’°’∑’æ’°÷Ä’Ø’´ ’¥’°’∂÷Ä’°’¥’°’Ω’∂’•÷Ä’®:';
            const basePriceText = currentLanguage === 'en' ? 'Base Price (no inverter):' : '‘≤’°’¶’°’µ’´’∂ ’£’´’∂ (’°’º’°’∂÷Å ’´’∂’æ’•÷Ä’ø’∏÷Ä’´):';
            const profitText = currentLanguage === 'en' ? `Profit (${profitPerKw.toLocaleString()} per kW):` : `’á’°’∞’∏÷Ç’µ’© (${profitPerKw.toLocaleString()} ’Ø’é’ø-’´ ’∞’°’¥’°÷Ä):`;
            const inverterPriceText = currentLanguage === 'en' ? 'Inverter Price:' : '‘ª’∂’æ’•÷Ä’ø’∏÷Ä’´ ’£’´’∂:';
            const subtotalText = currentLanguage === 'en' ? 'Subtotal (Base + Profit + Inverter):' : '‘µ’∂’©’°’£’∏÷Ç’¥’°÷Ä (‘≤’°’¶’°’µ’´’∂ + ’á’°’∞’∏÷Ç’µ’© + ‘ª’∂’æ’•÷Ä’ø’∏÷Ä):';
            const salesTeamText = currentLanguage === 'en' ? `Sales Team (${(salesTeamPct * 100).toFixed(1)}%):` : `’é’°’≥’°’º÷Ñ’´ ’©’´’¥ (${(salesTeamPct * 100).toFixed(1)}%):`;
                         const unexpectedExpensesText = currentLanguage === 'en' ? `Unanticipated Expenses (${(unanticipatedExpensesPct * 100).toFixed(1)}%):` : `‘±’∂’Ω’∫’°’Ω’•’¨’´ ’Æ’°’≠’Ω’•÷Ä (${(unanticipatedExpensesPct * 100).toFixed(1)}%):`;
            
            const basePriceWithProfitAndInverter = basePrice + profitAmount + inverterPrice;
            const salesTeamAmount = Math.ceil(totalSystemPrice * salesTeamPct);
            const unexpectedExpensesAmount = Math.ceil(totalSystemPrice * unanticipatedExpensesPct);
            
            const selectedInverterText = currentLanguage === 'en' ? 'Selected Inverter:' : '‘∏’∂’ø÷Ä’æ’°’Æ ’´’∂’æ’•÷Ä’ø’∏÷Ä:';
            
            // Show detailed breakdown for admin, simple view for regular users
            if (isAdminLoggedIn) {
                // Calculate percentages for display
                const basePricePct = ((basePrice / totalSystemPrice) * 100).toFixed(1);
                const profitPct = ((profitAmount / totalSystemPrice) * 100).toFixed(1);
                const inverterPct = ((inverterPrice / totalSystemPrice) * 100).toFixed(1);
                const salesTeamPctDisplay = (salesTeamPct * 100).toFixed(1);
                const unexpectedExpensesPctDisplay = (unanticipatedExpensesPct * 100).toFixed(1);
                
                // Get installation type name for display
                const installationTypeNames = {
                    'aluminiumConstructionOnRoof': currentLanguage === 'en' ? 'Aluminium Construction on Roof' : '‘±’¨’µ’∏÷Ç’¥’´’∂’• ’Ø’∏’∂’Ω’ø÷Ä’∏÷Ç’Ø÷Å’´’° ’ø’°’∂’´÷Ñ’´ ’æ÷Ä’°',
                    'metalConstructionOnRoof': currentLanguage === 'en' ? 'Metal Construction on Roof' : '’Ñ’•’ø’°’≤’°’Ø’°’∂ ’Ø’∏’∂’Ω’ø÷Ä’∏÷Ç’Ø÷Å’´’° ’ø’°’∂’´÷Ñ’´ ’æ÷Ä’°',
                    'onRoof': currentLanguage === 'en' ? 'On Roof (Sloped)' : '’è’°’∂’´÷Ñ’´ ’æ÷Ä’° (’¨’°’∂’ª’°’µ’´’∂)',
                    'systemOnGround': currentLanguage === 'en' ? 'System on Ground' : '’Ä’°’¥’°’Ø’°÷Ä’£ ’£’•’ø’∂’´ ’æ÷Ä’°'
                };
                const installationTypeName = installationTypeNames[installationType] || installationType;
            
            document.getElementById('results').innerHTML = `
                    <div class="space-y-4">
                    <div class="flex justify-between">
                            <span class="font-medium text-lg">${systemValueText}</span>
                            <span class="text-green-600 font-semibold text-lg">${totalSystemPrice.toLocaleString()} AMD</span>
                    </div>
                        
                        <div class="bg-gray-50 p-4 rounded-md space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">${breakdownTitle}</h4>
                            
                            <!-- Step 1: Base Price -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 1: Base Price Calculation</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Installation Type:</span>
                                        <span>${installationTypeName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Base Price per kW:</span>
                                        <span class="font-mono">${basePricePerKw.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>System Power:</span>
                                        <span>${systemPower} kW</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Base Price:</span>
                                        <span class="font-mono">${basePrice.toLocaleString()} AMD (${basePricePct}%)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Profit -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 2: Profit Calculation</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Warranty Period:</span>
                                        <span>${warrantyYears} years</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Profit per kW:</span>
                                        <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="${profitPerKw.toLocaleString()} AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Total Profit:</span>
                                        <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="${profitAmount.toLocaleString()} AMD (${profitPct}%)">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Inverter -->
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-700">Step 3: Inverter Selection</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Selected Inverter:</span>
                                        <span>${inverterKw} kW</span>
                                    </div>
                                    <div class="flex justify-between font-medium">
                                        <span>Inverter Price:</span>
                                        <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="${inverterPrice.toLocaleString()} AMD (${inverterPct}%)">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 4: Subtotal -->
                            <div class="space-y-2 border-t pt-3">
                                <div class="text-sm font-medium text-gray-700">Step 4: Subtotal</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Base Price:</span>
                                        <span class="font-mono">${basePrice.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>+ Profit:</span>
                                        <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="${profitAmount.toLocaleString()} AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>+ Inverter:</span>
                                        <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="${inverterPrice.toLocaleString()} AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                    </div>
                                    <div class="flex justify-between font-semibold border-t pt-1">
                                        <span>Subtotal:</span>
                                        <span class="font-mono">${basePriceWithProfitAndInverter.toLocaleString()} AMD</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 5: Final Calculation -->
                            <div class="space-y-2 border-t pt-3">
                                <div class="text-sm font-medium text-gray-700">Step 5: Final Price Calculation</div>
                                <div class="pl-4 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Subtotal:</span>
                                        <span class="font-mono">${basePriceWithProfitAndInverter.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>√∑ (1 - Sales Team ${salesTeamPctDisplay}% - Unexpected ${unexpectedExpensesPctDisplay}%):</span>
                                        <span class="font-mono">√∑ 0.92</span>
                                    </div>
                                    <div class="flex justify-between text-blue-600">
                                        <span>Sales Team (${salesTeamPctDisplay}%):</span>
                                        <span class="font-mono">${salesTeamAmount.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between text-orange-600">
                                        <span>Unexpected Expenses (${unexpectedExpensesPctDisplay}%):</span>
                                        <span class="font-mono">${unexpectedExpensesAmount.toLocaleString()} AMD</span>
                                    </div>
                                    <div class="flex justify-between font-semibold text-green-600 border-t pt-1">
                                        <span>Final System Value:</span>
                                        <span class="font-mono">${totalSystemPrice.toLocaleString()} AMD</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${selectedInverterText}</span>
                            <span>${inverterKw} kW</span>
                    </div>
                </div>
            `;
            } else {
            document.getElementById('results').innerHTML = `
                    <div class="space-y-4">
                    <div class="flex justify-between">
                            <span class="font-medium text-lg">${systemValueText}</span>
                            <span class="text-green-600 font-semibold text-lg">${totalSystemPrice.toLocaleString()} AMD</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${selectedInverterText}</span>
                            <span>${inverterKw} kW</span>
                    </div>
                </div>
            `;
            }

            // Calculate loan options
            // Check if database values are loaded
            if (!bankConfigurations || bankConfigurations.length === 0) {
                const currentLanguage = localStorage.getItem('loanCalculatorLanguage') || 'en';
                const message = currentLanguage === 'en' 
                    ? 'Bank configurations not loaded yet. Please wait a moment and try again.'
                    : '‘≤’°’∂’Ø’´ ’Ø’∏’∂÷Ü’´’£’∏÷Ç÷Ä’°÷Å’´’°’∂’•÷Ä’® ’§’•’º ’¢’•’º’∂’æ’°’Æ ’π’•’∂: ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ω’∫’°’Ω’•’¨ ’¥’´ ’∫’°’∞ ÷á ’∂’∏÷Ä’´÷Å ÷É’∏÷Ä’±’•’¨:';
                
                document.getElementById('results').innerHTML = `
                    <div class="space-y3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-yellow-800 font-medium">${message}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const loanOptions = [];
            
            bankConfigurations.forEach(bank => {
                bank.options.forEach(option => {
                    option.periods.forEach(period => {
                        // Calculate loan amount with commission
                        const totalPercentage = option.commission;
                        const loanAmountWithCommission = Math.ceil(totalSystemPrice / (1 - totalPercentage));
                        
                        // Calculate actual loan amount (after down payment)
                        const actualLoanAmount = loanAmountWithCommission - 0; // No down payment for now
                        
                        // Calculate monthly payment
                        const monthlyPayment = Math.ceil(calculateLoanPayment(actualLoanAmount, option.interestRate, period));
                        const totalInterest = (monthlyPayment * period) - actualLoanAmount;
                        const totalAmount = monthlyPayment * period;
                        
                        loanOptions.push({
                            bankName: bank.name,
                            interestRate: option.interestRate,
                            commission: option.commission,
                            loanPeriod: period,
                            monthlyPayment: monthlyPayment,
                            totalInterest: totalInterest,
                            totalAmount: totalAmount,
                            loanAmount: actualLoanAmount
                        });
                    });
                });
            });

            // Store all options globally and sort by monthly payment
            allLoanOptions = loanOptions.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
            
            // Populate filter dropdowns
            populateFilters();
            
            // Display all options initially
            displayLoanOptions(allLoanOptions);
            updateResultCount(allLoanOptions.length);
            
            // Set initial sort state
            currentSortField = 'monthlyPayment';
            currentSortDirection = 'asc';
            updateSortIcons('monthlyPayment', 'asc');

            document.getElementById('loanTable').classList.remove('hidden');
        }

        // Global variables for filtering and sorting
        let allLoanOptions = [];
        let currentSortField = '';
        let currentSortDirection = 'asc';
        let currentLanguage = 'en';

        // Language switching function
        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Save language preference to localStorage
            localStorage.setItem('loanCalculatorLanguage', lang);
            
            // Update language buttons
            document.getElementById('langEn').className = lang === 'en' 
                ? 'px-3 py-1 rounded-md text-sm font-medium bg-tiamat-blue text-white'
                : 'px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
            
            // Keep Armenian button always hidden
            document.getElementById('langHy').className = 'px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 hidden';
            document.getElementById('langHy').style.display = 'none';
            document.getElementById('langHy').style.visibility = 'hidden';
            
            // Update all elements with data attributes
            document.querySelectorAll('[data-en][data-hy]').forEach(element => {
                element.textContent = element.getAttribute(`data-${lang}`);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-en-placeholder][data-hy-placeholder]').forEach(element => {
                element.placeholder = element.getAttribute(`data-${lang}-placeholder`);
            });
            
            // Update select options
            document.querySelectorAll('option[data-en][data-hy]').forEach(option => {
                option.textContent = option.getAttribute(`data-${lang}`);
            });
            
            // Update result count if it exists
            const resultCount = document.getElementById('resultCount');
            if (resultCount && allLoanOptions.length > 0) {
                updateResultCount(allLoanOptions.length);
            }
            
            // Recalculate and display results if they exist
            if (allLoanOptions.length > 0) {
                calculateLoan();
            }
            
            // Update inverter dropdown language
            populateInverterDropdown();
        }

        // Populate inverter dropdown
        function populateInverterDropdown() {
            // Check if inverters are loaded
            if (!inverters || inverters.length === 0) {
                
                return;
            }
            
            const inverterSelect = document.getElementById('inverterSelect');
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            inverterSelect.innerHTML = '';
            
            // Find the auto-selected inverter (inverter that can handle system power without overload)
            let autoSelectedInverter = null;
            const minPower = systemPower / 1.15; // Inverter must be able to handle system power
            
            for (let i = 0; i < inverters.length; i++) {
                if (inverters[i].kw >= minPower) {
                    autoSelectedInverter = inverters[i];
                    break;
                }
                }
            
            // Filter and add suitable inverters (inverters that can handle the system power)
            const suitableInverters = inverters
                .filter(inverter => inverter.kw >= minPower)
                .sort((a, b) => a.kw - b.kw);
            
            suitableInverters.forEach(inverter => {
                const option = document.createElement('option');
                option.value = inverter.kw;
                const text = currentLanguage === 'en' 
                    ? `${inverter.brand} ${inverter.model} - ${inverter.kw} kW (${inverter.price.toLocaleString()} AMD)`
                    : `${inverter.brand} ${inverter.model} - ${inverter.kw} ’Ø’é’ø (${inverter.price.toLocaleString()} AMD)`;
                option.textContent = text;
                option.setAttribute('data-en', `${inverter.brand} ${inverter.model} - ${inverter.kw} kW (${inverter.price.toLocaleString()} AMD)`);
                option.setAttribute('data-hy', `${inverter.brand} ${inverter.model} - ${inverter.kw} ’Ø’é’ø (${inverter.price.toLocaleString()} AMD)`);
                inverterSelect.appendChild(option);
            });
            
            // Add auto-select option at the end (with auto-selected inverter info)
            const autoOption = document.createElement('option');
            autoOption.value = 'auto';
            if (autoSelectedInverter) {
                const text = currentLanguage === 'en' 
                    ? `Auto Select (Recommended): ${autoSelectedInverter.model} ${autoSelectedInverter.kw} kW`
                    : `‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥): ${autoSelectedInverter.model} ${autoSelectedInverter.kw} ’Ø’é’ø`;
                autoOption.textContent = text;
                autoOption.setAttribute('data-en', `Auto Select (Recommended): ${autoSelectedInverter.model} ${autoSelectedInverter.kw} kW`);
                autoOption.setAttribute('data-hy', `‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥): ${autoSelectedInverter.model} ${autoSelectedInverter.kw} ’Ø’é’ø`);
            } else {
                const text = currentLanguage === 'en' 
                    ? 'Auto Select (Recommended)'
                    : '‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥)';
                autoOption.textContent = text;
                autoOption.setAttribute('data-en', 'Auto Select (Recommended)');
                autoOption.setAttribute('data-hy', '‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥)');
            }
            inverterSelect.appendChild(autoOption);
            
            // Set auto-select as default selected option
            inverterSelect.value = 'auto';
        }

        // Populate panel dropdown
        function populatePanelDropdown() {
            // Check if panels are loaded
            if (!panels || panels.length === 0) {
                
                return;
            }
            
            const panelSelect = document.getElementById('panelSelect');
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            panelSelect.innerHTML = '';
            
            // Find the auto-selected panel (panel that can provide the required system power)
            let autoSelectedPanel = null;
            const requiredWattage = systemPower * 1000; // Convert kW to W
            
            // Find the most suitable panel (closest to required wattage without being too small)
            const suitablePanels = panels
                .filter(panel => panel.wattage >= requiredWattage * 0.8) // Panel should be at least 80% of required wattage
                .sort((a, b) => a.wattage - b.wattage);
            
            if (suitablePanels.length > 0) {
                autoSelectedPanel = suitablePanels[0]; // Use the smallest suitable panel
            }
            
            // Filter and add suitable panels
            suitablePanels.forEach(panel => {
                const option = document.createElement('option');
                option.value = panel.id;
                const text = currentLanguage === 'en' 
                    ? `${panel.brand} ${panel.model} - ${panel.wattage}W (${panel.price.toLocaleString()} AMD)`
                    : `${panel.brand} ${panel.model} - ${panel.wattage}’é’ø (${panel.price.toLocaleString()} AMD)`;
                option.textContent = text;
                option.setAttribute('data-en', `${panel.brand} ${panel.model} - ${panel.wattage}W (${panel.price.toLocaleString()} AMD)`);
                option.setAttribute('data-hy', `${panel.brand} ${panel.model} - ${panel.wattage}’é’ø (${panel.price.toLocaleString()} AMD)`);
                panelSelect.appendChild(option);
            });
            
            // Add auto-select option at the end (with auto-selected panel info)
            const autoOption = document.createElement('option');
            autoOption.value = 'auto';
            if (autoSelectedPanel) {
                const text = currentLanguage === 'en' 
                    ? `Auto Select (Recommended): ${autoSelectedPanel.brand} ${autoSelectedPanel.model} ${autoSelectedPanel.wattage}W`
                    : `‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥): ${autoSelectedPanel.model} ${autoSelectedPanel.wattage}’é’ø`;
                autoOption.textContent = text;
                autoOption.setAttribute('data-en', `Auto Select (Recommended): ${autoSelectedPanel.brand} ${autoSelectedPanel.model} ${autoSelectedPanel.wattage}W`);
                autoOption.setAttribute('data-hy', `‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥): ${autoSelectedPanel.brand} ${autoSelectedPanel.model} ${autoSelectedPanel.wattage}’é’ø`);
            } else {
                const text = currentLanguage === 'en' 
                    ? 'Auto Select (Recommended)'
                    : '‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥)';
                autoOption.textContent = text;
                autoOption.setAttribute('data-en', 'Auto Select (Recommended)');
                autoOption.setAttribute('data-hy', '‘±’æ’ø’∏’¥’°’ø ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (‘Ω’∏÷Ä’∞’∏÷Ç÷Ä’§ ’ß ’ø÷Ä’æ’∏÷Ç’¥)');
            }
            panelSelect.appendChild(autoOption);
            
            // Set auto-select as default selected option
            panelSelect.value = 'auto';
        }

        // Manual inverter selection functions
        function toggleInverterSelection() {
            const toggle = document.getElementById('manualInverterToggle');
            const autoSelection = document.getElementById('autoInverterSelection');
            const manualSelection = document.getElementById('manualInverterSelection');
            
            if (toggle.checked) {
                // Switch to manual mode
                autoSelection.classList.add('hidden');
                manualSelection.classList.remove('hidden');
                populateManualBrands();
                populateManualPowers();
            } else {
                // Switch to auto mode
                autoSelection.classList.remove('hidden');
                manualSelection.classList.add('hidden');
                // Reset manual selections
                document.getElementById('manualBrand').value = '';
                document.getElementById('manualPower').value = '';
                document.getElementById('manualModel').value = '';
                document.getElementById('manualInverterInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            }
        }

        // Function to refresh manual inverter options when system power changes
        function refreshManualInverterOptions() {
            const toggle = document.getElementById('manualInverterToggle');
            if (toggle.checked) {
                // Only refresh if in manual mode
                populateManualBrands();
                populateManualPowers();
                // Reset dependent selections
                document.getElementById('manualPower').value = '';
                document.getElementById('manualModel').value = '';
                document.getElementById('manualInverterInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            }
        }

        function populateManualBrands() {
            // Check if inverters are loaded
            if (!inverters || inverters.length === 0) {
                return;
            }
            
            const brandSelect = document.getElementById('manualBrand');
            brandSelect.innerHTML = '<option value="" data-en="Select brand" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¢÷Ä’•’∂’§’®">Select brand</option>';
            
            // Get system power to apply 15% rule
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            
            if (systemPower > 0) {
                // Calculate minimum power (inverter must be able to handle system power)
                const minPower = systemPower / 1.15; // Inverter must be able to handle system power
                
                // Filter brands: show all brands with inverters that can handle the system power
                const suitableBrands = [...new Set(inverters
                    .filter(inv => inv.kw >= minPower) // Inverter must be able to handle system power
                    .map(inv => inv.brand)
                )].sort();
                
                if (suitableBrands.length > 0) {
                    suitableBrands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand;
                        option.textContent = brand;
                        option.setAttribute('data-en', brand);
                        option.setAttribute('data-hy', brand);
                        brandSelect.appendChild(option);
                    });
                } else {
                    // No suitable brands found
                    const option = document.createElement('option');
                    option.value = "";
                    option.disabled = true;
                    const text = currentLanguage === 'en' 
                        ? 'No suitable brands (15% rule)'
                        : '’Ä’°÷Ä’¥’°÷Ä ’¢÷Ä’•’∂’§’∂’•÷Ä ’π’Ø’°’∂ (15% ’Ø’°’∂’∏’∂)';
                    option.textContent = text;
                    option.setAttribute('data-en', 'No suitable brands (15% rule)');
                    option.setAttribute('data-hy', '’Ä’°÷Ä’¥’°÷Ä ’¢÷Ä’•’∂’§’∂’•÷Ä ’π’Ø’°’∂ (15% ’Ø’°’∂’∏’∂)');
                    brandSelect.appendChild(option);
                }
            } else {
                // No system power entered yet - show all brands
                const brands = [...new Set(inverters.map(inv => inv.brand))].sort();
                
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    option.setAttribute('data-en', brand);
                    option.setAttribute('data-hy', brand);
                    brandSelect.appendChild(option);
                });
            }
        }

        function populateManualPowers() {
            // Check if inverters are loaded
            if (!inverters || inverters.length === 0) {
                return;
            }
            
            const powerSelect = document.getElementById('manualPower');
            powerSelect.innerHTML = '<option value="" data-en="Select power" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’∞’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®">Select power</option>';
            
            // Get system power to apply 15% rule
            const systemPower = parseFloat(document.getElementById('systemPower').value) || 0;
            
                        if (systemPower > 0) {
                // Calculate minimum power (inverter must be able to handle system power)
                const minPower = systemPower / 1.15; // Inverter must be able to handle system power
                
                // Filter inverters: show all inverters that can handle the system power
                const suitablePowers = [...new Set(inverters
                    .filter(inv => inv.kw >= minPower) // Inverter must be able to handle system power
                    .map(inv => inv.kw)
                )].sort((a, b) => a - b);
                
                if (suitablePowers.length > 0) {
                    suitablePowers.forEach(power => {
                        const option = document.createElement('option');
                        option.value = power;
                        const text = currentLanguage === 'en' 
                            ? `${power} kW`
                            : `${power} ’Ø’é’ø`;
                        option.textContent = text;
                        option.setAttribute('data-en', `${power} kW`);
                        option.setAttribute('data-hy', `${power} ’Ø’é’ø`);
                        powerSelect.appendChild(option);
                    });
                } else {
                    // No suitable inverters found
                    const option = document.createElement('option');
                    option.value = "";
                    option.disabled = true;
                    const text = currentLanguage === 'en' 
                        ? 'No suitable inverters (15% rule)'
                        : '’Ä’°÷Ä’¥’°÷Ä ’´’∂’æ’•÷Ä’ø’∏÷Ä’∂’•÷Ä ’π’Ø’°’∂ (15% ’Ø’°’∂’∏’∂)';
                    option.textContent = text;
                    option.setAttribute('data-en', 'No suitable inverters (15% rule)');
                    option.setAttribute('data-hy', '’Ä’°÷Ä’¥’°÷Ä ’´’∂’æ’•÷Ä’ø’∏÷Ä’∂’•÷Ä ’π’Ø’°’∂ (15% ’Ø’°’∂’∏’∂)');
                    powerSelect.appendChild(option);
                }
            } else {
                // No system power entered yet - show all powers
                const powers = [...new Set(inverters.map(inv => inv.kw))].sort((a, b) => a - b);
                
                powers.forEach(power => {
                    const option = document.createElement('option');
                    option.value = power;
                    const text = currentLanguage === 'en' 
                        ? `${power} kW`
                        : `${power} ’Ø’é’ø`;
                    option.textContent = text;
                        option.setAttribute('data-en', `${power} kW`);
                        option.setAttribute('data-hy', `${power} ’Ø’é’ø`);
                    powerSelect.appendChild(option);
                });
            }
        }

        function updateManualModels() {
            const brandSelect = document.getElementById('manualBrand');
            const powerSelect = document.getElementById('manualPower');
            const modelSelect = document.getElementById('manualModel');
            
            const selectedBrand = brandSelect.value;
            const selectedPower = powerSelect.value;
            
            // Reset model selection
            modelSelect.innerHTML = '<option value="" data-en="Select model" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¥’∏’§’•’¨’®">Select model</option>';
            document.getElementById('manualInverterInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            
            if (selectedBrand && selectedPower) {
                // Filter inverters by brand and power
                const availableModels = inverters.filter(inv => 
                    inv.brand === selectedBrand && inv.kw == selectedPower
                );
                
                availableModels.forEach(inverter => {
                    const option = document.createElement('option');
                    option.value = inverter.id;
                    option.textContent = inverter.model;
                    option.setAttribute('data-en', inverter.model);
                    option.setAttribute('data-hy', inverter.model);
                    modelSelect.appendChild(option);
                });
            }
        }

        function updateManualInverterInfo() {
            const modelSelect = document.getElementById('manualModel');
            const selectedModelId = modelSelect.value;
            
            if (selectedModelId) {
                const selectedInverter = inverters.find(inv => inv.id == selectedModelId);
                if (selectedInverter) {
                    const info = currentLanguage === 'en' 
                        ? `${selectedInverter.brand} ${selectedInverter.model} (${selectedInverter.kw} kW)`
                        : `${selectedInverter.brand} ${selectedInverter.model} (${selectedInverter.kw} ’Ø’é’ø)`;
                    
                    document.getElementById('manualInverterInfo').textContent = info;
                }
            } else {
                document.getElementById('manualInverterInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            }
        }

        // Panel selection functions
        function togglePanelSelection() {
            const toggle = document.getElementById('manualPanelToggle');
            const autoSelection = document.getElementById('autoPanelSelection');
            const manualSelection = document.getElementById('manualPanelSelection');
            
            if (toggle.checked) {
                // Switch to manual mode
                autoSelection.classList.add('hidden');
                manualSelection.classList.remove('hidden');
                populateManualPanelBrands();
                populateManualPanelWattages();
            } else {
                // Switch to auto mode
                autoSelection.classList.remove('hidden');
                manualSelection.classList.add('hidden');
                // Reset manual selections
                document.getElementById('manualPanelBrand').value = '';
                document.getElementById('manualPanelWattage').value = '';
                document.getElementById('manualPanelModel').value = '';
                document.getElementById('manualPanelInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            }
        }

        function populateManualPanelBrands() {
            // Check if panels are loaded
            if (!panels || panels.length === 0) {
                return;
            }
            
            const brandSelect = document.getElementById('manualPanelBrand');
            brandSelect.innerHTML = '<option value="" data-en="Select brand" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¢÷Ä’•’∂’§’®">Select brand</option>';
            
            // Get all unique brands from panels
            const brands = [...new Set(panels.map(panel => panel.brand))].sort();
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                option.setAttribute('data-en', brand);
                option.setAttribute('data-hy', brand);
                brandSelect.appendChild(option);
            });
        }

        function populateManualPanelWattages() {
            // Check if panels are loaded
            if (!panels || panels.length === 0) {
                return;
            }
            
            const wattageSelect = document.getElementById('manualPanelWattage');
            wattageSelect.innerHTML = '<option value="" data-en="Select wattage" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’∞’¶’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®">Select wattage</option>';
            
            // Get all unique wattages from panels
            const wattages = [...new Set(panels.map(panel => panel.wattage))].sort((a, b) => a - b);
            
            wattages.forEach(wattage => {
                const option = document.createElement('option');
                option.value = wattage;
                const text = currentLanguage === 'en' 
                    ? `${wattage}W`
                    : `${wattage}’é’ø`;
                option.textContent = text;
                option.setAttribute('data-en', `${wattage}W`);
                option.setAttribute('data-hy', `${wattage}’é’ø`);
                wattageSelect.appendChild(option);
            });
        }

        function updateManualPanelModels() {
            const brandSelect = document.getElementById('manualPanelBrand');
            const wattageSelect = document.getElementById('manualPanelWattage');
            const modelSelect = document.getElementById('manualPanelModel');
            
            const selectedBrand = brandSelect.value;
            const selectedWattage = wattageSelect.value;
            
            // Reset model selection
            modelSelect.innerHTML = '<option value="" data-en="Select model" data-hy="‘∏’∂’ø÷Ä’•÷Ñ ’¥’∏’§’•’¨’®">Select model</option>';
            document.getElementById('manualPanelInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            
            if (selectedBrand && selectedWattage) {
                // Filter panels by brand and wattage
                const availableModels = panels.filter(panel => 
                    panel.brand === selectedBrand && panel.wattage == selectedWattage
                );
                
                availableModels.forEach(panel => {
                    const option = document.createElement('option');
                    option.value = panel.id;
                    option.textContent = panel.model;
                    option.setAttribute('data-en', panel.model);
                    option.setAttribute('data-hy', panel.model);
                    modelSelect.appendChild(option);
                });
            }
        }

        function updateManualPanelInfo() {
            const modelSelect = document.getElementById('manualPanelModel');
            const selectedModelId = modelSelect.value;
            
            if (selectedModelId) {
                const selectedPanel = panels.find(panel => panel.id == selectedModelId);
                if (selectedPanel) {
                    const info = currentLanguage === 'en' 
                        ? `${selectedPanel.brand} ${selectedPanel.model} (${selectedPanel.wattage}W, ${selectedPanel.efficiency}% efficiency)`
                        : `${selectedPanel.brand} ${selectedPanel.model} (${selectedPanel.wattage}’é’ø, ${selectedPanel.efficiency}% ’°÷Ä’§’µ’∏÷Ç’∂’°’æ’•’ø’∏÷Ç’©’µ’∏÷Ç’∂)`;
                    
                    document.getElementById('manualPanelInfo').textContent = info;
                }
            } else {
                document.getElementById('manualPanelInfo').textContent = currentLanguage === 'en' ? 'None selected' : '’à’π’´’∂’π ’®’∂’ø÷Ä’æ’°’Æ ’π’ß';
            }
        }

        // Set default values
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('systemPower').value = '10.44';
            
            // Populate inverter dropdown
            populateInverterDropdown();
            
            // Add event listeners for filters
            document.getElementById('bankFilter').addEventListener('change', applyFilters);
            document.getElementById('periodFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applySorting);
            
            // Add event listener for system power to update inverter and panel dropdowns
            document.getElementById('systemPower').addEventListener('input', function() {
                // Add a small delay to prevent rapid firing during typing
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    // Only update if data is loaded
                    if (isDataLoaded && inverters && inverters.length > 0) {
                        populateInverterDropdown();
                        refreshManualInverterOptions();
                    }
                    if (isDataLoaded && panels && panels.length > 0) {
                        populatePanelDropdown();
                    }
                }, 300);
            });
            
            // Add event listener for warranty years to recalculate when changed
            document.getElementById('warrantyYears').addEventListener('change', function() {
                // Update the profit per kW display immediately
                updateProfitPerKwDisplay();
                
                // Recalculate if there are existing loan options
                if (allLoanOptions.length > 0) {
                    calculateLoan();
                }
            });
            
            // Load saved language preference
            const savedLanguage = localStorage.getItem('loanCalculatorLanguage');
            if (savedLanguage) {
                switchLanguage(savedLanguage);
            }
            
            // Ensure Armenian button is always hidden
            const langHyButton = document.getElementById('langHy');
            if (langHyButton) {
                langHyButton.style.display = 'none';
                langHyButton.style.visibility = 'hidden';
            }
            
            // Initialize profit per kW display (hidden by default for non-admin users)
            hideProfitPerKwDisplay();
            
            // Load system data (banks, inverters, etc.) from database
            fetchSystemCostSettings().then(() => {
                // Data loaded successfully
            }).catch(error => {
                // Handle error silently
            });
        });
        
        // Function to update the profit per kW display based on selected warranty years
        function updateProfitPerKwDisplay() {
            // Only update if admin is logged in AND profit display exists
            if (!isAdminLoggedIn) {
                return;
            }
            
            const profitDisplay = document.getElementById('currentProfitPerKw');
            if (!profitDisplay) {
                return;
            }
            
            const warrantyYears = parseInt(document.getElementById('warrantyYears').value) || 12;
            
            // Map warranty years to database keys
            let dbKey;
            if (warrantyYears === 2) dbKey = 'profit_per_kw_2Y';
            else if (warrantyYears === 3) dbKey = 'profit_per_kw_3Y';
            else if (warrantyYears === 6) dbKey = 'profit_per_kw_6Y';
            else if (warrantyYears === 12) dbKey = 'profit_per_kw_12Y';
            else dbKey = 'profit_per_kw_12Y'; // Default to 12Y
            
            // Get profit from database only - no hardcoded fallbacks
            const profitPerKw = dbProfitMargins[dbKey];
            
            if (!profitPerKw) {
                profitDisplay.textContent = 'Database Error';
                return;
            }
            
            profitDisplay.textContent = profitPerKw.toLocaleString() + ' AMD';
        }

        function populateFilters() {
            const bankFilter = document.getElementById('bankFilter');
            const periodFilter = document.getElementById('periodFilter');
            
            // Get unique banks and periods
            const banks = [...new Set(allLoanOptions.map(option => option.bankName))];
            const periods = [...new Set(allLoanOptions.map(option => option.loanPeriod))].sort((a, b) => a - b);
            
            // Clear existing options (except first)
            bankFilter.innerHTML = '<option value="">All Banks</option>';
            periodFilter.innerHTML = '<option value="">All Periods</option>';
            
            // Add bank options
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankFilter.appendChild(option);
            });
            
            // Add period options
            periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                const monthsText = currentLanguage === 'en' ? 'months' : '’°’¥’´’Ω';
                option.textContent = `${period} ${monthsText}`;
                periodFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const bankFilter = document.getElementById('bankFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            
            let filteredOptions = allLoanOptions.filter(option => {
                const bankMatch = !bankFilter || option.bankName === bankFilter;
                const periodMatch = !periodFilter || option.loanPeriod === parseInt(periodFilter);
                return bankMatch && periodMatch;
            });
            
            // Apply current sorting
            if (currentSortField) {
                filteredOptions = sortOptions(filteredOptions, currentSortField, currentSortDirection);
            }
            
            displayLoanOptions(filteredOptions);
            updateResultCount(filteredOptions.length);
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            if (!sortBy) return;
            
            const [field, direction] = sortBy.includes('Desc') 
                ? [sortBy.replace('Desc', ''), 'desc'] 
                : [sortBy, 'asc'];
            
            currentSortField = field;
            currentSortDirection = direction;
            
            // Get current filtered options
            const bankFilter = document.getElementById('bankFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            
            let filteredOptions = allLoanOptions.filter(option => {
                const bankMatch = !bankFilter || option.bankName === bankFilter;
                const periodMatch = !periodFilter || option.loanPeriod === parseInt(periodFilter);
                return bankMatch && periodMatch;
            });
            
            filteredOptions = sortOptions(filteredOptions, field, direction);
            displayLoanOptions(filteredOptions);
        }

        function sortOptions(options, field, direction) {
            return options.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle string comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }

        function sortTable(field) {
            // Toggle direction if same field
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // Get current filtered options
            const bankFilter = document.getElementById('bankFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            
            let filteredOptions = allLoanOptions.filter(option => {
                const bankMatch = !bankFilter || option.bankName === bankFilter;
                const periodMatch = !periodFilter || option.loanPeriod === parseInt(periodFilter);
                return bankMatch && periodMatch;
            });
            
            filteredOptions = sortOptions(filteredOptions, field, currentSortDirection);
            displayLoanOptions(filteredOptions);
            updateSortIcons(field, currentSortDirection);
        }

        function updateSortIcons(field, direction) {
            // Reset all icons
            const icons = ['bankSortIcon', 'periodSortIcon', 'rateSortIcon', 'commissionSortIcon',
                          'amountSortIcon', 'paymentSortIcon', 'interestSortIcon', 'totalSortIcon'];
            icons.forEach(id => {
                document.getElementById(id).textContent = '‚Üï';
            });
            
            // Set active icon
            const iconMap = {
                'bankName': 'bankSortIcon',
                'loanPeriod': 'periodSortIcon',
                'interestRate': 'rateSortIcon',
                'commission': 'commissionSortIcon',
                'loanAmount': 'amountSortIcon',
                'monthlyPayment': 'paymentSortIcon',
                'totalInterest': 'interestSortIcon',
                'totalAmount': 'totalSortIcon'
            };
            
            const activeIcon = document.getElementById(iconMap[field]);
            if (activeIcon) {
                activeIcon.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
            }
        }

        function clearFilters() {
            document.getElementById('bankFilter').value = '';
            document.getElementById('periodFilter').value = '';
            document.getElementById('sortBy').value = 'monthlyPayment';
            
            currentSortField = 'monthlyPayment';
            currentSortDirection = 'asc';
            
            // Reset sort icons
            updateSortIcons('monthlyPayment', 'asc');
            
            // Display all options sorted by monthly payment
            const sortedOptions = sortOptions([...allLoanOptions], 'monthlyPayment', 'asc');
            displayLoanOptions(sortedOptions);
            updateResultCount(sortedOptions.length);
        }

        function updateResultCount(count) {
            const totalCount = allLoanOptions.length;
            const resultCount = document.getElementById('resultCount');
            
            if (currentLanguage === 'en') {
                resultCount.textContent = count === totalCount 
                    ? `Showing all ${totalCount} results` 
                    : `Showing ${count} of ${totalCount} results`;
            } else {
                resultCount.textContent = count === totalCount 
                    ? `’ë’∏÷Ç÷Å’°’§÷Ä’æ’∏÷Ç’¥ ’•’∂ ’¢’∏’¨’∏÷Ä ${totalCount} ’°÷Ä’§’µ’∏÷Ç’∂÷Ñ’∂’•÷Ä’®` 
                    : `’ë’∏÷Ç÷Å’°’§÷Ä’æ’∏÷Ç’¥ ’•’∂ ${count} ${totalCount}-’´÷Å`;
            }
        }

        function displayLoanOptions(options) {
            const tableBody = document.getElementById('loanTableBody');
            tableBody.innerHTML = '';

            options.forEach(option => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const monthsText = currentLanguage === 'en' ? 'months' : '’°’¥’´’Ω';
                
                // Create commission cell conditionally
                const commissionCell = isAdminLoggedIn 
                    ? `<td class="border p-3 text-center w-24 text-orange-600 font-medium">${(option.commission * 100).toFixed(1)}%</td>`
                    : '';
                
                row.innerHTML = `
                    <td class="border p-3 font-medium">${option.bankName}</td>
                    <td class="border p-3 text-center w-32">${option.loanPeriod} ${monthsText}</td>
                    <td class="border p-3 text-center w-24">${(option.interestRate * 100).toFixed(1)}%</td>
                    ${commissionCell}
                    <td class="border p-3 text-center font-semibold text-green-600 w-40">${option.loanAmount.toLocaleString()}</td>
                    <td class="border p-3 text-center font-semibold text-blue-600 w-36">${option.monthlyPayment.toLocaleString()}</td>
                    <td class="border p-3 text-center font-semibold text-red-600 w-40">${Math.abs(option.totalInterest).toLocaleString()}</td>
                    <td class="border p-3 text-center font-semibold text-purple-600 w-44">${option.totalAmount.toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Admin functionality
        let isAdminLoggedIn = false;
        const ADMIN_PASSWORD = CONFIG.ADMIN_PASSWORD;

        function showAdminLogin() {
            document.getElementById('adminModal').classList.remove('hidden');
            document.getElementById('adminPassword').focus();
        }

        function hideAdminLogin() {
            document.getElementById('adminModal').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
        }

                 function loginAdmin() {
             const password = document.getElementById('adminPassword').value;
             if (password === ADMIN_PASSWORD) {
                 isAdminLoggedIn = true;
                 hideAdminLogin();
                 showAdminPanel();
                 showAdminDetails();
                 updateAdminButton();
                 showCommissionColumn();
                 showProfitPerKwDisplay();
                 // Recalculate to show detailed breakdown
                 if (allLoanOptions.length > 0) {
                     calculateLoan();
                 }
             } else {
                 alert('Incorrect password');
             }
         }

                 function logoutAdmin() {
             isAdminLoggedIn = false;
             hideAdminDetails();
             updateAdminButton();
             hideCommissionColumn();
             hideProfitPerKwDisplay();
             // Recalculate to hide detailed breakdown
             if (allLoanOptions.length > 0) {
                 calculateLoan();
             }
         }

        function showCommissionColumn() {
            // Show commission header
            const commissionHeader = document.querySelector('.admin-only');
            if (commissionHeader) {
                commissionHeader.style.display = 'table-cell';
            }
        }

                 function hideCommissionColumn() {
             // Hide commission header
             const commissionHeader = document.querySelector('.admin-only');
             if (commissionHeader) {
                 commissionHeader.style.display = 'none';
             }
         }
         
         function showProfitPerKwDisplay() {
             // Create and show profit per kW display
             const container = document.getElementById('profitPerKwDisplayContainer');
             if (container) {
                 container.innerHTML = `
                     <div id="profitPerKwDisplay" class="mt-2 text-sm text-gray-600">
                         <span data-en="Current Profit per kW:" data-hy="‘∏’∂’©’°÷Å’´’Ø ’∑’°’∞’∏÷Ç’µ’© ’Ø’é’ø-’´ ’∞’°’¥’°÷Ä:">Current Profit per kW:</span>
                         <span id="currentProfitPerKw" class="font-semibold text-tiamat-blue ml-1">30,000 AMD</span>
                </div>
            `;
                 // Update the display with current warranty value
                 updateProfitPerKwDisplay();
             }
         }
         
         function hideProfitPerKwDisplay() {
             // Remove profit per kW display completely
             const container = document.getElementById('profitPerKwDisplayContainer');
             if (container) {
                 container.innerHTML = '';
             }
         }

        // Spoiler functionality
        function toggleSpoiler(element) {
            if (element.classList.contains('spoiler')) {
                // Show the actual value
                element.textContent = element.getAttribute('data-value');
                element.classList.remove('spoiler');
                element.classList.add('spoiler-revealed');
            } else {
                // Hide the value
                element.textContent = '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà';
                element.classList.add('spoiler');
                element.classList.remove('spoiler-revealed');
            }
        }

        // Handle Enter key in admin password field
        function handleAdminPasswordKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginAdmin();
            }
        }

        function showAdminDetails() {
            document.getElementById('adminDetails').classList.remove('hidden');
        }

        function hideAdminDetails() {
            document.getElementById('adminDetails').classList.add('hidden');
        }

        function updateAdminButton() {
            const adminBtn = document.getElementById('adminLoginBtn');
            if (isAdminLoggedIn) {
                adminBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                adminBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                adminBtn.innerHTML = '<span data-en="Admin ‚úì" data-hy="‘±’§’¥’´’∂ ‚úì">Admin ‚úì</span>';
            } else {
                adminBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                adminBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                adminBtn.innerHTML = '<span data-en="Admin" data-hy="‘±’§’¥’´’∂">Admin</span>';
            }
        }

        // New admin panel functions
        function showAdminPanel() {
            if (!isAdminLoggedIn) return;
            
            // Show the admin panel on the main page
            const adminPanelMain = document.getElementById('adminPanelMain');
            if (adminPanelMain) {
                adminPanelMain.classList.remove('hidden');
                
                // Update the last updated timestamp
                const lastUpdatedElement = document.getElementById('adminLastUpdated');
                if (lastUpdatedElement) {
                    lastUpdatedElement.textContent = new Date().toLocaleString();
                }
                
                // Scroll to the admin panel
                adminPanelMain.scrollIntoView({ behavior: 'smooth' });
            }
        }

                 function logoutAdmin() {
             isAdminLoggedIn = false;
             const adminPanelMain = document.getElementById('adminPanelMain');
             if (adminPanelMain) {
                 adminPanelMain.classList.add('hidden');
             }
             // Reset admin state
             hideAdminDetails();
             updateAdminButton();
             hideCommissionColumn();
             hideProfitPerKwDisplay();
         }

        function refreshAdminData() {
            if (!isAdminLoggedIn) return;
            
            // Update the last updated timestamp
            const lastUpdatedElement = document.getElementById('adminLastUpdated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = new Date().toLocaleString();
            }

        }

        // Add admin details section to the page
        function addAdminSection() {
            const adminSection = `
                <div id="adminDetails" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-tiamat-blue" data-en="Admin: Calculation Details" data-hy="‘±’§’¥’´’∂: ’Ä’°’∑’æ’°÷Ä’Ø’´ ’¥’°’∂÷Ä’°’¥’°’Ω’∂’•÷Ä’®">Admin: Calculation Details</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Base Prices -->
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-800" data-en="Base Prices (per kW, without inverter)" data-hy="‘≤’°’¶’°’µ’´’∂ ’£’∂’•÷Ä’® (’Ø’é’ø-’´ ’∞’°’¥’°÷Ä, ’°’º’°’∂÷Å ’´’∂’æ’•÷Ä’ø’∏÷Ä’´)">Base Prices (per kW, without inverter)</h3>
                            <div class="bg-gray-50 p-4 rounded-md space-y-2">
                                <div class="flex justify-between">
                                    <span data-en="Aluminium Construction on Roof" data-hy="‘±’¨’µ’∏÷Ç’¥’´’∂’• ’Ø’∏’∂’Ω’ø÷Ä’∏÷Ç’Ø÷Å’´’° ’ø’°’∂’´÷Ñ’´ ’æ÷Ä’°">Aluminium Construction on Roof:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="130,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                    </div>
                                <div class="flex justify-between">
                                    <span data-en="Metal Construction on Roof" data-hy="’Ñ’•’ø’°’≤’°’Ø’°’∂ ’Ø’∏’∂’Ω’ø÷Ä’∏÷Ç’Ø÷Å’´’° ’ø’°’∂’´÷Ñ’´ ’æ÷Ä’°">Metal Construction on Roof:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="115,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="On Roof (Sloped)" data-hy="’è’°’∂’´÷Ñ’´ ’æ÷Ä’° (’¨’°’∂’ª’°’µ’´’∂)">On Roof (Sloped):</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="105,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                        </div>
                                <div class="flex justify-between">
                                    <span data-en="System on Ground" data-hy="’Ä’°’¥’°’Ø’°÷Ä’£ ’£’•’ø’∂’´ ’æ÷Ä’°">System on Ground:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="117,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                </div>
                            </div>
                        </div>

                        <!-- Profit by Warranty -->
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-800" data-en="Profit per kW by Warranty" data-hy="’á’°’∞’∏÷Ç’µ’© ’Ø’é’ø-’´ ’∞’°’¥’°÷Ä ’®’Ω’ø ’•÷Ä’°’∑’≠’´÷Ñ’´">Profit per kW by Warranty</h3>
                            <div class="bg-gray-50 p-4 rounded-md space-y-2">
                                <div class="flex justify-between">
                                    <span data-en="2 Years" data-hy="2 ’è’°÷Ä’´">2 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="15,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="3 Years" data-hy="3 ’è’°÷Ä’´">3 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="20,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="6 Years" data-hy="6 ’è’°÷Ä’´">6 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="25,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                </div>
                                <div class="flex justify-between">
                                    <span data-en="12 Years" data-hy="12 ’è’°÷Ä’´">12 Years:</span>
                                    <span class="font-mono spoiler" onclick="toggleSpoiler(this)" data-value="30,000 AMD">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Commission Rates -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-800 mb-4" data-en="Bank Commission Rates" data-hy="‘≤’°’∂’Ø’´ ’Ø’∏’¥’´’Ω’´’∏’∂ ’æ’≥’°÷Ä’∂’•÷Ä">Bank Commission Rates</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- ArmEconomBank -->
                        <div>
                                <h4 class="font-medium text-gray-700 mb-2">ArmEconomBank</h4>
                                <div class="bg-gray-50 p-4 rounded-md text-sm space-y-1">
                                    <div class="grid grid-cols-3 gap-2 text-xs font-medium text-gray-600">
                                        <span>Period</span>
                                        <span>Interest</span>
                                        <span>Commission</span>
                                </div>
                                    <div class="space-y-1">
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>0%</span><span>21%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>0%</span><span>32%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>0%</span><span>41%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>3%</span><span>18%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>3%</span><span>27%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>3%</span><span>34%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>5%</span><span>16%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>5%</span><span>23%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>5%</span><span>30%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>9%</span><span>10%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>9%</span><span>15%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>9%</span><span>19%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>12%</span><span>6%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>12%</span><span>9%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>12%</span><span>11%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>36m</span><span>15%</span><span>2%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>60m</span><span>15%</span><span>3%</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>84m</span><span>15%</span><span>4%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ACBA Bank -->
                                <div>
                                <h4 class="font-medium text-gray-700 mb-2">ACBA Bank</h4>
                                <div class="bg-gray-50 p-4 rounded-md text-sm space-y-1">
                                    <div class="grid grid-cols-3 gap-2 text-xs font-medium text-gray-600">
                                        <span>Period</span>
                                        <span>Interest</span>
                                        <span>Commission</span>
                                </div>
                                    <div class="space-y-1">
                                        <div class="grid grid-cols-3 gap-2">
                                            <span>96m</span><span>11%</span><span>4%</span>
                            </div>
                        </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    </div>
                </div>
            `;
            
            // Insert admin section after the loan table
            const loanTable = document.getElementById('loanTable');
            loanTable.insertAdjacentHTML('afterend', adminSection);
        }

        // Initialize admin section and fetch database values on page load
        document.addEventListener('DOMContentLoaded', function() {
            addAdminSection();
            
            // Fetch system cost settings from database
            fetchSystemCostSettings().then(() => {

            }).catch(error => {

            });
        });

        // Keyboard shortcut for admin login (A+S+D+Space+Enter+Enter)
        let keySequence = [];
        let lastKeyTime = 0;
        
        document.addEventListener('keydown', function(event) {
            const currentTime = Date.now();
            
            // Reset sequence if too much time has passed (2 seconds)
            if (currentTime - lastKeyTime > 2000) {
                keySequence = [];
            }
            
            lastKeyTime = currentTime;
            
            // Track all key presses
            let keyPressed = '';
            
            if (event.code === 'KeyA') {
                keyPressed = 'A';
            } else if (event.code === 'KeyS') {
                keyPressed = 'S';
            } else if (event.code === 'KeyD') {
                keyPressed = 'D';
            } else if (event.key === ' ') {
                keyPressed = 'Space';
            } else if (event.code === 'Enter') {
                keyPressed = 'Enter';
            }
            
            if (keyPressed) {
                keySequence.push(keyPressed);
                
                // Keep only last 6 keys
                if (keySequence.length > 6) {
                    keySequence.shift();
                }
                
                // Debug: log the sequence

                // Check if sequence matches admin shortcut: A+S+D+Space+Enter+Enter
                if (keySequence.length === 6 && 
                    keySequence[0] === 'A' && 
                    keySequence[1] === 'S' && 
                    keySequence[2] === 'D' && 
                    keySequence[3] === 'Space' && 
                    keySequence[4] === 'Enter' && 
                    keySequence[5] === 'Enter') {
                    
                    // Prevent default behavior
                    event.preventDefault();
                    
                    // Show admin login
                    showAdminLogin();
                    
                    // Reset sequence
                    keySequence = [];
        
                }
            }
        });
    </script>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold mb-4" data-en="Admin Login" data-hy="‘±’§’¥’´’∂ ’¥’∏÷Ç’ø÷Ñ">Admin Login</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-en="Password" data-hy="‘≥’°’≤’ø’∂’°’¢’°’º">Password</label>
                        <input type="password" id="adminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tiamat-blue" onkeydown="handleAdminPasswordKeydown(event)">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loginAdmin()" class="flex-1 bg-tiamat-blue text-white px-4 py-2 rounded-md hover:bg-tiamat-dark-blue">
                            <span data-en="Login" data-hy="’Ñ’∏÷Ç’ø÷Ñ">Login</span>
                        </button>
                        <button onclick="hideAdminLogin()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                            <span data-en="Cancel" data-hy="’â’•’≤’°÷Ä’Ø’•’¨">Cancel</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 